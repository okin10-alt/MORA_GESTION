
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FORMA ‚Äî Sistema de Gesti√≥n</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --ink:#1c1c1a;--ink2:#4c4c49;--ink3:#8a8a86;--ink4:#d0d0cc;
  --paper:#f4f4f1;--surface:#fff;--surface2:#f2f2ef;
  --border:#e6e6e2;--border2:#d4d4cf;
  --accent:#2952d9;--accent-lt:#eef1fd;--accent-dk:#1a38a8;
  --green:#1a7a4a;--green-lt:#e8f5ee;
  --amber:#b55800;--amber-lt:#fdf0e4;
  --red:#c0281e;--red-lt:#fdecea;
  --purple:#6d3cbf;--purple-lt:#f1ecfb;
  --teal:#0e7490;--teal-lt:#e0f7fa;
  --r:7px;--r-lg:12px;
  --sh:0 1px 3px rgba(0,0,0,.06),0 4px 12px rgba(0,0,0,.04);
  --sh-lg:0 4px 24px rgba(0,0,0,.09),0 16px 48px rgba(0,0,0,.07);
  --sidebar:230px;
}
html{font-size:14px;-webkit-font-smoothing:antialiased}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--paper);color:var(--ink);height:100vh;overflow:hidden}
button{font-family:inherit;cursor:pointer;border:none;background:none}
input,textarea,select{font-family:inherit;font-size:inherit;color:var(--ink)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--ink4);border-radius:5px}
@media print{
  *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}
  .sidebar,.topbar,#topbar-actions,.modal-hd,.modal-ft,.btn,button,
  .modal-close,#m-vista-cliente .modal-hd{display:none!important}
  .overlay{position:fixed!important;inset:0!important;background:#fff!important;
    backdrop-filter:none!important;display:flex!important;padding:0!important;z-index:9999!important}
  .modal{box-shadow:none!important;max-width:100%!important;width:100%!important;
    max-height:none!important;height:auto!important;border:none!important;border-radius:0!important}
  .modal-bd{padding:0!important;overflow:visible!important;max-height:none!important}
  body,html{height:auto!important;overflow:visible!important;background:#fff!important}
  @page{size:A4 portrait;margin:12mm 14mm 16mm}
  .print-page-break{page-break-after:always}
}

/* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
#auth-screen{position:fixed;inset:0;background:var(--ink);display:flex;align-items:center;
  justify-content:center;z-index:999;flex-direction:column;gap:0}
#auth-screen.hidden{display:none}
.auth-box{background:var(--surface);border-radius:var(--r-lg);width:100%;max-width:400px;
  padding:36px;box-shadow:var(--sh-lg)}
.auth-logo{text-align:center;margin-bottom:28px}
.auth-logo-mark{width:48px;height:48px;background:var(--accent);font-family:'DM Serif Display',serif;
  font-size:24px;color:#fff;border-radius:8px;display:flex;align-items:center;justify-content:center;margin:0 auto 10px}
.auth-logo-name{font-family:'DM Serif Display',serif;font-size:26px;color:var(--ink)}
.auth-logo-tag{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);margin-top:2px}
.auth-tab{display:flex;border-bottom:2px solid var(--border);margin-bottom:22px}
.auth-tab-btn{flex:1;padding:10px;font-size:12px;font-weight:700;color:var(--ink3);
  cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;text-align:center;transition:.15s}
.auth-tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
.auth-field{margin-bottom:14px}
.auth-field label{display:block;font-size:10px;font-weight:700;text-transform:uppercase;
  letter-spacing:.8px;color:var(--ink3);margin-bottom:5px}
.auth-field input,.auth-field select{width:100%;border:1px solid var(--border);border-radius:var(--r);
  padding:10px 12px;font-size:13px;transition:.2s}
.auth-field input:focus,.auth-field select:focus{outline:none;border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(41,82,217,.1)}
.auth-btn{width:100%;padding:11px;background:var(--ink);color:#fff;border-radius:var(--r);
  font-size:13px;font-weight:700;cursor:pointer;border:none;margin-top:6px;transition:.15s}
.auth-btn:hover{background:#333}
.auth-msg{font-size:12px;text-align:center;margin-top:12px;padding:8px;border-radius:var(--r)}
.auth-msg.ok{background:var(--green-lt);color:var(--green)}
.auth-msg.err{background:var(--red-lt);color:var(--red)}

/* ‚îÄ‚îÄ ADMIN USUARIOS ‚îÄ‚îÄ */
.usr-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);
  padding:16px 20px;display:flex;align-items:center;gap:16px;margin-bottom:10px}
.usr-avatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:14px;font-weight:800;color:#fff;flex-shrink:0}
.usr-info{flex:1}
.usr-name{font-size:13px;font-weight:700;color:var(--ink)}
.usr-meta{font-size:11px;color:var(--ink3);margin-top:2px}
.mod-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
.mod-toggle{padding:8px 10px;border:1px solid var(--border);border-radius:var(--r);
  font-size:11px;font-weight:600;cursor:pointer;text-align:center;transition:.15s;user-select:none}
.mod-toggle.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.mod-toggle.off{background:var(--surface2);color:var(--ink3)}
.app{display:flex;height:100vh;overflow:hidden}
/* SIDEBAR */
.sidebar{width:var(--sidebar);flex-shrink:0;background:var(--ink);display:flex;flex-direction:column;overflow-y:auto}
.sb-logo{padding:22px 18px 16px;border-bottom:1px solid rgba(255,255,255,.07)}
.logo-mark{width:30px;height:30px;background:var(--accent);font-family:'DM Serif Display',serif;font-size:15px;color:#fff;border-radius:5px;display:flex;align-items:center;justify-content:center;margin-bottom:8px}
.logo-name{font-family:'DM Serif Display',serif;font-size:19px;color:#fff;line-height:1}
.logo-tag{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.3);margin-top:2px}
.sb-nav{padding:10px 0;flex:1}
.sb-section{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.25);padding:14px 18px 4px}
.sb-item{display:flex;align-items:center;gap:10px;padding:10px 18px;font-size:12.5px;color:rgba(255,255,255,.55);cursor:pointer;transition:.15s;border-left:3px solid transparent}
.sb-item:hover{background:rgba(255,255,255,.07);color:rgba(255,255,255,.85)}
.sb-item.active{background:rgba(255,255,255,.1);color:#fff;border-left-color:var(--accent)}
.sb-item i{width:16px;text-align:center;font-size:12px}
.sb-badge{margin-left:auto;background:var(--red);color:#fff;font-size:9px;font-weight:700;padding:2px 6px;border-radius:10px}
.sb-user{padding:14px 18px;border-top:1px solid rgba(255,255,255,.07);display:flex;align-items:center;gap:10px}
.sb-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0}
.sb-uname{font-size:12px;color:rgba(255,255,255,.8);font-weight:500}
.sb-urole{font-size:10px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.8px}
/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:60px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;flex-shrink:0;gap:16px}
.topbar-left{display:flex;align-items:center;gap:20px}
.topbar-title{font-size:13px;font-weight:700;color:var(--ink)}
.sw{position:relative}
.sw input{width:220px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:7px 12px 7px 32px;font-size:12.5px;transition:.2s}
.sw input:focus{outline:none;border-color:var(--accent);width:270px}
.si{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--ink4);font-size:11px}
.content{flex:1;overflow-y:auto;padding:24px}
/* BOTONES */
.btn{display:inline-flex;align-items:center;gap:7px;padding:8px 15px;border-radius:var(--r);font-size:12px;font-weight:600;cursor:pointer;transition:.15s;border:none}
.btn-primary{background:var(--ink);color:#fff}.btn-primary:hover{background:#333}
.btn-secondary{background:var(--surface2);color:var(--ink2);border:1px solid var(--border)}.btn-secondary:hover{background:var(--border)}
.btn-accent{background:var(--accent);color:#fff}.btn-accent:hover{background:var(--accent-dk)}
.btn-green{background:var(--green-lt);color:var(--green)}.btn-green:hover{background:var(--green);color:#fff}
.btn-danger{background:var(--red-lt);color:var(--red)}.btn-danger:hover{background:var(--red);color:#fff}
.btn-amber{background:var(--amber-lt);color:var(--amber)}.btn-amber:hover{background:var(--amber);color:#fff}
.btn-sm{padding:5px 10px;font-size:11px}
/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-bottom:22px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:18px 20px;position:relative}
.stat-label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--ink3);font-weight:600;margin-bottom:6px}
.stat-value{font-size:26px;font-weight:700;color:var(--ink);line-height:1}
.stat-sub{font-size:11px;color:var(--ink3);margin-top:4px}
.stat-icon{position:absolute;top:16px;right:16px;width:32px;height:32px;border-radius:var(--r);display:flex;align-items:center;justify-content:center;font-size:13px}
/* CARDS */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:14px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:18px;cursor:pointer;transition:.15s}
.card:hover{box-shadow:var(--sh-lg);transform:translateY(-1px)}
.card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;gap:8px}
.card-name{font-size:15px;font-weight:700;margin-bottom:2px;color:var(--ink)}
.card-sub{font-size:11px;color:var(--ink3);font-weight:500}
.card-info{display:flex;flex-direction:column;gap:5px;margin:10px 0}
.card-row{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--ink2)}
.card-row i{width:13px;text-align:center;color:var(--ink4);font-size:11px}
.card-foot{display:flex;align-items:center;justify-content:space-between;padding-top:10px;border-top:1px solid var(--border);margin-top:10px;gap:8px}
/* BADGES */
.badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;letter-spacing:.4px;text-transform:uppercase;padding:3px 8px;border-radius:5px;white-space:nowrap}
.b-gray{background:var(--surface2);color:var(--ink3);border:1px solid var(--border)}
.b-blue{background:var(--accent-lt);color:var(--accent)}
.b-green{background:var(--green-lt);color:var(--green)}
.b-amber{background:var(--amber-lt);color:var(--amber)}
.b-red{background:var(--red-lt);color:var(--red)}
.b-purple{background:var(--purple-lt);color:var(--purple)}
.b-teal{background:var(--teal-lt);color:var(--teal)}
/* TABLA */
.tbl-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);overflow:hidden}
table{width:100%;border-collapse:collapse}
thead th{background:var(--surface2);padding:10px 14px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--ink3);text-align:left;border-bottom:1px solid var(--border)}
tbody td{padding:11px 14px;font-size:13px;border-bottom:1px solid var(--border);color:var(--ink2)}
tbody tr:last-child td{border-bottom:none}
tbody tr:hover td{background:var(--surface2)}
tbody tr{cursor:pointer}
/* PIPELINE */
.pipeline{display:flex;gap:12px;overflow-x:auto;padding-bottom:12px}
.p-col{flex:0 0 210px;background:var(--surface2);border-radius:var(--r-lg);padding:12px;display:flex;flex-direction:column;gap:8px}
.p-head{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ink2);padding-bottom:8px;border-bottom:2px solid var(--border2);display:flex;justify-content:space-between;align-items:center}
.p-count{background:var(--border2);color:var(--ink3);font-size:10px;padding:2px 7px;border-radius:10px}
.p-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:11px;cursor:pointer;transition:.15s}
.p-card:hover{box-shadow:var(--sh);border-color:var(--border2)}
.p-cname{font-size:12.5px;font-weight:600;color:var(--ink);margin-bottom:3px}
.p-cmeta{font-size:11px;color:var(--ink3);margin-top:2px}
/* TIMELINE */
.tl{display:flex;flex-direction:column}
.tl-item{display:flex;gap:12px;padding:10px 0;position:relative}
.tl-item:not(:last-child)::before{content:'';position:absolute;left:14px;top:34px;bottom:-4px;width:2px;background:var(--border)}
.tl-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;z-index:1;border:2px solid var(--surface)}
.tl-body{flex:1;padding-top:2px}
.tl-title{font-size:13px;font-weight:600;color:var(--ink)}
.tl-meta{font-size:11px;color:var(--ink3);margin-top:1px}
.tl-note{font-size:12px;color:var(--ink2);margin-top:6px;padding:8px 10px;background:var(--surface2);border-radius:var(--r);border-left:3px solid var(--border2)}
/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(28,28,26,.55);z-index:200;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(3px)}
.overlay.open{display:flex}
.modal{background:var(--surface);border-radius:var(--r-lg);width:100%;max-width:640px;max-height:92vh;display:flex;flex-direction:column;box-shadow:var(--sh-lg)}
.modal-lg{max-width:820px}
.modal-xl{max-width:1100px}
.modal-hd{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.modal-title{font-size:14px;font-weight:700;color:var(--ink)}
.modal-close{width:28px;height:28px;border-radius:var(--r);background:var(--surface2);color:var(--ink3);display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;transition:.15s}
.modal-close:hover{background:var(--border)}
.modal-bd{padding:22px;overflow-y:auto;flex:1}
.modal-ft{padding:14px 22px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;gap:10px}
/* FORM */
.fg{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.fc{grid-column:1/-1}
.field label{display:block;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--ink3);margin-bottom:4px}
.field input,.field select,.field textarea{width:100%;border:1px solid var(--border);border-radius:var(--r);padding:8px 11px;font-size:13px;background:var(--surface);transition:.15s}
.field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(41,82,217,.1)}
.field textarea{resize:vertical;min-height:72px}
.sec-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--ink3);margin:18px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
/* DETAIL TABS */
.dtabs{display:flex;border-bottom:1px solid var(--border);padding:0 18px;background:var(--surface)}
.dtab{padding:11px 14px;font-size:12px;font-weight:600;color:var(--ink3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:.15s}
.dtab.active{color:var(--accent);border-bottom-color:var(--accent)}
/* FLOW */
.flow{display:flex;align-items:center;overflow-x:auto;padding:4px 0}
.f-dot{width:26px;height:26px;border-radius:50%;border:2px solid var(--border2);background:var(--surface);display:flex;align-items:center;justify-content:center;font-size:9px;color:var(--ink3);flex-shrink:0}
.f-dot.done{background:var(--green);border-color:var(--green);color:#fff}
.f-dot.cur{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 0 0 3px var(--accent-lt)}
.f-line{width:28px;height:2px;background:var(--border);flex-shrink:0}
.f-line.done{background:var(--green)}
/* TX BOX */
.tx-box{background:var(--ink);border-radius:var(--r-lg);padding:16px;margin-top:14px}
.tx-box label{color:rgba(255,255,255,.45);font-size:10px;text-transform:uppercase;letter-spacing:1.5px;font-weight:700;display:block;margin-bottom:7px}
.tx-box select{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.15);border-radius:var(--r);padding:9px 11px;font-size:13px;width:100%}
.tx-box select option{background:var(--ink)}
.tx-note{font-size:10.5px;color:rgba(255,255,255,.3);margin-top:7px;font-style:italic}
/* MISC */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:50px 20px;color:var(--ink4);text-align:center;gap:12px}
.empty i{font-size:32px;opacity:.3}
.empty p{font-size:13px;color:var(--ink3)}
.chip-file{display:inline-flex;align-items:center;gap:5px;padding:4px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);font-size:11px}

/* ‚ïê‚ïê PRESUPUESTO ‚ïê‚ïê */
.ppto-table{width:100%;border-collapse:collapse;font-size:12px}
.ppto-table th{background:var(--ink);color:rgba(255,255,255,.7);padding:8px 10px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;text-align:left;white-space:nowrap}
.ppto-table td{padding:7px 8px;border-bottom:1px solid var(--border);vertical-align:middle}
.ppto-table tr:hover td{background:var(--surface2)}
.ppto-table input{border:1px solid transparent;border-radius:4px;padding:4px 6px;width:100%;background:transparent;font-size:12px}
.ppto-table input:focus{border-color:var(--accent);background:var(--surface);outline:none}
.ppto-table .calc{background:var(--surface2);color:var(--ink2);font-size:11px;text-align:right;padding:4px 8px;border-radius:4px;white-space:nowrap}
.ppto-section-row td{background:var(--ink);color:#fff;font-weight:700;font-size:11px;letter-spacing:.5px;padding:6px 10px}
.ppto-resumen{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px;margin-top:20px}
.res-grid{display:grid;grid-template-columns:1fr 1fr;gap:0}
.res-row{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border)}
.res-row:last-child{border-bottom:none}
.res-row.highlight{background:var(--accent-lt)}
.res-row.total{background:var(--ink);color:#fff;border-radius:var(--r);margin:8px 0 0}
.res-label{font-size:11px;color:var(--ink3);font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.res-label.total{color:rgba(255,255,255,.6)}
.res-value{font-size:14px;font-weight:700;color:var(--ink)}
.res-value.pos{color:var(--green)}
.res-value.neg{color:var(--red)}
.res-value.total{color:#fff;font-size:16px}

/* ‚ïê‚ïê CONTABLE ‚ïê‚ïê */
.cont-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:18px;margin-bottom:14px}
.cont-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
.progress-bar{height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-top:6px}
.progress-fill{height:100%;border-radius:4px;transition:.3s}
.alerta-row{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:var(--r);margin-bottom:8px;font-size:12px}
/* Charts */
.chart-bar-wrap{display:flex;align-items:flex-end;gap:6px;height:140px;padding:0 4px}
.chart-bar-col{display:flex;flex-direction:column;align-items:center;flex:1;gap:4px;min-width:0}
.chart-bar{width:100%;border-radius:4px 4px 0 0;transition:.3s;min-height:4px}
.chart-bar-label{font-size:9px;color:var(--ink3);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}
.chart-bar-val{font-size:9px;font-weight:700;color:var(--ink2);text-align:center}
/* Mov bancario */
.mov-row{display:flex;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid var(--border);font-size:12px}
.mov-row:last-child{border-bottom:none}
.mov-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.mov-desc{flex:1;color:var(--ink2)}
.mov-monto{font-weight:700;white-space:nowrap}
/* Gasto card */
.gasto-tag{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:12px;font-size:11px;font-weight:600}
</style>
</head>
<body>
<!-- ‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="auth-logo-mark">F</div>
      <div class="auth-logo-name">FORMA</div>
      <div class="auth-logo-tag">Sistema de Gesti√≥n</div>
    </div>
    <div class="auth-tab">
      <div class="auth-tab-btn active" id="tab-login" onclick="switchAuthTab('login')">Iniciar sesi√≥n</div>
      <div class="auth-tab-btn" id="tab-registro" onclick="switchAuthTab('registro')">Registrarse</div>
    </div>

    <!-- LOGIN -->
    <div id="auth-login">
      <div class="auth-field"><label>Email</label><input type="email" id="au-email" placeholder="tu@email.com" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <div class="auth-field"><label>Contrase√±a</label><input type="password" id="au-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <button class="auth-btn" onclick="doLogin()">Entrar</button>
      <div id="auth-login-msg" style="display:none" class="auth-msg"></div>
    </div>

    <!-- REGISTRO -->
    <div id="auth-registro" style="display:none">
      <div class="auth-field"><label>Nombre completo</label><input id="au-rnom" placeholder="Tu nombre"></div>
      <div class="auth-field"><label>Email</label><input type="email" id="au-remail" placeholder="tu@email.com"></div>
      <div class="auth-field"><label>Contrase√±a</label><input type="password" id="au-rpass" placeholder="M√≠nimo 6 caracteres"></div>
      <div class="auth-field"><label>Repetir contrase√±a</label><input type="password" id="au-rpass2" placeholder="Repetir"></div>
      <button class="auth-btn" onclick="doRegistro()">Solicitar acceso</button>
      <div id="auth-reg-msg" style="display:none" class="auth-msg"></div>
    </div>
  </div>
</div>

<div class="app">
  <aside class="sidebar">
    <div class="sb-logo">
      <div class="logo-mark">F</div>
      <div class="logo-name">FORMA</div>
      <div class="logo-tag">Gesti√≥n Integral</div>
    </div>
    <nav class="sb-nav">
      <div class="sb-section">Principal</div>
      <div class="sb-item" id="nav-dashboard" onclick="go('dashboard')"><i class="fa fa-chart-bar"></i><span>Dashboard</span></div>
      <div class="sb-section">Comercial</div>
      <div class="sb-item" id="nav-leads" onclick="go('leads')"><i class="fa fa-funnel-dollar"></i><span>Leads</span></div>
      <div class="sb-item" id="nav-ventas" onclick="go('ventas')"><i class="fa fa-address-book"></i><span>Ventas</span></div>
      <div class="sb-section">Operaciones</div>
      <div class="sb-item" id="nav-gestion" onclick="go('gestion')"><i class="fa fa-project-diagram"></i><span>Gesti√≥n</span></div>
      <div class="sb-item" id="nav-diseno" onclick="go('diseno')"><i class="fa fa-pen-nib"></i><span>Dise√±o</span></div>
      <div class="sb-section">Finanzas</div>
      <div class="sb-item" id="nav-presupuestos" onclick="go('presupuestos')"><i class="fa fa-file-invoice-dollar"></i><span>Presupuestos</span></div>
      <div class="sb-item" id="nav-contable" onclick="go('contable')"><i class="fa fa-coins"></i><span>Contable</span></div>
      <div class="sb-section" id="sb-sec-admin" style="display:none">Administraci√≥n</div>
      <div class="sb-item" id="nav-administracion" onclick="go('administracion')" style="display:none"><i class="fa fa-briefcase"></i><span>Gastos & RRHH</span></div>
      <div class="sb-item" id="nav-financiero" onclick="go('financiero')" style="display:none"><i class="fa fa-chart-line"></i><span>An√°lisis Financiero</span></div>
      <div class="sb-item" id="nav-usuarios" onclick="go('usuarios')" style="display:none"><i class="fa fa-users-cog"></i><span>Usuarios</span></div>
    </nav>
    <div class="sb-user" style="cursor:pointer" onclick="doLogout()" title="Cerrar sesi√≥n">
      <div class="sb-avatar" id="sb-avatar" style="background:var(--accent)">A</div>
      <div style="flex:1;min-width:0">
        <div class="sb-uname" id="sb-uname">Admin Sistema</div>
        <div class="sb-urole" id="sb-urole">Acceso total</div>
      </div>
      <i class="fa fa-sign-out-alt" style="color:rgba(255,255,255,.3);font-size:12px"></i>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="topbar-left">
        <div class="topbar-title" id="topbar-title">Dashboard</div>
        <div class="sw"><i class="fa fa-search si"></i>
          <input type="text" id="search-q" placeholder="Buscar..." oninput="buscar(this.value)">
        </div>
      </div>
      <div id="topbar-actions" style="display:flex;gap:8px"></div>
    </div>
    <div class="content" id="content"></div>
  </main>
</div>

<!-- ‚ïê‚ïê MODALES ‚ïê‚ïê -->

<!-- Lead -->
<div class="overlay" id="m-lead">
  <div class="modal modal-lg">
    <div class="modal-hd"><div class="modal-title" id="m-lead-title">Nuevo Lead</div>
      <div class="modal-close" onclick="cerrar('m-lead')"><i class="fa fa-times"></i></div></div>
    <div class="modal-bd">
      <div class="fg">
        <div class="field"><label>Nombre *</label><input id="l-nom" placeholder="Nombre"></div>
        <div class="field"><label>Apellido *</label><input id="l-ape" placeholder="Apellido"></div>
        <div class="field"><label>Empresa</label><input id="l-emp" placeholder="Empresa"></div>
        <div class="field"><label>Cargo</label><input id="l-cargo" placeholder="Cargo"></div>
        <div class="field"><label>Tel√©fono</label><input id="l-tel" placeholder="+54 9 ..."></div>
        <div class="field"><label>Email</label><input type="email" id="l-email"></div>
        <div class="field"><label>Localidad</label><input id="l-loc" placeholder="Ciudad"></div>
        <div class="field"><label>Provincia</label><input id="l-prov" placeholder="Provincia"></div>
        <div class="field"><label>Origen</label>
          <select id="l-origen"><option value="referido">üë• Referido</option><option value="instagram">üì∏ Instagram</option><option value="web">üåê Web/Google</option><option value="llamada-fria">üìû Llamada fr√≠a</option><option value="whatsapp">üí¨ WhatsApp</option><option value="otro">üìå Otro</option></select></div>
        <div class="field"><label>Categor√≠a</label>
          <select id="l-cat"><option value="Oficina">üè¢ Oficina</option><option value="Hogar">üè† Hogar</option><option value="Comercio">üè™ Comercio</option></select></div>
        <div class="field"><label>Tipo de obra</label>
          <select id="l-tipo"><option value="Equipamiento">üõãÔ∏è Equipamiento</option><option value="Renovaci√≥n">‚ú® Renovaci√≥n</option><option value="Dise√±o integral">üìê Dise√±o integral</option></select></div>
        <div class="field"><label>Score: <span id="l-score-val" style="color:var(--accent);font-weight:700">50</span></label>
          <input type="range" id="l-score" min="0" max="100" value="50" oninput="document.getElementById('l-score-val').textContent=this.value" style="width:100%;margin-top:6px"></div>
        <div class="field"><label>Presupuesto est. ($)</label><input type="number" id="l-ppto" placeholder="0"></div>
        <div class="field fc"><label>Notas</label><textarea id="l-notas"></textarea></div>
      </div>
      <div class="tx-box" id="l-tx-box">
        <label>¬øA d√≥nde va este lead?</label>
        <select id="l-transfer"><option value="ventas">üè∑Ô∏è Solo en Ventas</option><option value="gestion">üìê Transferir a Gesti√≥n (visita agendada)</option></select>
        <div class="tx-note">* Si transfer√≠s a Gesti√≥n, se crea un Proyecto autom√°ticamente.</div>
      </div>
    </div>
    <div class="modal-ft"><div></div>
      <div style="display:flex;gap:10px">
        <button class="btn btn-secondary" onclick="cerrar('m-lead')">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarLead()"><i class="fa fa-save"></i> Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Timeline -->
<div class="overlay" id="m-timeline">
  <div class="modal" style="max-width:500px">
    <div class="modal-hd"><div class="modal-title">Registrar actividad</div>
      <div class="modal-close" onclick="cerrar('m-timeline')"><i class="fa fa-times"></i></div></div>
    <div class="modal-bd">
      <div class="fg">
        <div class="field fc"><label>Tipo</label>
          <select id="tl-tipo"><option value="llamada">üìû Llamada</option><option value="reunion">ü§ù Reuni√≥n/Visita</option><option value="email">‚úâÔ∏è Email</option><option value="whatsapp">üí¨ WhatsApp</option><option value="nota">üìù Nota interna</option></select></div>
        <div class="field fc"><label>Descripci√≥n</label><textarea id="tl-nota" placeholder="¬øQu√© pas√≥?"></textarea></div>
        <div class="field"><label>Fecha</label><input type="date" id="tl-fecha"></div>
        <div class="field"><label>Pr√≥ximo contacto</label><input type="date" id="tl-prox"></div>
      </div>
    </div>
    <div class="modal-ft"><div></div><div style="display:flex;gap:10px">
      <button class="btn btn-secondary" onclick="cerrar('m-timeline')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarTL()">Guardar</button>
    </div></div>
  </div>
</div>

<!-- Proyecto -->
<div class="overlay" id="m-proyecto">
  <div class="modal modal-lg">
    <div class="modal-hd"><div class="modal-title" id="m-proy-title">Nuevo Proyecto</div>
      <div class="modal-close" onclick="cerrar('m-proyecto')"><i class="fa fa-times"></i></div></div>
    <div class="modal-bd">
      <div class="fg">
        <div class="field fc"><label>Nombre del proyecto *</label><input id="p-nom" placeholder="Ej: Oficina ERG - Planta 3"></div>
        <div class="field"><label>Cliente</label><input id="p-cli" placeholder="Nombre del cliente"></div>
        <div class="field"><label>Empresa</label><input id="p-emp"></div>
        <div class="field"><label>CUIT</label><input id="p-cuit" placeholder="30-00000000-0"></div>
        <div class="field"><label>Tel√©fono</label><input id="p-tel"></div>
        <div class="field"><label>Email</label><input type="email" id="p-email"></div>
        <div class="field"><label>Categor√≠a</label>
          <select id="p-cat"><option value="Oficina">üè¢ Oficina</option><option value="Hogar">üè† Hogar</option><option value="Comercio">üè™ Comercio</option></select></div>
        <div class="field"><label>Tipo</label>
          <select id="p-tipo"><option value="Equipamiento">üõãÔ∏è Equipamiento</option><option value="Renovaci√≥n">‚ú® Renovaci√≥n</option><option value="Dise√±o integral">üìê Dise√±o integral</option></select></div>
        <div class="field"><label>Estado</label>
          <select id="p-status">
            <option value="relevamiento">üîç Relevamiento pendiente</option>
            <option value="en-proceso">‚öôÔ∏è En proceso</option>
            <option value="esperando-diseno">üé® Esperando Dise√±o</option>
            <option value="en-diseno">‚úèÔ∏è En Dise√±o</option>
            <option value="diseno-entregado">‚úÖ Dise√±o entregado</option>
            <option value="presupuestando">üí∞ Presupuestando</option>
            <option value="presupuesto-enviado">üì§ Ppto. enviado</option>
            <option value="aprobado">üéâ Aprobado</option>
            <option value="cancelado">‚ùå Cancelado</option>
          </select></div>
        <div class="field"><label>Fecha l√≠mite</label><input type="date" id="p-fecha"></div>
        <div class="field fc"><label>Brief / Descripci√≥n</label><textarea id="p-desc"></textarea></div>
        <div class="field fc"><label>Notas de relevamiento</label><textarea id="p-relev"></textarea></div>
      </div>
      <div class="tx-box">
        <label>√Årea responsable</label>
        <select id="p-area"><option value="gestion">üìê Gesti√≥n</option><option value="ventas">üè∑Ô∏è Ventas</option><option value="diseno">üé® Dise√±o</option><option value="admin">üíº Administraci√≥n</option></select>
        <div class="tx-note">* Se registra en historial con fecha.</div>
      </div>
    </div>
    <div class="modal-ft"><div></div><div style="display:flex;gap:10px">
      <button class="btn btn-secondary" onclick="cerrar('m-proyecto')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarProyecto()"><i class="fa fa-save"></i> Guardar</button>
    </div></div>
  </div>
</div>

<!-- Detalle gen√©rico -->
<div class="overlay" id="m-detalle">
  <div class="modal modal-lg">
    <div class="modal-hd">
      <div><div class="modal-title" id="det-title"></div><div style="font-size:11px;color:var(--ink3);margin-top:2px" id="det-sub"></div></div>
      <div style="display:flex;gap:8px"><button class="btn btn-secondary btn-sm" id="det-edit-btn">Editar</button>
        <div class="modal-close" onclick="cerrar('m-detalle')"><i class="fa fa-times"></i></div></div>
    </div>
    <div class="modal-bd" id="det-body" style="padding:0"></div>
  </div>
</div>

<!-- Dise√±o -->
<div class="overlay" id="m-diseno">
  <div class="modal" style="max-width:560px">
    <div class="modal-hd"><div class="modal-title" id="m-dis-title">Solicitud de Dise√±o</div>
      <div class="modal-close" onclick="cerrar('m-diseno')"><i class="fa fa-times"></i></div></div>
    <div class="modal-bd">
      <div class="fg">
        <div class="field fc"><label>Proyecto</label><select id="d-proy"></select></div>
        <div class="field fc"><label>Tipo</label>
          <select id="d-tipo"><option value="render">üñºÔ∏è Render 3D</option><option value="autocad">üìê AutoCAD</option><option value="presentacion">üìä Presentaci√≥n</option><option value="otro">üìå Otro</option></select></div>
        <div class="field fc"><label>Brief</label><textarea id="d-brief" rows="3"></textarea></div>
        <div class="field"><label>Fecha entrega</label><input type="date" id="d-fecha"></div>
        <div class="field"><label>Estado</label>
          <select id="d-status"><option value="pendiente">‚è≥ Pendiente</option><option value="en-proceso">‚öôÔ∏è En proceso</option><option value="entregado">‚úÖ Entregado</option><option value="con-modificaciones">üîÑ Con modificaciones</option><option value="aprobado">üéâ Aprobado</option></select></div>
      </div>
      <div class="sec-label">Archivos</div>
      <div id="d-files-list" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px"></div>
      <label class="btn btn-secondary" style="cursor:pointer"><i class="fa fa-paperclip"></i> Adjuntar (m√°x 5MB)
        <input type="file" id="d-file-input" style="display:none" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.dwg" onchange="adjuntarArchivo()"></label>
    </div>
    <div class="modal-ft"><div></div><div style="display:flex;gap:10px">
      <button class="btn btn-secondary" onclick="cerrar('m-diseno')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarDiseno()">Guardar</button>
    </div></div>
  </div>
</div>

<!-- ‚ïê‚ïê MODAL PRESUPUESTO ‚ïê‚ïê -->
<div class="overlay" id="m-presupuesto">
  <div class="modal modal-xl">
    <div class="modal-hd">
      <div>
        <div class="modal-title" id="m-ppto-title">Nuevo Presupuesto</div>
        <div style="font-size:11px;color:var(--ink3);margin-top:2px" id="m-ppto-num"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn btn-secondary btn-sm" onclick="verVistaCliente()"><i class="fa fa-eye"></i> Vista cliente</button>
        <div class="modal-close" onclick="cerrar('m-presupuesto')"><i class="fa fa-times"></i></div>
      </div>
    </div>
    <div class="modal-bd">
      <!-- Cabecera -->
      <div class="fg" style="margin-bottom:16px">
        <div class="field"><label>Proyecto vinculado</label><select id="pp-proyecto" onchange="autoFillClientePpto()"></select></div>
        <div class="field"><label>Tipo de Factura</label>
          <select id="pp-factura"><option value="A">Factura A (IVA discriminado)</option><option value="B">Factura B</option><option value="C">Factura C</option></select></div>
        <div class="field"><label>Estado</label>
          <select id="pp-status"><option value="borrador">üìù Borrador</option><option value="enviado">üì§ Enviado</option><option value="aprobado">‚úÖ Aprobado</option><option value="rechazado">‚ùå Rechazado</option></select></div>
        <div class="field"><label>Fecha</label><input type="date" id="pp-fecha"></div>
        <div class="field"><label>Cliente</label><input id="pp-cliente" placeholder="Nombre del cliente"></div>
        <div class="field"><label>CUIT</label><input id="pp-cuit" placeholder="30-00000000-0"></div>
        <div class="field"><label>Descuento %</label><input type="number" id="pp-dto" value="0" min="0" max="100" oninput="recalcPpto()" placeholder="0"></div>
        <div class="field"><label>Notas / Condiciones</label><input id="pp-notas" placeholder="Ej: Validez 30 d√≠as, pago 50% adelantado"></div>
      </div>

      <!-- Tabla de √≠tems -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div class="sec-label" style="margin:0">√çtems del presupuesto</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary btn-sm" onclick="agregarItem()"><i class="fa fa-plus"></i> √çtem</button>
        </div>
      </div>

      <div style="overflow-x:auto">
        <table class="ppto-table" id="ppto-items-table">
          <thead>
            <tr>
              <th style="width:28px">#</th>
              <th style="min-width:170px">Descripci√≥n</th>
              <th style="width:105px">Costo neto</th>
              <th style="width:75px">% Flete</th>
              <th style="width:110px">% Margen</th>
              <th style="width:50px">Cant.</th>
              <th style="width:105px">Costo c/flete</th>
              <th style="width:105px">P. Neto unit.</th>
              <th style="width:120px">% IVA ¬∑ IVA $</th>
              <th style="width:120px">% IIBB ¬∑ IIBB $</th>
              <th style="width:105px">P. Final unit.</th>
              <th style="width:105px">Total l√≠nea</th>
              <th style="width:32px"></th>
            </tr>
          </thead>
          <tbody id="ppto-items-body"></tbody>
        </table>
      </div>

      <!-- Resumen financiero -->
      <div class="ppto-resumen">
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ink2);margin-bottom:14px">Resumen financiero</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div>
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ink3);margin-bottom:8px">Costos</div>
            <div class="res-row"><span class="res-label">Compra total</span><span class="res-value" id="r-compra">$0</span></div>
            <div class="res-row"><span class="res-label">Flete total</span><span class="res-value" id="r-flete">$0</span></div>
            <div class="res-row"><span class="res-label">Seguro (0.9%)</span><span class="res-value" id="r-seguro">$0</span></div>
            <div class="res-row highlight"><span class="res-label">Margen total</span><span class="res-value pos" id="r-margen">$0</span></div>
            <div class="res-row"><span class="res-label">IVA Compras (21%)</span><span class="res-value" id="r-iva-compras">$0</span></div>
          </div>
          <div>
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ink3);margin-bottom:8px">Venta al cliente</div>
            <div class="res-row"><span class="res-label">Subtotal s/impuestos</span><span class="res-value" id="r-subtotal">$0</span></div>
            <div class="res-row"><span class="res-label">IVA Ventas (21%)</span><span class="res-value" id="r-iva-ventas">$0</span></div>
            <div class="res-row"><span class="res-label">IIBB (3.5%)</span><span class="res-value" id="r-iibb">$0</span></div>
            <div class="res-row"><span class="res-label">IVA a pagar (Ventas - Compras)</span><span class="res-value" id="r-iva-pagar">$0</span></div>
            <div class="res-row"><span class="res-label">Descuento aplicado</span><span class="res-value neg" id="r-dto">$0</span></div>
          </div>
        </div>
        <div class="res-row total" style="margin-top:12px">
          <span class="res-label total" style="font-size:13px">TOTAL FINAL AL CLIENTE</span>
          <span class="res-value total" id="r-total">$0</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:14px">
          <div style="padding:12px;background:var(--green-lt);border-radius:var(--r);text-align:center">
            <div style="font-size:10px;color:var(--green);font-weight:700;text-transform:uppercase;letter-spacing:.8px">Ganancia %</div>
            <div style="font-size:20px;font-weight:800;color:var(--green);margin-top:4px" id="r-ganancia-pct">0%</div>
            <div style="font-size:11px;color:var(--green);margin-top:3px;font-weight:600" id="r-ganancia-val">$0</div>
          </div>
          <div style="padding:12px;background:var(--accent-lt);border-radius:var(--r);text-align:center">
            <div style="font-size:10px;color:var(--accent);font-weight:700;text-transform:uppercase;letter-spacing:.8px">ROI</div>
            <div style="font-size:20px;font-weight:800;color:var(--accent);margin-top:4px" id="r-roi">0%</div>
            <div style="font-size:11px;color:var(--accent);margin-top:3px;font-weight:600" id="r-roi-val">$0</div>
          </div>
          <div style="padding:12px;background:var(--amber-lt);border-radius:var(--r);text-align:center">
            <div style="font-size:10px;color:var(--amber);font-weight:700;text-transform:uppercase;letter-spacing:.8px">IVA a pagar ARCA</div>
            <div style="font-size:20px;font-weight:800;color:var(--amber);margin-top:4px" id="r-iva-arca">$0</div>
            <div style="font-size:11px;color:var(--amber);margin-top:3px;font-weight:600" id="r-iva-arca-val">$0</div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-danger btn-sm" id="ppto-delete-btn" style="display:none" onclick="eliminarPpto()"><i class="fa fa-trash"></i> Eliminar</button>
      <div style="display:flex;gap:10px">
        <button class="btn btn-secondary" onclick="cerrar('m-presupuesto')">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarPpto()"><i class="fa fa-save"></i> Guardar Presupuesto</button>
      </div>
    </div>
  </div>
</div>

<!-- Vista Cliente -->
<div class="overlay" id="m-vista-cliente">
  <div class="modal modal-lg">
    <div class="modal-hd">
      <div class="modal-title">Vista Cliente ‚Äî Presentaci√≥n</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary btn-sm" onclick="imprimirCliente()"><i class="fa fa-print"></i> Imprimir</button>
        <div class="modal-close" onclick="cerrar('m-vista-cliente')"><i class="fa fa-times"></i></div>
      </div>
    </div>
    <div class="modal-bd" id="vista-cliente-body"></div>
  </div>
</div>

<!-- Cobro / Pago -->
<div class="overlay" id="m-cobropago">
  <div class="modal" style="max-width:480px">
    <div class="modal-hd"><div class="modal-title" id="m-cp-title">Registrar cobro</div>
      <div class="modal-close" onclick="cerrar('m-cobropago')"><i class="fa fa-times"></i></div></div>
    <div class="modal-bd">
      <div class="fg">
        <div class="field fc"><label>Concepto</label><input id="cp-concepto" placeholder="Ej: Se√±a 50%, Pago final..."></div>
        <div class="field"><label>Monto ($)</label><input type="number" id="cp-monto" placeholder="0"></div>
        <div class="field"><label>Fecha</label><input type="date" id="cp-fecha"></div>
        <div class="field fc"><label>Medio de pago</label>
          <select id="cp-medio"><option value="transferencia">üè¶ Transferencia</option><option value="cheque">üìÑ Cheque</option><option value="efectivo">üíµ Efectivo</option><option value="tarjeta">üí≥ Tarjeta</option></select></div>
        <div class="field fc"><label>Notas</label><input id="cp-notas" placeholder="Observaciones..."></div>
      </div>
    </div>
    <div class="modal-ft"><div></div><div style="display:flex;gap:10px">
      <button class="btn btn-secondary" onclick="cerrar('m-cobropago')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarCobro()">Guardar</button>
    </div></div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FORMA v3 ‚Äî Sistema completo con Presupuestos y Contable
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const DB_KEY = 'forma_v3';
const AUTH_KEY = 'forma_auth';
let DB, modulo = 'dashboard', searchQ = '';
let editLeadId=null, editProjId=null, editDisId=null, editPptoId=null;
let tlLeadId=null, cpPptoId=null, cpTipo=null;
let archivosTemp=[], pptoItems=[];
let CURRENT_USER = null; // usuario logueado
let editUsrId = null;
const MODULOS_ALL = [
  {id:'dashboard', label:'Dashboard', icon:'fa-chart-bar'},
  {id:'leads',     label:'Leads',     icon:'fa-funnel-dollar'},
  {id:'ventas',    label:'Ventas',    icon:'fa-address-book'},
  {id:'gestion',   label:'Gesti√≥n',   icon:'fa-project-diagram'},
  {id:'diseno',    label:'Dise√±o',    icon:'fa-pen-nib'},
  {id:'presupuestos', label:'Presupuestos', icon:'fa-file-invoice-dollar'},
  {id:'contable',  label:'Contable',  icon:'fa-coins'},
  {id:'administracion', label:'Gastos & RRHH', icon:'fa-briefcase'},
  {id:'financiero', label:'Financiero', icon:'fa-chart-line'},
];

// ‚îÄ‚îÄ DB ‚îÄ‚îÄ
function initDB() {
  return {
    leads:[
      {id:'l1',nom:'Carlos',ape:'M√©ndez',emp:'Grupo Inversiones SA',cargo:'Gerente',
       tel:'+54 9 388 4112233',email:'carlos@grupoinv.com',origen:'referido',
       cat:'Oficina',tipo:'Equipamiento',score:75,ppto:1500000,
       notas:'Interesado en equipar 2 plantas. Urgente para marzo.',
       loc:'San Salvador de Jujuy',prov:'Jujuy',status:'Contactado',area:'ventas',fecha:hoy()},
      {id:'l2',nom:'Valentina',ape:'Torres',emp:'Consultora Torres',cargo:'Socia',
       tel:'+54 9 388 5551122',email:'v.torres@ct.com',origen:'instagram',
       cat:'Comercio',tipo:'Dise√±o integral',score:45,ppto:600000,
       notas:'Quiere renovar su local.',loc:'Palpal√°',prov:'Jujuy',
       status:'Pendiente',area:'ventas',fecha:hoy()},
    ],
    proyectos:[
      {id:'p1',nom:'Oficina Norandina - Sala Reuniones',cli:'Andr√©s Caz√≥n',emp:'ERG Norandina',
       cuit:'30-00000000-0',tel:'+54 9 388 1234567',email:'a.cazon@erg.com',
       cat:'Oficina',tipo:'Equipamiento',area:'gestion',status:'presupuestando',
       fecha:'2025-03-30',desc:'Sala de reuniones 120m2.',relev:'Espacio 120m2, alt 2.8m.',creadoEn:hoy()},
    ],
    solicitudes:[],
    timeline:[],
    transferencias:[],
    presupuestos:[],
    cobros:[],
    pagos:[],
    pptoCounter: 3829,
    gastos:[],          // gastos fijos y variables (admin)
    movBancarios:[],    // movimientos importados del banco
    cheques:[],         // registro de cheques
    usuarios:[
      {id:'u-admin', nombre:'Admin Sistema', email:'admin@forma.com',
       passHash: btoa('admin1234'),
       status:'activo', rol:'admin', nota:'Administrador principal',
       modulos:['dashboard','leads','ventas','gestion','diseno','presupuestos','contable','administracion','financiero','usuarios'],
       creadoEn: new Date().toLocaleDateString('es-AR')}
    ]
  };
}

function cargarDB() {
  try { DB = JSON.parse(localStorage.getItem(DB_KEY)) || initDB(); } catch(e) { DB = initDB(); }
  ['leads','proyectos','solicitudes','timeline','transferencias','presupuestos','cobros','pagos','usuarios','gastos','movBancarios','cheques']
    .forEach(k => { if(!Array.isArray(DB[k])) DB[k]=[]; });
  if(!DB.pptoCounter) DB.pptoCounter = 3829;
  // Arrays nuevos retrocompatibles
  if(!Array.isArray(DB.gastos))       DB.gastos=[];
  if(!Array.isArray(DB.movBancarios)) DB.movBancarios=[];
  if(!Array.isArray(DB.cheques))      DB.cheques=[];

  // Datos precargados desde planilla CONTROL_DE_GASTOS.xlsx (234 registros)
  const GASTOS_PLANILLA = [{"id":"imp-0000","concepto":"Limsa","cat":"servicios","tipo":"variable","monto":56789.43,"fecha":"2024-12-01","resp":"Cecilia","medio":"transferencia","notas":"Servicios","creadoEn":"Importado desde planilla"},{"id":"imp-0001","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":15127.19,"fecha":"2024-12-02","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞36173 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0002","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":337986.18,"fecha":"2024-12-02","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞28170 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0003","concepto":"Vigia Electr√≥nica","cat":"servicios","tipo":"variable","monto":38000.0,"fecha":"2024-12-02","resp":"Martin","medio":"transferencia","notas":"Manco Capac 59 | Servicios","creadoEn":"Importado desde planilla"},{"id":"imp-0004","concepto":"Vigia Electr√≥nica","cat":"servicios","tipo":"variable","monto":19600.0,"fecha":"2024-12-02","resp":"Martin","medio":"transferencia","notas":"Lamadrid 349 | Servicios","creadoEn":"Importado desde planilla"},{"id":"imp-0005","concepto":"Pago Oule Sensorial","cat":"materiales","tipo":"variable","monto":70400.0,"fecha":"2024-12-02","resp":"Martin","medio":"transferencia","notas":"Esencia-Silvia Juarez | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0006","concepto":"Decototale","cat":"materiales","tipo":"variable","monto":4659660.75,"fecha":"2024-12-02","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞22911 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0007","concepto":"Pago factura Decototale","cat":"materiales","tipo":"variable","monto":4659661.75,"fecha":"2024-12-02","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞22911 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0008","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":22766.51,"fecha":"2024-12-03","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞142294 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0009","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":237917.25,"fecha":"2024-12-03","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞36207 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0010","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":670000.0,"fecha":"2024-12-03","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞1182 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0011","concepto":"Cardozo Antonio Maximiliano","cat":"materiales","tipo":"variable","monto":157905.0,"fecha":"2024-12-04","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞1660 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0012","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":70000.0,"fecha":"2024-12-04","resp":"","medio":"transferencia","notas":"Factura n¬∞1187 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0013","concepto":"Assef","cat":"materiales","tipo":"variable","monto":25484.7,"fecha":"2024-12-04","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞2839 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0014","concepto":"Duers","cat":"materiales","tipo":"variable","monto":148343.5,"fecha":"2024-12-05","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞162 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0015","concepto":"Brisa Fernandez","cat":"salario","tipo":"fijo","monto":396787.0,"fecha":"2024-12-05","resp":"Cecilia","medio":"transferencia","notas":"Sueldo 11/2024 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0016","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":13492.34,"fecha":"2024-12-05","resp":"Cecilia","medio":"transferencia","notas":"Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0017","concepto":"Pago presupuesto n¬∞19137 Tribeca","cat":"materiales","tipo":"variable","monto":368929.0,"fecha":"2024-12-06","resp":"Cecilia","medio":"transferencia","notas":"Sofa Bed- Vanesa | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0018","concepto":"Gabriel Fernandez","cat":"materiales","tipo":"variable","monto":541553.65,"fecha":"2024-12-09","resp":"Carolina","medio":"cheque","notas":"Factura n¬∞667 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0019","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":13492.34,"fecha":"2024-12-09","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞36385 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0020","concepto":"Marketing","cat":"marketing","tipo":"variable","monto":200000.0,"fecha":"2024-12-10","resp":"Martin","medio":"transferencia","notas":"Publicidad y Marketing","creadoEn":"Importado desde planilla"},{"id":"imp-0021","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":56771.72,"fecha":"2024-12-10","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞36410 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0022","concepto":"Rossi","cat":"materiales","tipo":"variable","monto":609840.0,"fecha":"2024-12-10","resp":"Carolina","medio":"cheque","notas":"Factura n¬∞66193 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0023","concepto":"Operaciones Inmobiliarias Parque el Solar","cat":"otros","tipo":"variable","monto":49500.0,"fecha":"2024-12-10","resp":"Martin","medio":"tarjeta","notas":"Expensa anual hasta 2025 | Hogar","creadoEn":"Importado desde planilla"},{"id":"imp-0024","concepto":"Pago factura Cardozo Antonio Maximiliano","cat":"materiales","tipo":"variable","monto":157905.0,"fecha":"2024-12-10","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞1660 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0025","concepto":"Patricio Gonzalez","cat":"salario","tipo":"variable","monto":92000.0,"fecha":"2024-12-10","resp":"Cecilia","medio":"transferencia","notas":"Pago horas horas 11/24-10/12/24 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0026","concepto":"A√±os Luz Horizonte","cat":"materiales","tipo":"variable","monto":35340.16,"fecha":"2024-12-10","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Factura n¬∞27631 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0027","concepto":"Horizonte Electricidad","cat":"materiales","tipo":"variable","monto":1265.3,"fecha":"2024-12-10","resp":"Cecilia/Martin","medio":"efectivo","notas":"Factura n¬∞111429 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0028","concepto":"Pago factura de alquiler","cat":"impuestos","tipo":"fijo","monto":1191850.0,"fecha":"2024-12-10","resp":"Cecilia","medio":"transferencia","notas":"Administraci√≥n","creadoEn":"Importado desde planilla"},{"id":"imp-0029","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":26998.91,"fecha":"2024-12-11","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞36487 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0030","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":93465.19,"fecha":"2024-12-11","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞36486 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0031","concepto":"Jujuy Materiales","cat":"materiales","tipo":"variable","monto":77941.0,"fecha":"2024-12-11","resp":"Martin","medio":"tarjeta","notas":"Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0032","concepto":"Rossi","cat":"materiales","tipo":"variable","monto":870837.0,"fecha":"2024-12-12","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞66259 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0033","concepto":"Duers","cat":"materiales","tipo":"variable","monto":179495.64,"fecha":"2024-12-12","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞172 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0034","concepto":"Rentas","cat":"impuestos","tipo":"variable","monto":10633.64,"fecha":"2024-12-12","resp":"Carolina","medio":"tarjeta","notas":"Pago sellado Oc n¬∞7283 | Administraci√≥n","creadoEn":"Importado desde planilla"},{"id":"imp-0035","concepto":"Rentas","cat":"impuestos","tipo":"variable","monto":6878.86,"fecha":"2024-12-13","resp":"Carolina","medio":"tarjeta","notas":"Pago sellado Oc n¬∞3216 | Administraci√≥n","creadoEn":"Importado desde planilla"},{"id":"imp-0036","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":122521.41,"fecha":"2024-12-13","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞36562 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0037","concepto":"Kevin Cruz","cat":"salario","tipo":"fijo","monto":400000.0,"fecha":"2024-12-16","resp":"Cecilia","medio":"transferencia","notas":"Sueldo 15/11/2024-15/12/2024 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0038","concepto":"Pago Red Net. presupuesto n¬∞990","cat":"materiales","tipo":"variable","monto":55760.0,"fecha":"2024-12-17","resp":"Carolina","medio":"transferencia","notas":"Fichas Exar | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0039","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":66459.08,"fecha":"2024-12-17","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞36642 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0040","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":190646.26,"fecha":"2024-12-17","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞36643 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0041","concepto":"Incanto","cat":"materiales","tipo":"variable","monto":229900.0,"fecha":"2024-12-17","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞8329 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0042","concepto":"Rossi","cat":"materiales","tipo":"variable","monto":1351812.0,"fecha":"2024-12-17","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞66377 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0043","concepto":"Rossi","cat":"materiales","tipo":"variable","monto":203643.0,"fecha":"2024-12-17","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞66364 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0044","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":202928.27,"fecha":"2024-12-18","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞36712 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0045","concepto":"Pago factura Incanto n¬∞8329","cat":"materiales","tipo":"variable","monto":229900.0,"fecha":"2024-12-18","resp":"","medio":"transferencia","notas":"Banquetas reguables- Pacheco Maylin | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0046","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":11992.84,"fecha":"2024-12-19","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞36738 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0047","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":29847.84,"fecha":"2024-12-20","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞28262 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0048","concepto":"Rentas","cat":"impuestos","tipo":"variable","monto":3460.29,"fecha":"2024-12-20","resp":"Carolina","medio":"tarjeta","notas":"Pago sellado Oc n¬∞83867 | Administraci√≥n","creadoEn":"Importado desde planilla"},{"id":"imp-0049","concepto":"Assef","cat":"materiales","tipo":"variable","monto":8260.0,"fecha":"2024-12-20","resp":"Martin","medio":"efectivo","notas":"Factura n¬∞2887 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0050","concepto":"Libreria San Pablo","cat":"materiales","tipo":"variable","monto":7002.9,"fecha":"2024-12-20","resp":"Cecilia","medio":"efectivo","notas":"Cinta para empaque | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0051","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":13716.84,"fecha":"2024-12-21","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞36799 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0052","concepto":"Rossi","cat":"materiales","tipo":"variable","monto":242030.25,"fecha":"2024-12-23","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞66488 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0053","concepto":"Kanan Hilda Mariela","cat":"impuestos","tipo":"variable","monto":42340.0,"fecha":"2024-12-23","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞363 | Administraci√≥n","creadoEn":"Importado desde planilla"},{"id":"imp-0054","concepto":"Martin Alurralde","cat":"salario","tipo":"variable","monto":230000.0,"fecha":"2024-12-24","resp":"Cecilia","medio":"transferencia","notas":"Pago horas hasta el 24/12/24 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0055","concepto":"Carolina Puertas","cat":"salario","tipo":"fijo","monto":570543.36,"fecha":"2024-12-24","resp":"Cecilia","medio":"transferencia","notas":"Sueldo 11/2024 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0056","concepto":"Flex Color","cat":"materiales","tipo":"variable","monto":315791.29,"fecha":"2024-12-24","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞185001 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0057","concepto":"Assef","cat":"materiales","tipo":"variable","monto":2741.58,"fecha":"2024-12-26","resp":"Cecilia","medio":"efectivo","notas":"Factura n¬∞2894 - Bisagra + tornillo | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0058","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":9208.03,"fecha":"2024-12-26","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞4350 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0059","concepto":"Gabriel Fernandez","cat":"materiales","tipo":"variable","monto":56621.95,"fecha":"2024-12-26","resp":"Carolina","medio":"cheque","notas":"Factura n¬∞729 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0060","concepto":"Rossi","cat":"materiales","tipo":"variable","monto":176660.0,"fecha":"2024-12-26","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞66518 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0061","concepto":"Electro punto","cat":"materiales","tipo":"variable","monto":606012.61,"fecha":"2024-12-26","resp":"Cecilia/Martin","medio":"transferencia","notas":"Factura n¬∞7350 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0062","concepto":"Agustin Guzman","cat":"salario","tipo":"variable","monto":208000.0,"fecha":"2024-12-27","resp":"Cecilia","medio":"transferencia","notas":"Pago horas 12/24 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0063","concepto":"Assef","cat":"materiales","tipo":"variable","monto":3700.0,"fecha":"2024-12-27","resp":"Cecilia","medio":"efectivo","notas":"Factura n¬∞2899 - Diferencia por cambio | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0064","concepto":"Oscar Massa","cat":"materiales","tipo":"variable","monto":1702051.34,"fecha":"2024-12-27","resp":"Cecilia","medio":"transferencia","notas":"Factura n¬∞3025 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0065","concepto":"Flex Color","cat":"materiales","tipo":"variable","monto":703490.39,"fecha":"2024-12-27","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞185449 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0066","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":14647.46,"fecha":"2024-12-27","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞36872 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0067","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":14348.84,"fecha":"2024-12-27","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞36862 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0068","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":27512.04,"fecha":"2024-12-27","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞36898 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0069","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":38028.04,"fecha":"2024-12-27","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞36873 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0070","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":15000.0,"fecha":"2024-12-28","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞1220 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0071","concepto":"Agua Xibi Xibi","cat":"impuestos","tipo":"variable","monto":5000.0,"fecha":"2024-12-28","resp":"Carolina","medio":"efectivo","notas":"factura n¬∞1073 - caja chica | Administraci√≥n","creadoEn":"Importado desde planilla"},{"id":"imp-0072","concepto":"Patricio Gonzalez","cat":"salario","tipo":"variable","monto":158000.0,"fecha":"2024-12-28","resp":"Cecilia","medio":"transferencia","notas":"Pago horas horas 11/12/24-28/12/24 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0073","concepto":"Supermercado de Mascotas","cat":"otros","tipo":"variable","monto":2400.0,"fecha":"2024-12-28","resp":"Cecilia/Martin","medio":"efectivo","notas":"Factura n¬∞12319 | Hogar","creadoEn":"Importado desde planilla"},{"id":"imp-0074","concepto":"Assef","cat":"materiales","tipo":"variable","monto":45667.0,"fecha":"2024-12-30","resp":"Cecilia","medio":"tarjeta","notas":"Factura n¬∞2903 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0075","concepto":"Kilowatt","cat":"materiales","tipo":"variable","monto":129133.17,"fecha":"2024-12-30","resp":"Cecilia","medio":"tarjeta","notas":"Factura n¬∞5439 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0076","concepto":"Brumafra","cat":"proveedor","tipo":"variable","monto":61268.69,"fecha":"2024-12-30","resp":"Martin","medio":"efectivo","notas":"Factura n¬∞2981 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0077","concepto":"Libreria San Pablo","cat":"materiales","tipo":"variable","monto":4668.6,"fecha":"2024-12-30","resp":"Cecilia/Martin","medio":"efectivo","notas":"Factura n¬∞52514 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0078","concepto":"Flex Color","cat":"materiales","tipo":"variable","monto":317876.04,"fecha":"2024-12-30","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞185668 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0079","concepto":"SQL","cat":"materiales","tipo":"variable","monto":1026000.14,"fecha":"2024-12-31","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞6089 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0080","concepto":"Flex Color","cat":"materiales","tipo":"variable","monto":1388790.99,"fecha":"2024-12-31","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞187383 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0081","concepto":"Caballero Virginia","cat":"materiales","tipo":"variable","monto":13917.1,"fecha":"2024-12-31","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Factura n¬∞45185 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0082","concepto":"Limsa","cat":"servicios","tipo":"variable","monto":56789.53,"fecha":"2025-01-01","resp":"Cecilia","medio":"transferencia","notas":"Servicios","creadoEn":"Importado desde planilla"},{"id":"imp-0083","concepto":"Electromat","cat":"materiales","tipo":"variable","monto":2016.6,"fecha":"2025-01-02","resp":"Martin","medio":"efectivo","notas":"Factura n¬∞60819 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0084","concepto":"Vigia Electr√≥nica","cat":"servicios","tipo":"variable","monto":20700.0,"fecha":"2025-01-02","resp":"Martin","medio":"transferencia","notas":"Factura n¬∞2396 | Servicios","creadoEn":"Importado desde planilla"},{"id":"imp-0085","concepto":"Vigia Electr√≥nica","cat":"servicios","tipo":"variable","monto":39800.0,"fecha":"2025-01-02","resp":"Martin","medio":"transferencia","notas":"Factura n¬∞2143 | Servicios","creadoEn":"Importado desde planilla"},{"id":"imp-0086","concepto":"Pago factura Flex Color","cat":"materiales","tipo":"variable","monto":633667.31,"fecha":"2025-01-03","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞185001/185668 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0087","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":11992.84,"fecha":"2025-01-03","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞37014 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0088","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":130055.04,"fecha":"2025-01-04","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞1226 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0089","concepto":"Chango mas","cat":"otros","tipo":"variable","monto":63275.62,"fecha":"2025-01-04","resp":"Cecilia","medio":"efectivo","notas":"Factura n¬∞459 | Hogar","creadoEn":"Importado desde planilla"},{"id":"imp-0090","concepto":"Balbi e Hijos","cat":"otros","tipo":"variable","monto":113200.0,"fecha":"2025-01-04","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Factura n¬∞842 | Hogar","creadoEn":"Importado desde planilla"},{"id":"imp-0091","concepto":"CYM Materiales","cat":"materiales","tipo":"variable","monto":900.0,"fecha":"2025-01-07","resp":"Carolina","medio":"efectivo","notas":"Factura n¬∞42262 - caja chica | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0092","concepto":"Cavirama","cat":"proveedor","tipo":"variable","monto":77823.4,"fecha":"2025-01-07","resp":"Martin","medio":"efectivo","notas":"Factura n¬∞34658 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0093","concepto":"Maxiking","cat":"materiales","tipo":"variable","monto":1949536.91,"fecha":"2025-01-07","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞308 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0094","concepto":"AB construcciones","cat":"materiales","tipo":"variable","monto":803.06,"fecha":"2025-01-07","resp":"Cecilia/Martin","medio":"efectivo","notas":"Factura n¬∞135524 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0095","concepto":"Pago factura Rossi","cat":"materiales","tipo":"variable","monto":609840.0,"fecha":"2025-01-08","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞66193 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0096","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":18540.14,"fecha":"2025-01-08","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞37146 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0097","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":54163.41,"fecha":"2025-01-08","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞28327 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0098","concepto":"Transporte Balut","cat":"proveedor","tipo":"variable","monto":12867.41,"fecha":"2025-01-09","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞28505 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0099","concepto":"Assef","cat":"materiales","tipo":"variable","monto":11900.0,"fecha":"2025-01-09","resp":"Cecilia/Martin","medio":"efectivo","notas":"Factura n¬∞2921 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0100","concepto":"Pago factura Rossi","cat":"materiales","tipo":"variable","monto":870837.0,"fecha":"2025-01-09","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞66259 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0101","concepto":"Pago factura Flex Color","cat":"materiales","tipo":"variable","monto":703490.39,"fecha":"2025-01-09","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞185449 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0102","concepto":"Marketing","cat":"marketing","tipo":"variable","monto":200000.0,"fecha":"2025-01-10","resp":"Martin","medio":"transferencia","notas":"Publicidad y Marketing","creadoEn":"Importado desde planilla"},{"id":"imp-0103","concepto":"Assef","cat":"materiales","tipo":"variable","monto":2580.0,"fecha":"2025-01-10","resp":"Cecilia/Martin","medio":"efectivo","notas":"Factura n¬∞2922 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0104","concepto":"Caballero Virginia","cat":"materiales","tipo":"variable","monto":35701.56,"fecha":"2025-01-11","resp":"Cecilia/Martin","medio":"efectivo","notas":"Factura n¬∞9844 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0105","concepto":"Brumafra","cat":"proveedor","tipo":"variable","monto":75755.87,"fecha":"2025-01-12","resp":"Cecilia/Martin","medio":"efectivo","notas":"Factura n¬∞9438 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0106","concepto":"Caballero Virginia","cat":"materiales","tipo":"variable","monto":103210.0,"fecha":"2025-01-13","resp":"Cecilia/Martin","medio":"efectivo","notas":"Factura n¬∞9857 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0107","concepto":"Pinturerias Dip SRL","cat":"materiales","tipo":"variable","monto":28000.0,"fecha":"2025-01-14","resp":"Cecilia/Martin","medio":"efectivo","notas":"Factura n¬∞11233 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0108","concepto":"Chevalie Marcelo Pablo","cat":"materiales","tipo":"variable","monto":1249109.86,"fecha":"2025-01-14","resp":"Cecilia/Martin","medio":"transferencia","notas":"Factura n¬∞164 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0109","concepto":"Draco Equipamientos","cat":"materiales","tipo":"variable","monto":435600.0,"fecha":"2025-01-14","resp":"Cecilia","medio":"cheque","notas":"Factura n¬∞3552 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0110","concepto":"SQL","cat":"materiales","tipo":"variable","monto":167403.5,"fecha":"2025-01-15","resp":"Cecilia/Martin","medio":"cheque","notas":"Factura n¬∞6101 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0111","concepto":"Kevin Cruz","cat":"salario","tipo":"fijo","monto":472000.0,"fecha":"2025-01-15","resp":"Cecilia/Martin","medio":"transferencia","notas":"Sueldo 16/12/2024-14/01/2025 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0112","concepto":"Patricio Gonzalez","cat":"salario","tipo":"variable","monto":268000.0,"fecha":"2025-01-16","resp":"Cecilia","medio":"transferencia","notas":"Pago horas horas 30/12/24-16/01/25 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0113","concepto":"Equipo Jujuy","cat":"materiales","tipo":"variable","monto":57000.07,"fecha":"2025-01-16","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞5678 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0114","concepto":"Carolina Puertas","cat":"salario","tipo":"fijo","monto":799091.36,"fecha":"2025-01-16","resp":"Cecilia","medio":"transferencia","notas":"Sueldo 12/2024 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0115","concepto":"Barrientos Martin Maximiliano","cat":"materiales","tipo":"variable","monto":1000000.0,"fecha":"2025-01-16","resp":"Cecilia","medio":"transferencia","notas":"Fac n¬∞36 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0116","concepto":"Grevy SRL","cat":"materiales","tipo":"variable","monto":212627.25,"fecha":"2025-01-16","resp":"Cecilia","medio":"transferencia","notas":"Fac n¬∞45656 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0117","concepto":"Electromat","cat":"materiales","tipo":"variable","monto":8004.42,"fecha":"2025-01-16","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Fac n¬∞61408 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0118","concepto":"Full Color","cat":"materiales","tipo":"variable","monto":57000.07,"fecha":"2025-01-16","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞5678 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0119","concepto":"Pago factura Grevy SRL","cat":"materiales","tipo":"variable","monto":212627.25,"fecha":"2025-01-17","resp":"Cecilia","medio":"transferencia","notas":"Fac n¬∞45656 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0120","concepto":"Pago factura Rossi","cat":"materiales","tipo":"variable","monto":1974145.5,"fecha":"2025-01-17","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞66518/66488/66377/66364 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0121","concepto":"Agua Xibi Xibi","cat":"impuestos","tipo":"variable","monto":5000.0,"fecha":"2025-01-17","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞1267 | Administraci√≥n","creadoEn":"Importado desde planilla"},{"id":"imp-0122","concepto":"Rossi","cat":"materiales","tipo":"variable","monto":868296.0,"fecha":"2025-01-20","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞66923 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0123","concepto":"Grevy SRL","cat":"materiales","tipo":"variable","monto":28350.3,"fecha":"2025-01-20","resp":"Cecilia","medio":"transferencia","notas":"Fac n¬∞45701 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0124","concepto":"Rossi","cat":"materiales","tipo":"variable","monto":50781.89,"fecha":"2025-01-20","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞66935 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0125","concepto":"Pago factura Barrientos Martin Maximilano","cat":"materiales","tipo":"variable","monto":600000.0,"fecha":"2025-01-21","resp":"Cecilia","medio":"transferencia","notas":"Fac n¬∞36/37 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0126","concepto":"Pago factura Grevy SRL","cat":"materiales","tipo":"variable","monto":28350.3,"fecha":"2025-01-21","resp":"Cecilia","medio":"transferencia","notas":"Fac n¬∞45701 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0127","concepto":"Balbi e Hijos","cat":"otros","tipo":"variable","monto":77500.0,"fecha":"2025-01-22","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Fac n¬∞495 | Hogar","creadoEn":"Importado desde planilla"},{"id":"imp-0128","concepto":"SQL","cat":"materiales","tipo":"variable","monto":456424.1,"fecha":"2025-01-22","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞6109 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0129","concepto":"Duers","cat":"materiales","tipo":"variable","monto":184892.84,"fecha":"2025-01-23","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞219 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0130","concepto":"Rossi","cat":"materiales","tipo":"variable","monto":4617118.0,"fecha":"2025-01-23","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞67007 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0131","concepto":"A√±os Luz Horizonte","cat":"materiales","tipo":"variable","monto":9402.84,"fecha":"2025-01-24","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Fac n¬∞12464 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0132","concepto":"Hiperplaca","cat":"materiales","tipo":"variable","monto":57637.06,"fecha":"2025-01-24","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Fac n¬∞34030 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0133","concepto":"Leboso Claudio Gillermo","cat":"materiales","tipo":"variable","monto":244469.61,"fecha":"2025-01-24","resp":"Cecilia","medio":"transferencia","notas":"Fac n¬∞823 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0134","concepto":"Porcenot","cat":"materiales","tipo":"variable","monto":88000.0,"fecha":"2025-01-24","resp":"Cecilia","medio":"transferencia","notas":"Placa Jorge Abraham | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0135","concepto":"Pago factura Gabriel Fernandez","cat":"materiales","tipo":"variable","monto":598175.6,"fecha":"2025-01-26","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞667/729 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0136","concepto":"Dabra","cat":"otros","tipo":"variable","monto":69899.0,"fecha":"2025-01-27","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Fac n¬∞359 | Hogar","creadoEn":"Importado desde planilla"},{"id":"imp-0137","concepto":"Grupo Ilhsa SA","cat":"otros","tipo":"variable","monto":27299.0,"fecha":"2025-01-27","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Fac n¬∞14876 | Hogar","creadoEn":"Importado desde planilla"},{"id":"imp-0138","concepto":"Expreso Rivadavia","cat":"proveedor","tipo":"variable","monto":363325.98,"fecha":"2025-01-27","resp":"Cecilia","medio":"transferencia","notas":"Fac n¬∞498567 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0139","concepto":"Hause Mobel","cat":"materiales","tipo":"variable","monto":1109453.16,"fecha":"2025-01-27","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8826 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0140","concepto":"Hause Mobel","cat":"materiales","tipo":"variable","monto":18391637.6,"fecha":"2025-01-27","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8827 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0141","concepto":"Pago factura de alquiler","cat":"impuestos","tipo":"fijo","monto":1191850.0,"fecha":"2025-01-27","resp":"Cecilia","medio":"transferencia","notas":"Administraci√≥n","creadoEn":"Importado desde planilla"},{"id":"imp-0142","concepto":"Pinturerias Dip SRL","cat":"materiales","tipo":"variable","monto":26000.0,"fecha":"2025-01-29","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞11299 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0143","concepto":"Via cargo","cat":"proveedor","tipo":"variable","monto":39289.99,"fecha":"2025-01-29","resp":"Cecilia","medio":"efectivo","notas":"Fac n¬∞25078198 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0144","concepto":"Pago factura Hause Mobel","cat":"materiales","tipo":"variable","monto":369817.72,"fecha":"2025-01-30","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8826 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0145","concepto":"Maderera Denis","cat":"materiales","tipo":"variable","monto":24330.0,"fecha":"2025-01-30","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞33 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0146","concepto":"Electromat","cat":"materiales","tipo":"variable","monto":76026.53,"fecha":"2025-01-30","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Fac n¬∞9835 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0147","concepto":"A√±os Luz Horizonte","cat":"materiales","tipo":"variable","monto":2472.04,"fecha":"2025-01-30","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞12496 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0148","concepto":"Kilowatt","cat":"materiales","tipo":"variable","monto":44529.96,"fecha":"2025-01-30","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞5757 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0149","concepto":"Draco Equipamientos","cat":"materiales","tipo":"variable","monto":974655.0,"fecha":"2025-01-31","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞826 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0150","concepto":"Caballero Virginia","cat":"materiales","tipo":"variable","monto":2330.0,"fecha":"2025-01-31","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞10116 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0151","concepto":"Patricio Gonzalez","cat":"salario","tipo":"variable","monto":317200.0,"fecha":"2025-02-01","resp":"Martin","medio":"transferencia","notas":"Pago horas horas 17/01/25-31/01/25 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0152","concepto":"Limsa","cat":"servicios","tipo":"variable","monto":62108.55,"fecha":"2025-02-01","resp":"Cecilia/Martin","medio":"transferencia","notas":"Fac n¬∞63847 | Servicios","creadoEn":"Importado desde planilla"},{"id":"imp-0153","concepto":"Luis A Carrizo y Cia SRL","cat":"proveedor","tipo":"variable","monto":50020.01,"fecha":"2025-02-02","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞11341 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0154","concepto":"El establo Jujuy","cat":"materiales","tipo":"variable","monto":24000.0,"fecha":"2025-02-03","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞4901 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0155","concepto":"Municipalidad de San Salvador de Jujuy","cat":"impuestos","tipo":"variable","monto":5000.0,"fecha":"2025-02-03","resp":"Cecilia","medio":"efectivo","notas":"Fac n¬∞8537/2025 | Administraci√≥n","creadoEn":"Importado desde planilla"},{"id":"imp-0156","concepto":"Pago factura Naturgy Noa","cat":"servicios","tipo":"variable","monto":131138.61,"fecha":"2025-02-03","resp":"Cecilia","medio":"tarjeta","notas":"524312 | Servicios","creadoEn":"Importado desde planilla"},{"id":"imp-0157","concepto":"Caballero Virginia","cat":"materiales","tipo":"variable","monto":3418.42,"fecha":"2025-02-04","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞10154 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0158","concepto":"Hause Mobel","cat":"materiales","tipo":"variable","monto":1441616.23,"fecha":"2025-02-04","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8847 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0159","concepto":"Hause Mobel","cat":"materiales","tipo":"variable","monto":1920723.73,"fecha":"2025-02-04","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8848 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0160","concepto":"Hause Mobel","cat":"materiales","tipo":"variable","monto":18232802.8,"fecha":"2025-02-05","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8849 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0161","concepto":"Pago factura SQL","cat":"materiales","tipo":"variable","monto":1193403.64,"fecha":"2025-02-05","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞6089/6101 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0162","concepto":"Pago factura Hause Mobel","cat":"materiales","tipo":"variable","monto":640241.24,"fecha":"2025-02-06","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8848 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0163","concepto":"Flex Color","cat":"materiales","tipo":"variable","monto":152184.71,"fecha":"2025-02-06","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞187763 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0164","concepto":"Electromat","cat":"materiales","tipo":"variable","monto":40785.41,"fecha":"2025-02-07","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Fac n¬∞9879 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0165","concepto":"Grupo Ilhsa SA","cat":"otros","tipo":"variable","monto":30949.0,"fecha":"2025-02-07","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Fac n¬∞24466 | Hogar","creadoEn":"Importado desde planilla"},{"id":"imp-0166","concepto":"Gnc Sigma SRL","cat":"proveedor","tipo":"variable","monto":50000.0,"fecha":"2025-02-07","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞46226 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0167","concepto":"Duers","cat":"materiales","tipo":"variable","monto":18448.27,"fecha":"2025-02-07","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞245 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0168","concepto":"Duers","cat":"materiales","tipo":"variable","monto":13155.44,"fecha":"2025-02-07","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞246 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0169","concepto":"Rossi","cat":"materiales","tipo":"variable","monto":277302.96,"fecha":"2025-02-07","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞67313 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0170","concepto":"Brumafra","cat":"proveedor","tipo":"variable","monto":50000.0,"fecha":"2025-02-08","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞3306 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0171","concepto":"Pago factura Rossi","cat":"materiales","tipo":"variable","monto":868296.0,"fecha":"2025-02-08","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞66923 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0172","concepto":"Marketing","cat":"marketing","tipo":"variable","monto":200000.0,"fecha":"2025-02-10","resp":"Martin","medio":"transferencia","notas":"Publicidad y Marketing","creadoEn":"Importado desde planilla"},{"id":"imp-0173","concepto":"Pago factura Rossi","cat":"materiales","tipo":"variable","monto":50781.89,"fecha":"2025-02-10","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞66935 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0174","concepto":"Toba SRL","cat":"materiales","tipo":"variable","monto":12430.49,"fecha":"2025-02-10","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞10266 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0175","concepto":"Caballero Virginia","cat":"materiales","tipo":"variable","monto":23654.2,"fecha":"2025-02-10","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Fac n¬∞10226 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0176","concepto":"Electromat","cat":"materiales","tipo":"variable","monto":13191.75,"fecha":"2025-02-10","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Fac n¬∞9884 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0177","concepto":"Caballero Virginia","cat":"materiales","tipo":"variable","monto":35701.56,"fecha":"2025-02-11","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞9844 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0178","concepto":"Comodin","cat":"materiales","tipo":"variable","monto":5354.98,"fecha":"2025-02-11","resp":"Cecilia/Martin","medio":"efectivo","notas":"Fac n¬∞184992 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0179","concepto":"Via cargo","cat":"proveedor","tipo":"variable","monto":13770.01,"fecha":"2025-02-11","resp":"Cecilia","medio":"efectivo","notas":"Fac n¬∞16903 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0180","concepto":"New Byte","cat":"materiales","tipo":"variable","monto":240353.0,"fecha":"2025-02-12","resp":"Martin","medio":"transferencia","notas":"Pedido n¬∞0002 - 10391512 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0181","concepto":"Pago factura Rossi","cat":"materiales","tipo":"variable","monto":4617118.0,"fecha":"2025-02-12","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞67007 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0182","concepto":"Chevalie Marcelo Pablo","cat":"materiales","tipo":"variable","monto":4000.0,"fecha":"2025-02-12","resp":"Cecilia","medio":"efectivo","notas":"Fac n¬∞126594 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0183","concepto":"Assef","cat":"materiales","tipo":"variable","monto":400.45,"fecha":"2025-02-12","resp":"Cecilia/Martin","medio":"efectivo","notas":"Presupuesto n¬∞802150157 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0184","concepto":"Brisa Fernandez","cat":"salario","tipo":"fijo","monto":366805.89,"fecha":"2025-02-12","resp":"Cecilia","medio":"transferencia","notas":"Sueldo 01/2025 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0185","concepto":"Carolina Puertas","cat":"salario","tipo":"fijo","monto":476711.65,"fecha":"2025-02-12","resp":"Cecilia","medio":"transferencia","notas":"Sueldo 01/2025 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0186","concepto":"Condor√≠ Irene Margarita","cat":"salario","tipo":"fijo","monto":263182.88,"fecha":"2025-02-12","resp":"Cecilia","medio":"efectivo","notas":"Sueldo 01/2025 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0187","concepto":"Colorshop","cat":"materiales","tipo":"variable","monto":186634.89,"fecha":"2025-02-12","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Fac n¬∞3324 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0188","concepto":"Libreria san Pablo","cat":"materiales","tipo":"variable","monto":2100.0,"fecha":"2025-02-13","resp":"Cecilia","medio":"efectivo","notas":"Fac n¬∞55316 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0189","concepto":"Hause Mobel","cat":"materiales","tipo":"variable","monto":1441616.23,"fecha":"2025-02-13","resp":"Cecilia","medio":"tarjeta","notas":"Fac n¬∞8847 - Nc n¬∞1802 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0190","concepto":"Hause Mobel","cat":"materiales","tipo":"variable","monto":798583.31,"fecha":"2025-02-13","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8855 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0191","concepto":"Barrientos Martin Maximiliano","cat":"materiales","tipo":"variable","monto":240000.0,"fecha":"2025-02-14","resp":"Cecilia","medio":"transferencia","notas":"Fac n¬∞37 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0192","concepto":"Pago factura Hause Mobel","cat":"materiales","tipo":"variable","monto":4597909.4,"fecha":"2025-02-14","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8827 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0193","concepto":"Gabriel Fernandez","cat":"materiales","tipo":"variable","monto":1026118.72,"fecha":"2025-02-14","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞840 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0194","concepto":"Duers","cat":"materiales","tipo":"variable","monto":694737.84,"fecha":"2025-02-17","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞257 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0195","concepto":"Flex Color","cat":"materiales","tipo":"variable","monto":90968.62,"fecha":"2025-02-17","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞188383 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0196","concepto":"Kilowatt","cat":"materiales","tipo":"variable","monto":35588.22,"fecha":"2025-02-17","resp":"Cecilia/Martin","medio":"tarjeta","notas":"Fac n¬∞5971 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0197","concepto":"Pago Factura Leboso Claudio Gillermo","cat":"materiales","tipo":"variable","monto":244469.61,"fecha":"2025-02-21","resp":"Cecilia","medio":"transferencia","notas":"Fac n¬∞823 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0198","concepto":"Duers","cat":"materiales","tipo":"variable","monto":179495.64,"fecha":"2025-02-19","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞263 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0199","concepto":"Pago factura Barrientos Martin Maximilano","cat":"materiales","tipo":"variable","monto":640000.0,"fecha":"2025-02-20","resp":"Cecilia","medio":"transferencia","notas":"Fac n¬∞36/37 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0200","concepto":"Pago factura SQL","cat":"materiales","tipo":"variable","monto":456424.1,"fecha":"2025-02-21","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞6109 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0201","concepto":"Pago factura Flex Color","cat":"materiales","tipo":"variable","monto":1388790.99,"fecha":"2025-02-21","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞187383 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0202","concepto":"Pago factura Flex Color","cat":"materiales","tipo":"variable","monto":249626.55,"fecha":"2025-02-22","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞187763/188383 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0203","concepto":"Brumafra","cat":"proveedor","tipo":"variable","monto":50000.0,"fecha":"2025-02-24","resp":"Martin","medio":"efectivo","notas":"Fac n¬∞9683 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0204","concepto":"Pago de arreglo","cat":"servicios","tipo":"variable","monto":40000.0,"fecha":"2025-02-25","resp":"Martin","medio":"efectivo","notas":"Taller mec√°nico | Mantenimiento","creadoEn":"Importado desde planilla"},{"id":"imp-0205","concepto":"Pago factura Rossi","cat":"materiales","tipo":"variable","monto":277302.96,"fecha":"2025-02-27","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞67313 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0206","concepto":"Rossi","cat":"materiales","tipo":"variable","monto":485210.0,"fecha":"2025-02-27","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞67651 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0207","concepto":"Kevin Cruz","cat":"salario","tipo":"variable","monto":388000.0,"fecha":"2025-02-28","resp":"Cecilia","medio":"transferencia","notas":"Suledo 15/01/2025-15/02/2025 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0208","concepto":"Kevin Cruz","cat":"salario","tipo":"variable","monto":200000.0,"fecha":"2025-02-28","resp":"Cecilia","medio":"efectivo","notas":"Suledo 15/01/2025-15/02/2025 | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0209","concepto":"Pago factura Hause Mobel","cat":"materiales","tipo":"variable","monto":369817.72,"fecha":"2025-03-01","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8826 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0210","concepto":"Pago factura Hause Mobel","cat":"materiales","tipo":"variable","monto":640241.24,"fecha":"2025-03-04","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8848 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0211","concepto":"Pago factura Duers","cat":"materiales","tipo":"variable","monto":694737.84,"fecha":"2025-03-05","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞6257 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0212","concepto":"Duers","cat":"materiales","tipo":"variable","monto":18448.27,"fecha":"2025-03-05","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞279 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0213","concepto":"Flex Color","cat":"materiales","tipo":"variable","monto":129140.55,"fecha":"2025-03-06","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞189132 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0214","concepto":"Marketing","cat":"marketing","tipo":"variable","monto":300000.0,"fecha":"2025-03-08","resp":"Martin","medio":"transferencia","notas":"Publicidad y Marketing","creadoEn":"Importado desde planilla"},{"id":"imp-0215","concepto":"Pago factura Draco Equipamientos","cat":"materiales","tipo":"variable","monto":487327.5,"fecha":"2025-03-12","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞826 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0216","concepto":"Pago factura Draco Equipamientos","cat":"materiales","tipo":"variable","monto":435600.0,"fecha":"2025-03-13","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞3552 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0217","concepto":"Pago factura Hause Mobel","cat":"materiales","tipo":"variable","monto":4597909.4,"fecha":"2025-03-17","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8827 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0218","concepto":"Pago factura Duers","cat":"materiales","tipo":"variable","monto":514392.19,"fecha":"2025-03-19","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞263/246/245/219 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0219","concepto":"Pago factura Draco Equipamientos","cat":"materiales","tipo":"variable","monto":487328.5,"fecha":"2025-03-21","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞826 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0220","concepto":"Pago factura Hause Mobel","cat":"materiales","tipo":"variable","monto":369817.72,"fecha":"2025-03-31","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8826 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0221","concepto":"Pago factura Hause Mobel","cat":"materiales","tipo":"variable","monto":640241.24,"fecha":"2025-04-04","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8848 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0222","concepto":"Pago factura Hause Mobel","cat":"materiales","tipo":"variable","monto":4597909.4,"fecha":"2025-04-17","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8827 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0223","concepto":"mERCEDES","cat":"salario","tipo":"variable","monto":100000.0,"fecha":"2025-05-02","resp":"Cecilia","medio":"transferencia","notas":"Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0224","concepto":"ELECTROMAT NEORED","cat":"materiales","tipo":"variable","monto":57535.29,"fecha":"2025-05-06","resp":"Cecilia","medio":"transferencia","notas":"FAC N¬∞15-10360 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0225","concepto":"pATRicio Gonzalez","cat":"salario","tipo":"variable","monto":75000.0,"fecha":"2025-05-09","resp":"Cecilia","medio":"transferencia","notas":"Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0226","concepto":"Pago factura Hause Mobel","cat":"materiales","tipo":"variable","monto":4597909.4,"fecha":"2025-05-17","resp":"Cecilia","medio":"cheque","notas":"Fac n¬∞8827 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0227","concepto":"Libreria san Pablo","cat":"materiales","tipo":"variable","monto":29310.0,"fecha":"2025-05-14","resp":"Cecilia","medio":"efectivo","notas":"Fac n¬∞70-94045 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0228","concepto":"servicio de plomeria","cat":"servicios","tipo":"variable","monto":12700.0,"fecha":"2025-05-14","resp":"Martin","medio":"transferencia","notas":"- | Mantenimiento","creadoEn":"Importado desde planilla"},{"id":"imp-0229","concepto":"Kevin Cruz","cat":"salario","tipo":"fijo","monto":388000.0,"fecha":"2025-05-19","resp":"Cecilia","medio":"transferencia","notas":"sUELDO ABRIL | Personal","creadoEn":"Importado desde planilla"},{"id":"imp-0230","concepto":"BRUMAFRA","cat":"proveedor","tipo":"variable","monto":388000.0,"fecha":"2025-05-19","resp":"Cecilia","medio":"efectivo","notas":"FAN N¬∞0056-00004078 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0231","concepto":"ELECTRO MAT","cat":"materiales","tipo":"variable","monto":41166.66,"fecha":"2025-05-22","resp":"Cecilia","medio":"transferencia","notas":"FAC N¬∞0015-00010459 | Materiales","creadoEn":"Importado desde planilla"},{"id":"imp-0232","concepto":"CIEL S.A","cat":"proveedor","tipo":"variable","monto":66115.0,"fecha":"2025-05-22","resp":"Martin","medio":"transferencia","notas":"FAC N¬∞29-16874 | Log√≠stica","creadoEn":"Importado desde planilla"},{"id":"imp-0233","concepto":"CYC Materiales","cat":"materiales","tipo":"variable","monto":11647.16,"fecha":"2025-08-16","resp":"Martin","medio":"efectivo","notas":"FAC N¬∞0011-00012721 | Materiales","creadoEn":"Importado desde planilla"}];
  // Importar solo si el sistema no tiene gastos propios a√∫n
  if(DB.gastos.length === 0) {
    DB.gastos = GASTOS_PLANILLA;
    console.log('‚úÖ Gastos importados desde planilla:', DB.gastos.length);
  } else if(!DB._planillaImportada) {
    // Agregar los que no existan (por descripci√≥n+fecha+monto)
    let agregados = 0;
    GASTOS_PLANILLA.forEach(g => {
      const existe = DB.gastos.find(x => x.fecha===g.fecha && x.concepto===g.concepto && x.monto===g.monto);
      if(!existe){ DB.gastos.push(g); agregados++; }
    });
    if(agregados > 0) console.log('‚úÖ Gastos nuevos de planilla agregados:', agregados);
  }
  DB._planillaImportada = true;

  const ADMIN_MODS = ['dashboard','leads','ventas','gestion','diseno','presupuestos','contable','administracion','financiero','usuarios'];

  // Asegurar admin por defecto si no existe ning√∫n usuario
  if(DB.usuarios.length===0){
    DB.usuarios.push({id:'u-admin',nombre:'Admin Sistema',email:'admin@forma.com',
      passHash:btoa('admin1234'),status:'activo',rol:'admin',nota:'',
      modulos:ADMIN_MODS.slice(), creadoEn:hoy()});
    guardar();
  } else {
    // Migraci√≥n: admins existentes reciben los m√≥dulos nuevos autom√°ticamente
    let dirty = false;
    DB.usuarios.forEach(u => {
      if(u.rol==='admin' || (u.modulos||[]).includes('usuarios')) {
        ADMIN_MODS.forEach(m => {
          if(!u.modulos.includes(m)){ u.modulos.push(m); dirty=true; }
        });
      }
    });
    if(dirty) guardar();
  }
}
function guardar() { localStorage.setItem(DB_KEY, JSON.stringify(DB)); }
function hoy()  { return new Date().toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'}); }
function ahora(){ return new Date().toLocaleString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}); }
function fiDate(){ return new Date().toISOString().split('T')[0]; }
function nid()  { return Date.now().toString(36)+Math.random().toString(36).slice(2,5); }
function v(id)  { return (document.getElementById(id)||{}).value?.trim()||''; }
function pesos(n){ return '$'+Math.round(n||0).toLocaleString('es-AR'); }
function pct(n)  { return (((n||0)*100).toFixed(1))+'%'; }

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function go(mod) {
  // Verificar permiso
  if(CURRENT_USER && mod!=='usuarios' && !CURRENT_USER.modulos.includes(mod)){
    const primer = CURRENT_USER.modulos.find(m=>m!=='usuarios')||'dashboard';
    mod = primer;
  }
  modulo=mod;
  document.querySelectorAll('.sb-item').forEach(el=>el.classList.remove('active'));
  const n=document.getElementById('nav-'+mod); if(n) n.classList.add('active');
  document.getElementById('topbar-actions').innerHTML='';
  document.getElementById('search-q').value=''; searchQ='';
  const r={dashboard,ventas,leads,gestion,diseno,presupuestos,contable,usuarios,administracion,financiero};
  if(r[mod]) r[mod]();
}
function buscar(q){ searchQ=q.toLowerCase(); go(modulo); }
function abrir(id){ document.getElementById(id).classList.add('open'); }
function cerrar(id){ document.getElementById(id).classList.remove('open'); }
function actions(html){ document.getElementById('topbar-actions').innerHTML=html; }
function titulo(t){ document.getElementById('topbar-title').textContent=t; }
function c(html){ document.getElementById('content').innerHTML=html; }

// ‚ïê‚ïê DASHBOARD ‚ïê‚ïê
function dashboard() {
  titulo('Dashboard');
  const lA=DB.leads.length, pA=DB.proyectos.filter(p=>!['cancelado','aprobado'].includes(p.status)).length;
  const pptoEnv=DB.presupuestos.filter(p=>p.status==='enviado').length;
  const pptoApr=DB.presupuestos.filter(p=>p.status==='aprobado');
  const totalApr=pptoApr.reduce((s,p)=>s+(p.totalFinal||0),0);
  const cobradoTotal=DB.cobros.reduce((s,c)=>s+(parseFloat(c.monto)||0),0);
  const pendienteCobro=totalApr - cobradoTotal;

  // Alertas
  const alertas=[];
  DB.presupuestos.filter(p=>p.status==='enviado').forEach(p=>{
    const d=new Date(p.fecha); const hoyD=new Date();
    const dias=Math.floor((hoyD-d)/(1000*60*60*24));
    if(dias>15) alertas.push({tipo:'amber',msg:`Ppto ${p.numero} enviado hace ${dias} d√≠as sin respuesta ‚Äî ${p.cliente}`});
  });
  DB.cobros.filter(c=>c.vence && new Date(c.vence)<new Date() && !c.cobrado).forEach(c=>{
    alertas.push({tipo:'red',msg:`Cobro vencido: ${pesos(c.monto)} ‚Äî ${c.concepto}`});
  });

  c(`
  <div class="stats-row">
    <div class="stat-card"><div class="stat-icon" style="background:var(--accent-lt);color:var(--accent)"><i class="fa fa-funnel-dollar"></i></div><div class="stat-label">Leads activos</div><div class="stat-value">${lA}</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--teal-lt);color:var(--teal)"><i class="fa fa-project-diagram"></i></div><div class="stat-label">Proyectos activos</div><div class="stat-value">${pA}</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--amber-lt);color:var(--amber)"><i class="fa fa-file-invoice-dollar"></i></div><div class="stat-label">Ppto. enviados</div><div class="stat-value">${pptoEnv}</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--green-lt);color:var(--green)"><i class="fa fa-coins"></i></div><div class="stat-label">Facturado aprobado</div><div class="stat-value" style="font-size:18px">${pesos(totalApr)}</div></div>
    <div class="stat-card" onclick="abrirPopupPorCobrar()" style="cursor:pointer;border-color:var(--red);transition:.15s" title="Ver detalle de cobros pendientes"><div class="stat-icon" style="background:var(--red-lt);color:var(--red)"><i class="fa fa-clock"></i></div><div class="stat-label" style="color:var(--red)">Por cobrar <i class="fa fa-external-link-alt" style="font-size:9px;margin-left:4px"></i></div><div class="stat-value" style="font-size:18px;color:var(--red)">${pesos(pendienteCobro)}</div><div style="font-size:10px;color:var(--ink3);margin-top:4px">Click para ver detalle</div></div>
  </div>
  ${alertas.length?`<div style="margin-bottom:20px">${alertas.map(a=>`
    <div class="alerta-row" style="background:var(--${a.tipo}-lt);border:1px solid var(--${a.tipo});color:var(--${a.tipo})">
      <i class="fa fa-exclamation-triangle"></i><span>${a.msg}</span>
    </div>`).join('')}</div>`:''}
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
    <div class="tbl-wrap">
      <div style="padding:14px 18px;border-bottom:1px solid var(--border);font-size:12px;font-weight:700">√öltimos presupuestos</div>
      <table><thead><tr><th>N¬∞</th><th>Cliente</th><th>Total</th><th>Estado</th></tr></thead><tbody>
      ${DB.presupuestos.slice(-5).reverse().map(p=>`<tr onclick="editarPpto('${p.id}')">
        <td style="font-weight:700">${p.numero}</td><td>${p.cliente}</td>
        <td style="font-weight:600;color:var(--green)">${pesos(p.totalFinal)}</td>
        <td>${bPptoStatus(p.status)}</td></tr>`).join('')||
        '<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--ink4)">Sin presupuestos</td></tr>'}
      </tbody></table>
    </div>
    <div class="tbl-wrap">
      <div style="padding:14px 18px;border-bottom:1px solid var(--border);font-size:12px;font-weight:700">Proyectos activos</div>
      <table><thead><tr><th>Proyecto</th><th>√Årea</th><th>Estado</th></tr></thead><tbody>
      ${DB.proyectos.filter(p=>p.status!=='cancelado').slice(-5).reverse().map(p=>`<tr onclick="verProyecto('${p.id}')">
        <td><div style="font-weight:600;font-size:12px">${p.nom}</div><div style="font-size:11px;color:var(--ink3)">${p.cli}</div></td>
        <td>${bArea(p.area)}</td><td>${bStatus(p.status)}</td></tr>`).join('')||
        '<tr><td colspan="3" style="text-align:center;padding:20px;color:var(--ink4)">Sin proyectos</td></tr>'}
      </tbody></table>
    </div>
  </div>`);
}

// ‚ïê‚ïê VENTAS ‚ïê‚ïê
function ventas() {
  titulo('Ventas ‚Äî Pipeline');
  actions(`<button class="btn btn-primary" onclick="nuevoLead()"><i class="fa fa-plus"></i> Nuevo Lead</button>`);
  const etapas=['Pendiente','Contactado','Visita Agendada','En seguimiento','Cerrado'];
  const items=DB.leads.filter(l=>!searchQ||(l.nom+l.ape+l.emp).toLowerCase().includes(searchQ));
  c(`<div class="pipeline">${etapas.map(et=>{
    const cols=items.filter(l=>l.status===et);
    return `<div class="p-col"><div class="p-head">${et}<span class="p-count">${cols.length}</span></div>
      ${cols.map(l=>`<div class="p-card" onclick="verLead('${l.id}')">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px"><div class="p-cname">${l.nom} ${l.ape}</div>${score(l.score)}</div>
        <div class="p-cmeta">${l.emp||'‚Äî'}</div><div class="p-cmeta">${l.cat} ¬∑ ${l.tipo}</div>
        ${l.ppto?`<div class="p-cmeta" style="font-weight:600;color:var(--green);margin-top:4px">${pesos(l.ppto)}</div>`:''}
      </div>`).join('')}</div>`;}).join('')}</div>`);
}

// ‚ïê‚ïê LEADS ‚ïê‚ïê
function leads() {
  titulo('Leads ‚Äî Base de datos');
  actions(`<button class="btn btn-primary" onclick="nuevoLead()"><i class="fa fa-plus"></i> Nuevo Lead</button>`);
  const items=DB.leads.filter(l=>!searchQ||(l.nom+l.ape+l.emp).toLowerCase().includes(searchQ));
  c(`<div class="tbl-wrap"><table>
    <thead><tr><th>Nombre</th><th>Empresa</th><th>Origen</th><th>Categor√≠a</th><th>Score</th><th>Estado</th><th></th></tr></thead>
    <tbody>${items.map(l=>`<tr onclick="verLead('${l.id}')">
      <td><div style="font-weight:600">${l.nom} ${l.ape}</div><div style="font-size:11px;color:var(--ink3)">${l.tel||''}</div></td>
      <td>${l.emp||'‚Äî'}</td><td><span class="badge b-gray">${l.origen}</span></td>
      <td>${l.cat} ¬∑ ${l.tipo}</td><td>${score(l.score)}</td>
      <td><span class="badge ${bStatusLead(l.status)}">${l.status}</span></td>
      <td onclick="event.stopPropagation()"><button class="btn btn-secondary btn-sm" onclick="editarLead('${l.id}')"><i class="fa fa-edit"></i></button></td>
    </tr>`).join('')||'<tr><td colspan="7" style="text-align:center;padding:28px;color:var(--ink4)">Sin leads.</td></tr>'}
    </tbody></table></div>`);
}

// ‚ïê‚ïê GESTI√ìN ‚ïê‚ïê
function gestion() {
  titulo('Gesti√≥n de Proyectos');
  actions(`<button class="btn btn-primary" onclick="nuevoProyecto()"><i class="fa fa-plus"></i> Nuevo Proyecto</button>`);
  const items=DB.proyectos.filter(p=>!searchQ||(p.nom+p.cli+p.emp).toLowerCase().includes(searchQ));
  c(items.length?`<div class="cards-grid">${items.map(proyCard).join('')}</div>`:
    `<div class="empty"><i class="fa fa-project-diagram"></i><p>Sin proyectos.</p></div>`);
}

function proyCard(p) {
  const ppts=DB.presupuestos.filter(x=>x.proyId===p.id);
  return `<div class="card" onclick="verProyecto('${p.id}')">
    <div class="card-top">${bStatus(p.status)}${bArea(p.area)}</div>
    <div class="card-name">${p.nom}</div>
    <div class="card-sub">${p.cli}${p.emp?' ¬∑ '+p.emp:''}</div>
    <div class="card-info">
      <div class="card-row"><i class="fa fa-tag"></i>${p.cat} ¬∑ ${p.tipo}</div>
      ${p.fecha?`<div class="card-row"><i class="fa fa-calendar"></i>L√≠mite: ${p.fecha}</div>`:''}
      ${ppts.length?`<div class="card-row"><i class="fa fa-file-invoice-dollar"></i>${ppts.length} presupuesto(s)</div>`:''}
    </div>
    <div class="card-foot"><span style="font-size:10px;color:var(--ink4)">${p.creadoEn||''}</span>
      <div style="display:flex;gap:6px">
        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();editarProyecto('${p.id}')"><i class="fa fa-edit"></i></button>
        <button class="btn btn-accent btn-sm" onclick="event.stopPropagation();nuevoPptoParaProy('${p.id}')"><i class="fa fa-file-invoice-dollar"></i> Ppto.</button>
      </div>
    </div>
  </div>`;
}

// ‚ïê‚ïê DISE√ëO ‚ïê‚ïê
function diseno() {
  titulo('Dise√±o ‚Äî Solicitudes');
  actions(`<button class="btn btn-primary" onclick="nuevaSolicitud()"><i class="fa fa-plus"></i> Nueva Solicitud</button>`);
  const items=DB.solicitudes.filter(s=>!searchQ||(s.brief||'').toLowerCase().includes(searchQ)||getProy(s.proyId)?.nom?.toLowerCase().includes(searchQ));
  c(items.length?`<div class="cards-grid">${items.map(s=>{
    const p=getProy(s.proyId);
    return `<div class="card" onclick="verSolicitud('${s.id}')">
      <div class="card-top"><span class="badge ${bStatusDis(s.status)}">${s.status}</span><span class="badge b-purple">${s.tipo}</span></div>
      <div class="card-name">${p?.nom||'Sin proyecto'}</div><div class="card-sub">${p?.cli||''}</div>
      <div class="card-info">
        <div class="card-row"><i class="fa fa-align-left"></i>${(s.brief||'').slice(0,55)}</div>
        ${s.fecha?`<div class="card-row"><i class="fa fa-calendar"></i>Entrega: ${s.fecha}</div>`:''}
      </div></div>`;}).join('')}`:
    `<div class="empty"><i class="fa fa-pen-nib"></i><p>Sin solicitudes.</p></div>`);
}

// ‚ïê‚ïê PRESUPUESTOS ‚ïê‚ïê
function presupuestos() {
  titulo('Presupuestos');
  actions(`<button class="btn btn-primary" onclick="nuevoPpto()"><i class="fa fa-plus"></i> Nuevo Presupuesto</button>`);
  const items=DB.presupuestos.filter(p=>!searchQ||(p.cliente+p.numero+(p.proyNom||'')).toLowerCase().includes(searchQ));

  // Totales por estado
  const tot={borrador:0,enviado:0,aprobado:0,rechazado:0};
  DB.presupuestos.forEach(p=>{ if(tot[p.status]!==undefined) tot[p.status]+=p.totalFinal||0; });

  c(`
  <div class="stats-row" style="margin-bottom:20px">
    <div class="stat-card"><div class="stat-label">Borrador</div><div class="stat-value" style="font-size:18px">${DB.presupuestos.filter(p=>p.status==='borrador').length}</div><div class="stat-sub">${pesos(tot.borrador)}</div></div>
    <div class="stat-card"><div class="stat-label">Enviados</div><div class="stat-value" style="font-size:18px;color:var(--accent)">${DB.presupuestos.filter(p=>p.status==='enviado').length}</div><div class="stat-sub">${pesos(tot.enviado)}</div></div>
    <div class="stat-card"><div class="stat-label">Aprobados</div><div class="stat-value" style="font-size:18px;color:var(--green)">${DB.presupuestos.filter(p=>p.status==='aprobado').length}</div><div class="stat-sub">${pesos(tot.aprobado)}</div></div>
    <div class="stat-card"><div class="stat-label">Rechazados</div><div class="stat-value" style="font-size:18px;color:var(--red)">${DB.presupuestos.filter(p=>p.status==='rechazado').length}</div><div class="stat-sub">${pesos(tot.rechazado)}</div></div>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>N¬∞ Presupuesto</th><th>Cliente / Proyecto</th><th>Fecha</th><th>Factura</th><th>√çtems</th><th>Total Final</th><th>Ganancia %</th><th>Estado</th><th></th></tr></thead>
    <tbody>${items.length?items.map(p=>`<tr onclick="editarPpto('${p.id}')">
      <td><span style="font-weight:700;font-family:monospace;font-size:13px">${p.numero}</span></td>
      <td><div style="font-weight:600">${p.cliente}</div><div style="font-size:11px;color:var(--ink3)">${p.proyNom||''}</div></td>
      <td style="font-size:12px;color:var(--ink3)">${p.fecha||''}</td>
      <td><span class="badge b-gray">Fact. ${p.factura}</span></td>
      <td>${(p.items||[]).filter(i=>i.tipo==='item').length}</td>
      <td style="font-weight:700;color:var(--green)">${pesos(p.totalFinal)}</td>
      <td style="font-weight:700;color:${(p.gananciaPct||0)>0?'var(--green)':'var(--red)'}">${pct(p.gananciaPct)}</td>
      <td>${bPptoStatus(p.status)}</td>
      <td onclick="event.stopPropagation()" style="display:flex;gap:4px;padding:8px 6px">
        <button class="btn btn-secondary btn-sm" onclick="editarPpto('${p.id}')"><i class="fa fa-edit"></i></button>
        ${p.status!=='aprobado'?`<button class="btn btn-green btn-sm" onclick="aprobarPpto('${p.id}')"><i class="fa fa-check"></i></button>`:''}
      </td>
    </tr>`).join(''):'<tr><td colspan="9" style="text-align:center;padding:28px;color:var(--ink4)">Sin presupuestos. Cre√° el primero.</td></tr>'}
    </tbody></table></div>`);
}

// ‚ïê‚ïê CONTABLE ‚ïê‚ïê
function contable() {
  titulo('M√≥dulo Contable');
  actions(`<button class="btn btn-secondary" onclick="registrarCobro(null)"><i class="fa fa-plus"></i> Registrar cobro</button>`);

  const aprobados = DB.presupuestos.filter(p=>p.status==='aprobado');
  const totalFacturado = aprobados.reduce((s,p)=>s+(p.totalFinal||0),0);
  const totalCobrado = DB.cobros.reduce((s,c)=>s+(parseFloat(c.monto)||0),0);
  const totalPendiente = totalFacturado - totalCobrado;
  const ivaVentasAcum = aprobados.reduce((s,p)=>s+(p.ivaVentas||0),0);
  const ivaComprasAcum = aprobados.reduce((s,p)=>s+(p.ivaCompras||0),0);
  const ivaAPagar = ivaVentasAcum - ivaComprasAcum;
  const iibbAcum = aprobados.reduce((s,p)=>s+(p.iibbTotal||0),0);
  const gananciaAcum = aprobados.reduce((s,p)=>s+(p.margenTotal||0),0);

  c(`
  <div class="stats-row">
    <div class="stat-card"><div class="stat-icon" style="background:var(--green-lt);color:var(--green)"><i class="fa fa-check-circle"></i></div><div class="stat-label">Facturado (aprobados)</div><div class="stat-value" style="font-size:17px">${pesos(totalFacturado)}</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--accent-lt);color:var(--accent)"><i class="fa fa-hand-holding-usd"></i></div><div class="stat-label">Cobrado</div><div class="stat-value" style="font-size:17px;color:var(--green)">${pesos(totalCobrado)}</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--red-lt);color:var(--red)"><i class="fa fa-clock"></i></div><div class="stat-label">Por cobrar</div><div class="stat-value" style="font-size:17px;color:var(--red)">${pesos(totalPendiente)}</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--amber-lt);color:var(--amber)"><i class="fa fa-university"></i></div><div class="stat-label">IVA a pagar ARCA</div><div class="stat-value" style="font-size:17px;color:var(--amber)">${pesos(ivaAPagar)}</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--purple-lt);color:var(--purple)"><i class="fa fa-percentage"></i></div><div class="stat-label">IIBB acumulado</div><div class="stat-value" style="font-size:17px;color:var(--purple)">${pesos(iibbAcum)}</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--green-lt);color:var(--green)"><i class="fa fa-chart-line"></i></div><div class="stat-label">Ganancia total</div><div class="stat-value" style="font-size:17px;color:var(--green)">${pesos(gananciaAcum)}</div></div>
  </div>

  <!-- IVA ARCA detalle -->
  <div class="cont-card" style="margin-bottom:18px">
    <div style="font-size:13px;font-weight:700;margin-bottom:14px;display:flex;justify-content:space-between;align-items:center">
      <span>üìã Detalle IVA para ARCA</span>
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px">
      <div style="padding:12px;background:var(--red-lt);border-radius:var(--r);text-align:center">
        <div style="font-size:10px;color:var(--red);font-weight:700;text-transform:uppercase;margin-bottom:4px">IVA Ventas</div>
        <div style="font-size:18px;font-weight:800;color:var(--red)">${pesos(ivaVentasAcum)}</div>
        <div style="font-size:10px;color:var(--ink3);margin-top:2px">D√©bito fiscal</div>
      </div>
      <div style="padding:12px;background:var(--green-lt);border-radius:var(--r);text-align:center">
        <div style="font-size:10px;color:var(--green);font-weight:700;text-transform:uppercase;margin-bottom:4px">IVA Compras</div>
        <div style="font-size:18px;font-weight:800;color:var(--green)">${pesos(ivaComprasAcum)}</div>
        <div style="font-size:10px;color:var(--ink3);margin-top:2px">Cr√©dito fiscal</div>
      </div>
      <div style="padding:12px;background:var(--amber-lt);border-radius:var(--r);text-align:center">
        <div style="font-size:10px;color:var(--amber);font-weight:700;text-transform:uppercase;margin-bottom:4px">IVA a pagar</div>
        <div style="font-size:18px;font-weight:800;color:var(--amber)">${pesos(ivaAPagar)}</div>
        <div style="font-size:10px;color:var(--ink3);margin-top:2px">D√©bito - Cr√©dito</div>
      </div>
      <div style="padding:12px;background:var(--purple-lt);border-radius:var(--r);text-align:center">
        <div style="font-size:10px;color:var(--purple);font-weight:700;text-transform:uppercase;margin-bottom:4px">IIBB</div>
        <div style="font-size:18px;font-weight:800;color:var(--purple)">${pesos(iibbAcum)}</div>
        <div style="font-size:10px;color:var(--ink3);margin-top:2px">Ingresos Brutos 3.5%</div>
      </div>
    </div>
  </div>

  <!-- Buscador contable -->
  <div style="margin-bottom:18px;display:flex;align-items:center;gap:10px">
    <div style="position:relative;flex:1;max-width:360px">
      <i class="fa fa-search" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--ink4);font-size:12px"></i>
      <input type="text" id="cont-search" placeholder="Buscar proyecto o cliente..."
        oninput="filtrarContable(this.value)"
        style="width:100%;padding:8px 12px 8px 32px;border:1px solid var(--border);border-radius:var(--r);font-size:13px;background:var(--surface)">
    </div>
    <span style="font-size:11px;color:var(--ink3)" id="cont-search-count">${aprobados.length} proyecto(s)</span>
  </div>

  <!-- Seguimiento colapsable -->
  <div style="border:1px solid var(--border);border-radius:var(--r-lg);overflow:hidden;margin-bottom:14px">
    <div onclick="toggleSeccionCont('sec-seguimiento')"
      style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--surface);cursor:pointer;user-select:none">
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ink2)">Seguimiento por proyecto</span>
        <span class="badge b-gray">${aprobados.length}</span>
      </div>
      <i class="fa fa-chevron-down" id="sec-seguimiento-ico" style="color:var(--ink4);font-size:11px;transition:.25s"></i>
    </div>
    <div id="sec-seguimiento" style="padding:14px;border-top:1px solid var(--border)">
      <div id="cont-proyectos-list">
        ${aprobados.length ? aprobados.map(p=>contPrtoCard(p)).join('') :
          '<div class="empty"><i class="fa fa-coins"></i><p>No hay presupuestos aprobados a√∫n.</p></div>'}
      </div>
    </div>
  </div>

  <!-- Historial cobros colapsable -->
  ${DB.cobros.length ? `
  <div style="border:1px solid var(--border);border-radius:var(--r-lg);overflow:hidden;margin-bottom:14px">
    <div onclick="toggleSeccionCont('sec-historial')"
      style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--surface);cursor:pointer;user-select:none">
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ink2)">Historial de cobros</span>
        <span class="badge b-green">${DB.cobros.length}</span>
      </div>
      <i class="fa fa-chevron-down" id="sec-historial-ico" style="color:var(--ink4);font-size:11px;transition:.25s"></i>
    </div>
    <div id="sec-historial" style="display:none;border-top:1px solid var(--border)">
      <div class="tbl-wrap" style="border:none;border-radius:0"><table>
        <thead><tr><th>Fecha</th><th>Presupuesto</th><th>Concepto</th><th>Medio</th><th>Monto</th></tr></thead>
        <tbody>${DB.cobros.map(c=>{
          const pp=DB.presupuestos.find(x=>x.id===c.pptoId);
          return '<tr><td style="font-size:11px;color:var(--ink3)">'+c.fecha+'</td>'
            +'<td><div style="font-size:12px;font-weight:600">'+(pp?.numero||'‚Äî')+'</div>'
            +'<div style="font-size:11px;color:var(--ink3)">'+(pp?.cliente||'')+'</div></td>'
            +'<td>'+c.concepto+'</td>'
            +'<td><span class="badge b-gray">'+c.medio+'</span></td>'
            +'<td style="font-weight:700;color:var(--green)">'+pesos(c.monto)+'</td></tr>';
        }).join('')}
        </tbody>
      </table></div>
    </div>
  </div>` : ''}`);}


function contPrtoCard(p) {
  const cobros=DB.cobros.filter(c=>c.pptoId===p.id);
  const cobrado=cobros.reduce((s,c)=>s+(parseFloat(c.monto)||0),0);
  const pendiente=(p.totalFinal||0)-cobrado;
  const pctCobrado=p.totalFinal?Math.min(100,(cobrado/p.totalFinal)*100):0;
  return `<div class="cont-card">
    <div class="cont-header">
      <div>
        <div style="font-size:14px;font-weight:700">${p.numero} ‚Äî ${p.cliente}</div>
        <div style="font-size:11px;color:var(--ink3);margin-top:2px">${p.proyNom||''} ¬∑ Fact. ${p.factura} ¬∑ ${p.fecha}</div>
      </div>
      <button class="btn btn-accent btn-sm" onclick="registrarCobro('${p.id}')"><i class="fa fa-plus"></i> Cobro</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:14px">
      <div><div style="font-size:10px;color:var(--ink3);text-transform:uppercase;font-weight:700">Total</div><div style="font-size:14px;font-weight:700">${pesos(p.totalFinal)}</div></div>
      <div><div style="font-size:10px;color:var(--green);text-transform:uppercase;font-weight:700">Cobrado</div><div style="font-size:14px;font-weight:700;color:var(--green)">${pesos(cobrado)}</div></div>
      <div><div style="font-size:10px;color:var(--red);text-transform:uppercase;font-weight:700">Pendiente</div><div style="font-size:14px;font-weight:700;color:var(--red)">${pesos(pendiente)}</div></div>
      <div><div style="font-size:10px;color:var(--amber);text-transform:uppercase;font-weight:700">IVA a pagar</div><div style="font-size:14px;font-weight:700;color:var(--amber)">${pesos((p.ivaVentas||0)-(p.ivaCompras||0))}</div></div>
      <div><div style="font-size:10px;color:var(--purple);text-transform:uppercase;font-weight:700">Ganancia</div><div style="font-size:14px;font-weight:700;color:var(--purple)">${pesos(p.margenTotal)} <span style="font-size:11px">(${pct(p.gananciaPct)})</span></div></div>
    </div>
    <div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--ink3);margin-bottom:4px"><span>Cobrado: ${pct(pctCobrado/100)}</span><span>${pesos(cobrado)} / ${pesos(p.totalFinal)}</span></div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pctCobrado}%;background:${pctCobrado>=100?'var(--green)':pctCobrado>50?'var(--accent)':'var(--amber)'}"></div></div>
    </div>
    ${cobros.length?`<div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:6px">${cobros.map(co=>`
      <span style="padding:4px 10px;background:var(--green-lt);color:var(--green);border-radius:var(--r);font-size:11px;font-weight:600">
        <i class="fa fa-check"></i> ${co.fecha} ¬∑ ${pesos(co.monto)} ¬∑ ${co.concepto}</span>`).join('')}</div>`:''}
  </div>`;
}

// ‚ïê‚ïê PRESUPUESTO CRUD ‚ïê‚ïê
function nuevoPpto() {
  editPptoId=null; pptoItems=[];
  document.getElementById('m-ppto-title').textContent='Nuevo Presupuesto';
  DB.pptoCounter = (DB.pptoCounter||3829)+1;
  const num='P-'+String(DB.pptoCounter).padStart(4,'0');
  document.getElementById('m-ppto-num').textContent=num;
  document.getElementById('pp-fecha').value=fiDate();
  document.getElementById('pp-dto').value='0';
  document.getElementById('pp-notas').value='';
  document.getElementById('pp-cliente').value='';
  document.getElementById('pp-cuit').value='';
  document.getElementById('pp-status').value='borrador';
  document.getElementById('pp-factura').value='A';
  document.getElementById('ppto-delete-btn').style.display='none';
  llenarSelectProyectosPpto();
  renderPptoItems();
  recalcPpto();
  abrir('m-presupuesto');
}

function nuevoPptoParaProy(proyId) {
  nuevoPpto();
  setTimeout(()=>{
    document.getElementById('pp-proyecto').value=proyId;
    autoFillClientePpto();
  },80);
}

function editarPpto(id) {
  editPptoId=id;
  const p=DB.presupuestos.find(x=>x.id===id); if(!p) return;
  pptoItems=JSON.parse(JSON.stringify(p.items||[]));
  document.getElementById('m-ppto-title').textContent='Editar Presupuesto';
  document.getElementById('m-ppto-num').textContent=p.numero;
  document.getElementById('pp-fecha').value=p.fechaISO||fiDate();
  document.getElementById('pp-dto').value=p.dto||'0';
  document.getElementById('pp-notas').value=p.notas||'';
  document.getElementById('pp-cliente').value=p.cliente||'';
  document.getElementById('pp-cuit').value=p.cuit||'';
  document.getElementById('pp-status').value=p.status||'borrador';
  document.getElementById('pp-factura').value=p.factura||'A';
  document.getElementById('ppto-delete-btn').style.display='inline-flex';
  llenarSelectProyectosPpto();
  setTimeout(()=>{ document.getElementById('pp-proyecto').value=p.proyId||''; },80);
  renderPptoItems();
  recalcPpto();
  abrir('m-presupuesto');
}

function llenarSelectProyectosPpto() {
  const sel=document.getElementById('pp-proyecto');
  sel.innerHTML='<option value="">‚Äî Sin proyecto vinculado ‚Äî</option>'+
    DB.proyectos.map(p=>`<option value="${p.id}">${p.nom} (${p.cli})</option>`).join('');
}

function autoFillClientePpto() {
  const proyId=document.getElementById('pp-proyecto').value;
  const p=DB.proyectos.find(x=>x.id===proyId);
  if(p){
    document.getElementById('pp-cliente').value=p.cli||'';
    document.getElementById('pp-cuit').value=p.cuit||'';
  }
}

function agregarSeccion() {
  const nom=prompt('Nombre de la secci√≥n (ej: COCINA, RECEPCI√ìN):'); if(!nom) return;
  pptoItems.push({id:nid(),tipo:'seccion',nombre:nom});
  renderPptoItems();
}

function agregarItem() {
  pptoItems.push({id:nid(),tipo:'item',desc:'',costo:0,flete:'',seguro:0.009,margen:'',cant:1,iva:0.21,iibb:0.035});
  renderPptoItems();
}

function eliminarItemPpto(id) {
  pptoItems=pptoItems.filter(x=>x.id!==id);
  renderPptoItems(); recalcPpto();
}

function renderPptoItems() {
  const body=document.getElementById('ppto-items-body');
  if(!body) return;
  let html='',itemNum=0;
  pptoItems.forEach(item=>{
    if(item.tipo==='seccion'){
      html+=`<tr class="ppto-section-row"><td colspan="13" style="padding:5px 10px;font-size:11px;letter-spacing:.8px">
        ‚ñ∏ ${item.nombre}
        <button onclick="eliminarItemPpto('${item.id}')" style="float:right;color:rgba(255,255,255,.4);font-size:10px"><i class="fa fa-times"></i></button>
      </td></tr>`;
    } else {
      itemNum++;
      if(item.iva===undefined) item.iva=0.21;
      if(item.iibb===undefined) item.iibb=0.035;
      const calc=calcItem(item);
      const margenPct=item.margen!==''&&item.margen!==undefined?(parseFloat(item.margen)*100).toFixed(0):'';
      const fletePct=item.flete!==''&&item.flete!==undefined?(parseFloat(item.flete)*100).toFixed(0):'';
      const margenSub=calc.margenM>0?`<div style="font-size:9px;color:var(--green);margin-top:2px;white-space:nowrap">${pesos(calc.margenM)}</div>`:'';
      const ivaPct=(parseFloat(item.iva)||0.21)*100;
      const iibbPct=(parseFloat(item.iibb)||0.035)*100;
      html+=`<tr id="row-${item.id}">
        <td style="color:var(--ink3);font-size:11px;text-align:center">${itemNum}</td>
        <td><input value="${item.desc||''}" placeholder="Descripci√≥n del producto"
          onblur="updateItem('${item.id}','desc',this.value)" style="min-width:160px"></td>
        <td><input type="number" value="${item.costo||''}" placeholder="0"
          onblur="updateItem('${item.id}','costo',+this.value)"
          style="width:100%;text-align:right"></td>
        <td><input type="number" value="${fletePct}" placeholder="ej: 20"
          onblur="updateItem('${item.id}','flete',this.value===''?'':+this.value/100)"
          style="width:100%;text-align:center" title="Porcentaje de flete (ej: 20 para 20%)"><div style="font-size:9px;color:var(--ink4);text-align:center">%</div></td>
        <td>
          <input type="number" value="${margenPct}" placeholder="ej: 32"
            onblur="updateItem('${item.id}','margen',this.value===''?'':+this.value/100)"
            style="width:100%;text-align:center" title="Margen de ganancia (ej: 32 para 32%)">
          <div style="font-size:9px;text-align:center;margin-top:1px">${margenSub}</div>
        </td>
        <td><input type="number" value="${item.cant||1}" min="1"
          onblur="updateItem('${item.id}','cant',+this.value)"
          style="width:100%;text-align:center"></td>
        <td><div class="calc">${pesos(calc.costoConFlete)}</div></td>
        <td><div class="calc">${pesos(calc.precioNetoUnit)}</div></td>
        <td>
          <div style="display:flex;align-items:center;gap:3px">
            <input type="number" value="${ivaPct.toFixed(1)}" step="0.5" min="0" max="100"
              onblur="updateItem('${item.id}','iva',+this.value/100)"
              style="width:42px;text-align:center;border:1px solid var(--border);border-radius:4px;padding:3px 4px;font-size:11px">
            <span style="font-size:9px;color:var(--ink4)">%</span>
          </div>
          <div class="calc" style="margin-top:3px">${pesos(calc.ivaUnit)}</div>
        </td>
        <td>
          <div style="display:flex;align-items:center;gap:3px">
            <input type="number" value="${iibbPct.toFixed(1)}" step="0.5" min="0" max="100"
              onblur="updateItem('${item.id}','iibb',+this.value/100)"
              style="width:42px;text-align:center;border:1px solid var(--border);border-radius:4px;padding:3px 4px;font-size:11px">
            <span style="font-size:9px;color:var(--ink4)">%</span>
          </div>
          <div class="calc" style="margin-top:3px">${pesos(calc.iibbUnit)}</div>
        </td>
        <td><div class="calc" style="font-weight:700">${pesos(calc.precioFinalUnit)}</div></td>
        <td><div class="calc" style="font-weight:700;color:var(--green)">${pesos(calc.totalLinea)}</div></td>
        <td><button onclick="eliminarItemPpto('${item.id}')" style="color:var(--red);font-size:12px"><i class="fa fa-trash"></i></button></td>
      </tr>`;
    }
  });
  body.innerHTML=html||'<tr><td colspan="13" style="text-align:center;padding:20px;color:var(--ink4)">Agreg√° √≠tems con el bot√≥n "+ √çtem"</td></tr>';
}

function updateItem(id,campo,val) {
  const item=pptoItems.find(x=>x.id===id); if(!item) return;
  item[campo]=val;
  renderPptoItems();
  recalcPpto();
}

function calcItem(item) {
  const costo   = parseFloat(item.costo)  || 0;
  const flete   = item.flete!==''&&item.flete!==undefined ? parseFloat(item.flete)||0 : 0;
  const seguro  = parseFloat(item.seguro) || 0.009;
  const margen  = item.margen!==''&&item.margen!==undefined ? parseFloat(item.margen)||0 : 0;
  const cant    = parseInt(item.cant)     || 1;
  const IVA_VTA = parseFloat(item.iva)   ?? 0.21;   // IVA venta (editable por √≠tem)
  const IIBB    = parseFloat(item.iibb)  ?? 0.035;  // IIBB (editable por √≠tem)
  const IVA_CMP = 0.21;                              // IVA compras siempre 21%

  // Costo base
  const ivaCompra  = costo * IVA_CMP;               // cr√©dito fiscal IVA
  const fleteM     = costo * flete;                  // $ flete
  const seguroM    = costo * seguro;                 // $ seguro (0.9%)
  const ivaFlete   = fleteM * IVA_CMP;              // IVA sobre el flete (facturado)

  // Base sobre la que se aplica el margen = costo + flete + seguro + IVA del flete
  const costoConFlete = costo + fleteM + seguroM + ivaFlete;

  // Precio de venta
  const margenM      = costoConFlete * margen;
  const precioNetoUnit = costoConFlete + margenM;    // precio neto sin IVA ventas ni IIBB
  const ivaUnit      = precioNetoUnit * IVA_VTA;     // IVA ventas (editable)
  const iibbUnit     = precioNetoUnit * IIBB;        // IIBB (editable)
  const precioFinalUnit = precioNetoUnit + ivaUnit + iibbUnit;
  const totalLinea   = precioFinalUnit * cant;

  return {
    ivaCompra, fleteM, seguroM, ivaFlete,
    costoConFlete, margenM, precioNetoUnit,
    ivaUnit, iibbUnit, precioFinalUnit, totalLinea,
    costoTotal:       costo * cant,
    fleteTotal:       fleteM * cant,
    seguroTotal:      seguroM * cant,
    margenTotal:      margenM * cant,
    ivaVentasTotal:   ivaUnit * cant,
    ivaComprasTotal:  ivaCompra * cant,
    iibbTotal:        iibbUnit * cant
  };
}

function recalcPpto() {
  let compra=0,flete=0,seguro=0,margen=0,ivaVentas=0,ivaCompras=0,iibb=0,subtotal=0;
  pptoItems.filter(i=>i.tipo==='item').forEach(item=>{
    const c=calcItem(item);
    compra    += c.costoTotal;
    flete     += c.fleteTotal;
    seguro    += c.seguroTotal;
    margen    += c.margenTotal;
    ivaVentas += c.ivaVentasTotal;
    ivaCompras+= c.ivaComprasTotal;
    iibb      += c.iibbTotal;
    subtotal  += c.precioNetoUnit * (parseInt(item.cant)||1);
  });
  const ivaAPagar  = ivaVentas - ivaCompras;
  const dto        = (parseFloat(v('pp-dto'))||0) / 100;
  const totalBruto = subtotal + ivaVentas + iibb;
  const descuento  = totalBruto * dto;
  const total      = totalBruto - descuento;
  const base       = compra + flete + seguro;
  const ganPct     = base > 0 ? margen / base : 0;
  const roi        = compra > 0 ? margen / compra : 0;

  setText('r-compra',    pesos(compra));
  setText('r-flete',     pesos(flete));
  setText('r-seguro',    pesos(seguro));
  setText('r-margen',    pesos(margen));
  setText('r-iva-compras', pesos(ivaCompras));
  setText('r-subtotal',  pesos(subtotal));
  setText('r-iva-ventas',pesos(ivaVentas));
  setText('r-iibb',      pesos(iibb));
  setText('r-iva-pagar', pesos(ivaAPagar));
  setText('r-dto',       pesos(descuento));
  setText('r-total',     pesos(total));
  setText('r-ganancia-pct', pct(ganPct));
  setText('r-roi',       pct(roi));
  setText('r-iva-arca',  pesos(ivaAPagar));
  // Sub-valores bajo porcentajes en el resumen
  setText('r-ganancia-val', pesos(margen));
  setText('r-roi-val',      pesos(margen));
  setText('r-iva-arca-val', pesos(ivaAPagar));
}

function setText(id,val){ const el=document.getElementById(id); if(el) el.textContent=val; }

function guardarPpto() {
  const proyId=v('pp-proyecto');
  const proy=DB.proyectos.find(x=>x.id===proyId);
  const cliente=v('pp-cliente')||proy?.cli||'Sin cliente';

  // recalcular totales para guardar
  let compra=0,flete=0,seguro=0,margen=0,ivaVentas=0,ivaCompras=0,iibb=0,subtotal=0;
  pptoItems.filter(i=>i.tipo==='item').forEach(item=>{
    const c=calcItem(item);
    compra+=c.costoTotal; flete+=c.fleteTotal;
    seguro+=(parseFloat(item.costo)||0)*(0.009)*(parseInt(item.cant||1));
    margen+=c.margenTotal; ivaVentas+=c.ivaVentasTotal;
    ivaCompras+=c.ivaComprasTotal; iibb+=c.iibbTotal;
    subtotal+=c.precioNetoUnit*(parseInt(item.cant)||1);
  });
  const dto=(parseFloat(v('pp-dto'))||0)/100;
  const totalBruto=subtotal+ivaVentas+iibb;
  const descuento=totalBruto*dto;
  const totalFinal=totalBruto-descuento;
  const gananciaPct=compra>0?margen/(compra+flete+seguro):0;
  const roi=compra>0?margen/compra:0;

  const data={
    proyId, proyNom:proy?.nom||'',
    cliente, cuit:v('pp-cuit'),
    factura:document.getElementById('pp-factura').value,
    status:document.getElementById('pp-status').value,
    fecha:document.getElementById('pp-fecha').value?.split('-').reverse().join('/'),
    fechaISO:document.getElementById('pp-fecha').value,
    dto:v('pp-dto'), notas:v('pp-notas'),
    items:JSON.parse(JSON.stringify(pptoItems)),
    compraTotal:compra, fleteTotal:flete, seguroTotal:seguro,
    margenTotal:margen, ivaVentas, ivaCompras, iibbTotal:iibb,
    subtotal, descuento, totalFinal, gananciaPct, roi
  };

  if(editPptoId){
    const i=DB.presupuestos.findIndex(x=>x.id===editPptoId);
    if(i>=0) DB.presupuestos[i]={...DB.presupuestos[i],...data};
  } else {
    data.id=nid();
    data.numero=document.getElementById('m-ppto-num').textContent;
    data.creadoEn=hoy();
    DB.presupuestos.push(data);
    guardar(); // save counter too
  }
  guardar(); cerrar('m-presupuesto'); go(modulo);
}

function eliminarPpto() {
  if(!confirm('¬øEliminar este presupuesto? Esta acci√≥n no se puede deshacer.')) return;
  DB.presupuestos=DB.presupuestos.filter(x=>x.id!==editPptoId);
  guardar(); cerrar('m-presupuesto'); go(modulo);
}

function aprobarPpto(id) {
  const p=DB.presupuestos.find(x=>x.id===id); if(!p) return;
  p.status='aprobado';
  // Actualizar proyecto vinculado
  const proy=DB.proyectos.find(x=>x.id===p.proyId);
  if(proy){ proy.status='aprobado'; }
  guardar(); go(modulo);
}

// Vista cliente
function verVistaCliente() {
  // calcular desde pptoItems actuales
  const cliente=v('pp-cliente')||'Cliente';
  const cuit=v('pp-cuit')||'';
  const num=document.getElementById('m-ppto-num').textContent;
  const fecha=v('pp-fecha')||hoy();
  const factura=document.getElementById('pp-factura').value;

  let rows='', itemNum=0, totalCliente=0;
  pptoItems.forEach(item=>{
    if(item.tipo==='seccion'){
      rows+=`<tr style="background:#f8f8f8"><td colspan="4" style="padding:8px 12px;font-weight:700;font-size:12px;color:#333;letter-spacing:.5px;text-transform:uppercase">üìÅ ${item.nombre}</td></tr>`;
    } else if(item.desc||item.costo>0){
      itemNum++;
      const c=calcItem(item);
      totalCliente+=c.totalLinea;
      rows+=`<tr>
        <td style="padding:10px 12px;font-size:13px">${itemNum}</td>
        <td style="padding:10px 12px;font-size:13px">${item.desc||'‚Äî'}</td>
        <td style="padding:10px 12px;font-size:13px;text-align:center">${item.cant||1}</td>
        <td style="padding:10px 12px;font-size:13px;text-align:right;font-weight:600">${factura==='A'?pesos(c.precioNetoUnit):pesos(c.precioFinalUnit)}</td>
        <td style="padding:10px 12px;font-size:13px;text-align:right;font-weight:700;color:#1a7a4a">${pesos(c.totalLinea)}</td>
      </tr>`;
    }
  });
  const dto=(parseFloat(v('pp-dto'))||0);
  // Para Factura A: separar neto, IVA y IIBB
  let netoGravado=0, ivaTotal=0, iibbTotal=0;
  pptoItems.filter(i=>i.tipo==='item'&&(i.desc||i.costo>0)).forEach(item=>{
    const c=calcItem(item);
    netoGravado += c.precioNetoUnit * (parseInt(item.cant)||1);
    ivaTotal    += c.ivaUnit        * (parseInt(item.cant)||1);
    iibbTotal   += c.iibbUnit       * (parseInt(item.cant)||1);
  });
  const dtomonto=dto>0?totalCliente*(dto/100):0;
  const totalFinal=totalCliente-dtomonto;

  document.getElementById('vista-cliente-body').innerHTML=`
    <div style="padding:28px 32px;font-family:'DM Sans',sans-serif;max-width:780px;margin:0 auto">

      <!-- Encabezado A4 -->
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px">
        <div style="display:flex;align-items:center;gap:14px">
          <div style="width:44px;height:44px;background:#1c1c1a;border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:'DM Serif Display',serif;font-size:22px;color:#fff;flex-shrink:0">F</div>
          <div>
            <div style="font-family:'DM Serif Display',serif;font-size:22px;font-weight:700;color:#1c1c1a;line-height:1">FORMA</div>
            <div style="font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:#8a8a86;margin-top:2px">Arquitectura & Dise√±o de Interiores</div>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-size:9px;font-weight:700;color:#8a8a86;text-transform:uppercase;letter-spacing:1.5px">Presupuesto</div>
          <div style="font-size:26px;font-weight:800;font-family:monospace;color:#1c1c1a;line-height:1;margin:4px 0">${num}</div>
          <div style="font-size:11px;color:#8a8a86">Factura ${factura}</div>
          <div style="font-size:11px;color:#8a8a86">${fecha}</div>
        </div>
      </div>

      <!-- L√≠nea divisoria -->
      <div style="height:3px;background:linear-gradient(90deg,#1c1c1a 60%,transparent);margin-bottom:20px;border-radius:2px"></div>

      <!-- Cliente + condiciones -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:22px">
        <div style="background:#f4f4f1;padding:12px 16px;border-radius:6px">
          <div style="font-size:9px;color:#8a8a86;text-transform:uppercase;font-weight:700;letter-spacing:1.5px;margin-bottom:6px">Destinatario</div>
          <div style="font-size:15px;font-weight:700;color:#1c1c1a">${cliente}</div>
          ${cuit?`<div style="font-size:11px;color:#666;margin-top:3px">CUIT: ${cuit}</div>`:''}
        </div>
        <div style="background:#f4f4f1;padding:12px 16px;border-radius:6px">
          <div style="font-size:9px;color:#8a8a86;text-transform:uppercase;font-weight:700;letter-spacing:1.5px;margin-bottom:6px">Detalles</div>
          <div style="font-size:11px;color:#4c4c49;line-height:1.6">
            <div><strong>Validez:</strong> 30 d√≠as desde la fecha de emisi√≥n</div>
            <div><strong>Moneda:</strong> Pesos argentinos (ARS)</div>
            <div><strong>Condici√≥n IVA:</strong> Responsable Inscripto</div>
          </div>
        </div>
      </div>
      <table style="width:100%;border-collapse:collapse;margin-bottom:20px">
        <thead>
          <tr style="background:#1c1c1a;color:#fff">
            <th style="padding:10px 12px;text-align:left;font-size:11px;letter-spacing:.8px">#</th>
            <th style="padding:10px 12px;text-align:left;font-size:11px;letter-spacing:.8px">DESCRIPCI√ìN</th>
            <th style="padding:10px 12px;text-align:center;font-size:11px;letter-spacing:.8px">CANT.</th>
            <th style="padding:10px 12px;text-align:right;font-size:11px;letter-spacing:.8px">P. UNITARIO</th>
            <th style="padding:10px 12px;text-align:right;font-size:11px;letter-spacing:.8px">TOTAL</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div style="display:flex;justify-content:flex-end">
        <div style="min-width:300px">
          ${factura==='A' ? `
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e6e6e2;font-size:13px">
            <span style="color:#666">Neto gravado</span><span style="font-weight:600">${pesos(netoGravado)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e6e6e2;font-size:13px">
            <span style="color:#666">IIBB (3.5%)</span><span style="font-weight:600">${pesos(iibbTotal)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:2px solid #1c1c1a;font-size:13px;color:#2952d9;font-weight:700">
            <span>IVA (21%)</span><span>${pesos(ivaTotal)}</span>
          </div>
          ${dto>0?`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e6e6e2;font-size:13px;color:#c0281e">
            <span>Descuento (${dto}%)</span><span>-${pesos(dtomonto)}</span></div>`:''}
          <div style="display:flex;justify-content:space-between;padding:12px 0;font-size:16px;font-weight:800;color:#1c1c1a">
            <span>TOTAL FACTURA A</span><span>${pesos(totalFinal)}</span>
          </div>
          <div style="font-size:10px;color:#8a8a86;margin-top:4px">IVA discriminado ‚Äî Factura A</div>
          ` : `
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e6e6e2;font-size:13px">
            <span style="color:#666">Subtotal</span><span style="font-weight:600">${pesos(totalCliente)}</span>
          </div>
          ${dto>0?`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e6e6e2;font-size:13px;color:#c0281e">
            <span>Descuento (${dto}%)</span><span>-${pesos(dtomonto)}</span></div>`:''}
          <div style="display:flex;justify-content:space-between;padding:12px 0;font-size:16px;font-weight:800;color:#1c1c1a">
            <span>TOTAL FINAL</span><span>${pesos(totalFinal)}</span>
          </div>
          <div style="font-size:10px;color:#8a8a86;margin-top:4px">IVA incluido ¬∑ Factura ${factura}</div>
          `}
        </div>
      </div>
      ${v('pp-notas')?`<div style="margin-top:16px;padding:12px 16px;background:#f4f4f1;border-radius:6px;font-size:11px;color:#4c4c49"><strong>Condiciones comerciales:</strong> ${v('pp-notas')}</div>`:''}

      <!-- Pie de p√°gina A4 -->
      <div style="margin-top:32px;padding-top:16px;border-top:1px solid #e6e6e2;display:flex;justify-content:space-between;align-items:flex-end">
        <div style="font-size:10px;color:#8a8a86;line-height:1.7">
          <div style="font-weight:700;color:#1c1c1a;margin-bottom:4px">FORMA ‚Äî Arquitectura & Dise√±o</div>
          <div>San Salvador de Jujuy, Argentina</div>
          <div style="margin-top:10px;font-style:italic;color:#b0b0aa">Los precios est√°n sujetos a variaci√≥n seg√∫n disponibilidad de stock y tipo de cambio.</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:9px;color:#8a8a86;margin-bottom:28px;text-transform:uppercase;letter-spacing:1px">Firma y aclaraci√≥n</div>
          <div style="border-top:1px solid #1c1c1a;padding-top:6px;font-size:10px;color:#8a8a86;width:160px;text-align:center">FORMA</div>
        </div>
      </div>
    </div>`;
  abrir('m-vista-cliente');
}

function imprimirCliente() { window.print(); }

// ‚ïê‚ïê COBROS ‚ïê‚ïê
function registrarCobro(pptoId) {
  cpPptoId=pptoId;
  document.getElementById('m-cp-title').textContent='Registrar cobro';
  document.getElementById('cp-concepto').value='';
  document.getElementById('cp-monto').value='';
  document.getElementById('cp-fecha').value=fiDate();
  document.getElementById('cp-notas').value='';
  abrir('m-cobropago');
}

function guardarCobro() {
  const monto=parseFloat(v('cp-monto'));
  if(!monto || !v('cp-concepto')){ alert('Complet√° concepto y monto'); return; }
  DB.cobros.push({
    id:nid(), pptoId:cpPptoId, concepto:v('cp-concepto'),
    monto, fecha:v('cp-fecha'),
    medio:document.getElementById('cp-medio').value,
    notas:v('cp-notas'), creadoEn:ahora()
  });
  guardar(); cerrar('m-cobropago'); go(modulo);
}

// ‚ïê‚ïê LEADS CRUD ‚ïê‚ïê
function nuevoLead() {
  editLeadId=null;
  document.getElementById('m-lead-title').textContent='Nuevo Lead';
  ['l-nom','l-ape','l-emp','l-cargo','l-tel','l-email','l-loc','l-prov','l-notas','l-ppto']
    .forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  document.getElementById('l-score').value=50;
  document.getElementById('l-score-val').textContent='50';
  document.getElementById('l-tx-box').style.display='block';
  abrir('m-lead');
}

function editarLead(id) {
  editLeadId=id;
  const l=DB.leads.find(x=>x.id===id); if(!l) return;
  document.getElementById('m-lead-title').textContent=`Editar: ${l.nom} ${l.ape}`;
  ['nom','ape','emp','cargo','tel','email','loc','prov','notas','ppto']
    .forEach(f=>{ const el=document.getElementById('l-'+f); if(el) el.value=l[f]||''; });
  document.getElementById('l-score').value=l.score||50;
  document.getElementById('l-score-val').textContent=l.score||50;
  document.getElementById('l-origen').value=l.origen||'referido';
  document.getElementById('l-cat').value=l.cat||'Oficina';
  document.getElementById('l-tipo').value=l.tipo||'Equipamiento';
  document.getElementById('l-tx-box').style.display='none';
  abrir('m-lead');
}

function guardarLead() {
  const nom=v('l-nom'); if(!nom){alert('El nombre es obligatorio');return;}
  const data={nom,ape:v('l-ape'),emp:v('l-emp'),cargo:v('l-cargo'),tel:v('l-tel'),
    email:v('l-email'),loc:v('l-loc'),prov:v('l-prov'),
    origen:document.getElementById('l-origen').value,
    cat:document.getElementById('l-cat').value,
    tipo:document.getElementById('l-tipo').value,
    score:parseInt(document.getElementById('l-score').value)||50,
    ppto:v('l-ppto'),notas:v('l-notas')};
  if(editLeadId){
    const i=DB.leads.findIndex(x=>x.id===editLeadId);
    if(i>=0) DB.leads[i]={...DB.leads[i],...data};
  } else {
    const lead={...data,id:nid(),status:'Pendiente',area:'ventas',fecha:hoy()};
    DB.leads.push(lead);
    if(document.getElementById('l-transfer').value==='gestion') crearProyectoDeLead(lead);
  }
  guardar(); cerrar('m-lead'); go(modulo);
}

function crearProyectoDeLead(l) {
  const p={id:nid(),nom:`Proyecto: ${l.nom} ${l.ape} ‚Äî ${l.cat}`,
    cli:`${l.nom} ${l.ape}`,emp:l.emp||'',tel:l.tel,email:l.email,
    cat:l.cat,tipo:l.tipo,area:'gestion',status:'relevamiento',
    fecha:'',desc:l.notas,relev:'',creadoEn:hoy()};
  DB.proyectos.push(p);
  DB.transferencias.push({id:nid(),proyId:p.id,de:'ventas',a:'gestion',
    nota:`Lead convertido: ${l.nom} ${l.ape}`,fecha:hoy()});
}

function verLead(id) {
  const l=DB.leads.find(x=>x.id===id); if(!l) return;
  const tl=DB.timeline.filter(t=>t.leadId===id);
  document.getElementById('det-title').textContent=`${l.nom} ${l.ape}`;
  document.getElementById('det-sub').textContent=`${l.emp||''} ¬∑ ${l.cat} ¬∑ ${l.tipo}`;
  document.getElementById('det-edit-btn').onclick=()=>{ cerrar('m-detalle'); editarLead(id); };
  document.getElementById('det-body').innerHTML=`
    <div class="dtabs"><div class="dtab active" onclick="dtab(this,'di')">Informaci√≥n</div>
      <div class="dtab" onclick="dtab(this,'dt')">Timeline (${tl.length})</div></div>
    <div style="padding:18px">
      <div id="di">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
          ${drow('Tel√©fono',l.tel||'‚Äî')}${drow('Email',l.email||'‚Äî')}
          ${drow('Empresa',l.emp||'‚Äî')}${drow('Cargo',l.cargo||'‚Äî')}
          ${drow('Origen',`<span class="badge b-gray">${l.origen}</span>`)}${drow('Score',score(l.score))}
          ${drow('Ppto. est.',l.ppto?pesos(l.ppto):'‚Äî')}${drow('Direcci√≥n',`${l.loc||'‚Äî'}, ${l.prov||''}`)}
        </div>
        ${l.notas?`<div style="padding:10px;background:var(--surface2);border-radius:var(--r);font-size:13px;margin-bottom:14px">${l.notas}</div>`:''}
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <select id="sel-s-${id}" style="font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:var(--r)">
            ${['Pendiente','Contactado','Visita Agendada','En seguimiento','Cerrado'].map(s=>`<option${s===l.status?' selected':''}>${s}</option>`).join('')}
          </select>
          <button class="btn btn-secondary btn-sm" onclick="cambiarStatusLead('${id}')">Actualizar</button>
          <button class="btn btn-accent btn-sm" onclick="leadAGestion('${id}')"><i class="fa fa-arrow-right"></i> Crear Proyecto</button>
        </div>
      </div>
      <div id="dt" style="display:none">
        <button class="btn btn-primary btn-sm" style="margin-bottom:14px" onclick="nuevoTL('${id}')"><i class="fa fa-plus"></i> Registrar actividad</button>
        <div class="tl">${tl.length?tl.map(tlItem).join(''):'<div class="empty"><i class="fa fa-history"></i><p>Sin actividad.</p></div>'}</div>
      </div>
    </div>`;
  abrir('m-detalle');
}

function drow(label,val){ return `<div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--ink3);margin-bottom:3px">${label}</div><div style="font-size:13px">${val}</div></div>`; }
function dtab(el,tabId){ el.parentElement.querySelectorAll('.dtab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); ['di','dt','dp','dh'].forEach(id=>{ const t=document.getElementById(id); if(t) t.style.display=id===tabId?'block':'none'; }); }
function cambiarStatusLead(id){ const l=DB.leads.find(x=>x.id===id),sel=document.getElementById('sel-s-'+id); if(l&&sel){l.status=sel.value;guardar();} }
function leadAGestion(id){ const l=DB.leads.find(x=>x.id===id); if(!l) return; if(!confirm(`¬øCrear proyecto para ${l.nom}?`)) return; crearProyectoDeLead(l); l.status='Visita Agendada'; guardar(); cerrar('m-detalle'); alert('‚úÖ Proyecto creado.'); go(modulo); }

// ‚îÄ‚îÄ TIMELINE ‚îÄ‚îÄ
function nuevoTL(leadId){ tlLeadId=leadId; document.getElementById('tl-nota').value=''; document.getElementById('tl-prox').value=''; document.getElementById('tl-fecha').value=fiDate(); abrir('m-timeline'); }
function guardarTL(){ DB.timeline.push({id:nid(),leadId:tlLeadId,tipo:document.getElementById('tl-tipo').value,nota:v('tl-nota'),fecha:v('tl-fecha'),prox:v('tl-prox'),creadoEn:ahora()}); guardar(); cerrar('m-timeline'); verLead(tlLeadId); }
function tlItem(t){ const icons={llamada:'fa-phone',reunion:'fa-handshake',email:'fa-envelope',whatsapp:'fa-comment',nota:'fa-sticky-note'}; const colors={llamada:'var(--accent)',reunion:'var(--green)',email:'var(--teal)',whatsapp:'#25d366',nota:'var(--amber)'}; return `<div class="tl-item"><div class="tl-dot" style="background:${colors[t.tipo]||'var(--ink3)'}"><i class="fa ${icons[t.tipo]||'fa-circle'}" style="font-size:10px;color:#fff"></i></div><div class="tl-body"><div class="tl-title">${t.tipo.charAt(0).toUpperCase()+t.tipo.slice(1)}</div><div class="tl-meta">${t.fecha}${t.prox?' ¬∑ Pr√≥ximo: '+t.prox:''}</div>${t.nota?`<div class="tl-note">${t.nota}</div>`:''}</div></div>`; }

// ‚ïê‚ïê PROYECTOS CRUD ‚ïê‚ïê
function nuevoProyecto(){ editProjId=null; document.getElementById('m-proy-title').textContent='Nuevo Proyecto'; ['p-nom','p-cli','p-emp','p-cuit','p-tel','p-email','p-desc','p-relev'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; }); document.getElementById('p-fecha').value=''; document.getElementById('p-area').value='gestion'; document.getElementById('p-status').value='relevamiento'; abrir('m-proyecto'); }

function editarProyecto(id){ editProjId=id; const p=DB.proyectos.find(x=>x.id===id); if(!p) return; document.getElementById('m-proy-title').textContent=`Editar: ${p.nom}`; ['nom','cli','emp','cuit','tel','email','desc','relev'].forEach(f=>{ const el=document.getElementById('p-'+f); if(el) el.value=p[f]||''; }); document.getElementById('p-cat').value=p.cat||'Oficina'; document.getElementById('p-tipo').value=p.tipo||'Equipamiento'; document.getElementById('p-status').value=p.status||'relevamiento'; document.getElementById('p-area').value=p.area||'gestion'; document.getElementById('p-fecha').value=p.fecha||''; abrir('m-proyecto'); }

function guardarProyecto(){ const nom=v('p-nom'); if(!nom){alert('Nombre obligatorio');return;} const areaAnt=editProjId?DB.proyectos.find(x=>x.id===editProjId)?.area:null; const areaNueva=document.getElementById('p-area').value; const data={nom,cli:v('p-cli'),emp:v('p-emp'),cuit:v('p-cuit'),tel:v('p-tel'),email:v('p-email'),cat:document.getElementById('p-cat').value,tipo:document.getElementById('p-tipo').value,status:document.getElementById('p-status').value,area:areaNueva,fecha:v('p-fecha'),desc:v('p-desc'),relev:v('p-relev')}; if(editProjId){ const i=DB.proyectos.findIndex(x=>x.id===editProjId); if(i>=0) DB.proyectos[i]={...DB.proyectos[i],...data}; if(areaAnt&&areaAnt!==areaNueva) DB.transferencias.push({id:nid(),proyId:editProjId,de:areaAnt,a:areaNueva,nota:'Transferido',fecha:hoy()}); } else { DB.proyectos.push({...data,id:nid(),creadoEn:hoy()}); } guardar(); cerrar('m-proyecto'); go(modulo); }

function verProyecto(id){ const p=DB.proyectos.find(x=>x.id===id); if(!p) return; const trans=DB.transferencias.filter(t=>t.proyId===id); const sols=DB.solicitudes.filter(s=>s.proyId===id); const ppts=DB.presupuestos.filter(x=>x.proyId===id); document.getElementById('det-title').textContent=p.nom; document.getElementById('det-sub').textContent=`${p.cli} ¬∑ ${p.cat} ¬∑ ${p.tipo}`; document.getElementById('det-edit-btn').onclick=()=>{ cerrar('m-detalle'); editarProyecto(id); }; const stages=['relevamiento','en-proceso','esperando-diseno','en-diseno','diseno-entregado','presupuestando','presupuesto-enviado','aprobado']; const ci=stages.indexOf(p.status); document.getElementById('det-body').innerHTML=`<div style="padding:14px 18px;border-bottom:1px solid var(--border);background:var(--surface2)"><div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">${bStatus(p.status)} ${bArea(p.area)}${p.fecha?` <span class="badge b-amber"><i class="fa fa-calendar"></i> ${p.fecha}</span>`:''}</div><div class="flow">${stages.map((s,i)=>`<div class="f-dot ${i<ci?'done':i===ci?'cur':''}" title="${s}"><i class="fa ${i<ci?'fa-check':'fa-circle'}" style="font-size:8px"></i></div>${i<stages.length-1?`<div class="f-line ${i<ci?'done':''}"></div>`:''}`).join('')}</div></div><div class="dtabs"><div class="dtab active" onclick="dtab(this,'dp')">Datos</div><div class="dtab" onclick="dtab(this,'dh')">Historial (${trans.length})</div><div class="dtab" onclick="dtab(this,'dpp')">Presupuestos (${ppts.length})</div>${sols.length?`<div class="dtab" onclick="dtab(this,'ds')">Dise√±o</div>`:''}</div><div style="padding:18px"><div id="dp"><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">${drow('Cliente',p.cli||'‚Äî')}${drow('Empresa',p.emp||'‚Äî')}${drow('CUIT',p.cuit||'‚Äî')}${drow('Tel.',p.tel||'‚Äî')}</div>${p.desc?`<div style="margin-bottom:10px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--ink3);margin-bottom:4px">Brief</div><div style="padding:10px;background:var(--surface2);border-radius:var(--r);font-size:13px">${p.desc}</div></div>`:''}${p.relev?`<div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--ink3);margin-bottom:4px">Relevamiento</div><div style="padding:10px;background:var(--amber-lt);border-radius:var(--r);font-size:13px;color:var(--amber)">${p.relev}</div></div>`:''}  <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-accent btn-sm" onclick="nuevaSolicitudPara('${id}')"><i class="fa fa-pen-nib"></i> Solicitar Dise√±o</button><button class="btn btn-primary btn-sm" onclick="cerrar('m-detalle');nuevoPptoParaProy('${id}')"><i class="fa fa-file-invoice-dollar"></i> Nuevo Presupuesto</button><button class="btn btn-secondary btn-sm" onclick="cerrar('m-detalle');editarProyecto('${id}')"><i class="fa fa-exchange-alt"></i> Transferir</button></div></div><div id="dh" style="display:none"><div class="tl">${trans.length?trans.map(t=>`<div class="tl-item"><div class="tl-dot" style="background:var(--accent)"><i class="fa fa-exchange-alt" style="font-size:9px;color:#fff"></i></div><div class="tl-body"><div class="tl-title">${t.de} ‚Üí ${t.a}</div><div class="tl-meta">${t.fecha}</div>${t.nota?`<div class="tl-note">${t.nota}</div>`:''}</div></div>`).join(''):'<div class="empty"><i class="fa fa-history"></i><p>Sin transferencias.</p></div>'}</div></div><div id="dpp" style="display:none">${ppts.length?ppts.map(pp=>`<div style="padding:12px;border:1px solid var(--border);border-radius:var(--r);margin-bottom:8px;cursor:pointer" onclick="cerrar('m-detalle');editarPpto('${pp.id}')"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-weight:700">${pp.numero}</span>${bPptoStatus(pp.status)}</div><div style="font-size:12px;color:var(--ink3);margin-top:4px">Total: <strong style="color:var(--green)">${pesos(pp.totalFinal)}</strong> ¬∑ Ganancia: ${pct(pp.gananciaPct)}</div></div>`).join(''):'<div class="empty"><i class="fa fa-file-invoice"></i><p>Sin presupuestos.</p><button class="btn btn-primary btn-sm" onclick="cerrar(\'m-detalle\');nuevoPptoParaProy(\''+id+'\')">Crear presupuesto</button></div>'}  </div>${sols.length?`<div id="ds" style="display:none">${sols.map(s=>`<div style="padding:12px;border:1px solid var(--border);border-radius:var(--r);margin-bottom:8px"><div style="display:flex;justify-content:space-between"><span style="font-weight:600">${s.tipo}</span><span class="badge ${bStatusDis(s.status)}">${s.status}</span></div><div style="font-size:12px;color:var(--ink2);margin-top:4px">${s.brief||''}</div></div>`).join('')}</div>`:''}</div>`; abrir('m-detalle'); }

// ‚ïê‚ïê DISE√ëO CRUD ‚ïê‚ïê
function nuevaSolicitud(){ editDisId=null; archivosTemp=[]; document.getElementById('m-dis-title').textContent='Nueva Solicitud'; document.getElementById('d-brief').value=''; document.getElementById('d-fecha').value=''; document.getElementById('d-status').value='pendiente'; llenarSelectProyectosD(); renderFiles(); abrir('m-diseno'); }
function nuevaSolicitudPara(proyId){ cerrar('m-detalle'); nuevaSolicitud(); setTimeout(()=>{ document.getElementById('d-proy').value=proyId; },80); }
function verSolicitud(id){ const s=DB.solicitudes.find(x=>x.id===id); if(!s) return; editDisId=id; archivosTemp=[...(s.files||[])]; document.getElementById('m-dis-title').textContent='Editar Solicitud'; document.getElementById('d-tipo').value=s.tipo||'render'; document.getElementById('d-brief').value=s.brief||''; document.getElementById('d-fecha').value=s.fecha||''; document.getElementById('d-status').value=s.status||'pendiente'; llenarSelectProyectosD(); setTimeout(()=>{ document.getElementById('d-proy').value=s.proyId; },80); renderFiles(); abrir('m-diseno'); }
function llenarSelectProyectosD(){ const sel=document.getElementById('d-proy'); sel.innerHTML=DB.proyectos.map(p=>`<option value="${p.id}">${p.nom}</option>`).join(''); }
function adjuntarArchivo(){ const f=document.getElementById('d-file-input').files[0]; if(!f) return; if(f.size>5*1024*1024){alert('Supera 5MB');return;} const ext=f.name.split('.').pop().toLowerCase(); if(!['pdf','jpg','jpeg','png','doc','docx','dwg'].includes(ext)){alert('Tipo no permitido');return;} const reader=new FileReader(); reader.onload=e=>{archivosTemp.push({name:f.name,type:ext,size:f.size,data:e.target.result,fecha:hoy()});renderFiles();}; reader.readAsDataURL(f); document.getElementById('d-file-input').value=''; }
function renderFiles(){ document.getElementById('d-files-list').innerHTML=archivosTemp.map((a,i)=>`<div class="chip-file"><i class="fa fa-file" style="color:var(--ink3)"></i>${a.name}<button onclick="archivosTemp.splice(${i},1);renderFiles()" style="color:var(--red);font-size:11px;margin-left:4px"><i class="fa fa-times"></i></button></div>`).join(''); }
function guardarDiseno(){ const proyId=document.getElementById('d-proy').value; if(!proyId){alert('Seleccion√° proyecto');return;} const data={proyId,tipo:document.getElementById('d-tipo').value,brief:v('d-brief'),fecha:v('d-fecha'),status:document.getElementById('d-status').value,files:[...archivosTemp]}; if(editDisId){ const i=DB.solicitudes.findIndex(x=>x.id===editDisId); if(i>=0) DB.solicitudes[i]={...DB.solicitudes[i],...data}; } else { DB.solicitudes.push({...data,id:nid(),creadoEn:hoy()}); } guardar(); cerrar('m-diseno'); go(modulo); }

// ‚ïê‚ïê HELPERS VISUALES ‚ïê‚ïê
function score(s){ const n=parseInt(s)||0; const col=n>=70?'var(--green)':n>=40?'var(--amber)':'var(--red)'; return `<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:700;color:${col}"><span style="width:8px;height:8px;border-radius:50%;background:${col};display:inline-block"></span>${n}</span>`; }
function bArea(a){ const m={ventas:['b-blue','Ventas'],gestion:['b-teal','Gesti√≥n'],diseno:['b-purple','Dise√±o'],admin:['b-amber','Admin']}; const [cls,lbl]=m[a]||['b-gray',a]; return `<span class="badge ${cls}">${lbl}</span>`; }
function bStatus(s){ const m={'relevamiento':['b-amber','Relevamiento'],'en-proceso':['b-blue','En proceso'],'esperando-diseno':['b-gray','Esp. Dise√±o'],'en-diseno':['b-purple','En Dise√±o'],'diseno-entregado':['b-teal','Dise√±o listo'],'presupuestando':['b-amber','Presupuestando'],'presupuesto-enviado':['b-blue','Ppto. enviado'],'aprobado':['b-green','Aprobado'],'cancelado':['b-red','Cancelado']}; const [cls,lbl]=m[s]||['b-gray',s]; return `<span class="badge ${cls}">${lbl}</span>`; }
function bStatusLead(s){ return {'Pendiente':'b-gray','Contactado':'b-blue','Visita Agendada':'b-teal','En seguimiento':'b-amber','Cerrado':'b-green'}[s]||'b-gray'; }
function bStatusDis(s){ return {'pendiente':'b-amber','en-proceso':'b-blue','entregado':'b-teal','con-modificaciones':'b-amber','aprobado':'b-green'}[s]||'b-gray'; }
function bPptoStatus(s){ return {'borrador':['b-gray','Borrador'],'enviado':['b-blue','Enviado'],'aprobado':['b-green','Aprobado'],'rechazado':['b-red','Rechazado']}[s]||['b-gray',s]; }
function bPptoStatus(s){ const m={'borrador':['b-gray','Borrador'],'enviado':['b-blue','Enviado'],'aprobado':['b-green','Aprobado'],'rechazado':['b-red','Rechazado']}; const [cls,lbl]=m[s]||['b-gray',s]; return `<span class="badge ${cls}">${lbl}</span>`; }
function getProy(id){ return DB.proyectos.find(x=>x.id===id); }



function toggleSeccionCont(id) {
  const el  = document.getElementById(id);
  const ico = document.getElementById(id+'-ico');
  if (!el) return;
  const open = el.style.display !== 'none';
  el.style.display  = open ? 'none' : 'block';
  if (ico) ico.style.transform = open ? 'rotate(0deg)' : 'rotate(180deg)';
}

function filtrarContable(q) {
  q = q.toLowerCase().trim();
  const aprobados = DB.presupuestos.filter(p => p.status === 'aprobado');
  const filtrados = q
    ? aprobados.filter(p => (p.cliente+p.numero+(p.proyNom||'')).toLowerCase().includes(q))
    : aprobados;
  const list = document.getElementById('cont-proyectos-list');
  const cnt  = document.getElementById('cont-search-count');
  if (cnt) cnt.textContent = filtrados.length + ' proyecto(s)';
  if (!list) return;
  list.innerHTML = filtrados.length
    ? filtrados.map(p => contPrtoCard(p)).join('')
    : '<div class="empty"><i class="fa fa-search"></i><p>Sin resultados para "' + q + '"</p></div>';
}

function abrirPopupPorCobrar() {
  const aprobados = DB.presupuestos.filter(p=>p.status==='aprobado');
  let totalPend = 0;
  const rows = aprobados.map(p=>{
    const cobrado = DB.cobros.filter(c=>c.pptoId===p.id).reduce((s,c)=>s+(parseFloat(c.monto)||0),0);
    const pendiente = (p.totalFinal||0) - cobrado;
    if(pendiente <= 0) return '';
    totalPend += pendiente;
    const pctCob = p.totalFinal ? Math.min(100,(cobrado/p.totalFinal)*100) : 0;
    return `<tr onclick="cerrar('m-porcobrar');go('contable')" style="cursor:pointer">
      <td><div style="font-weight:700;font-size:12px">${p.numero}</div><div style="font-size:11px;color:var(--ink3)">${p.proyNom||''}</div></td>
      <td style="font-size:13px">${p.cliente}</td>
      <td style="font-weight:600;color:var(--green)">${pesos(p.totalFinal)}</td>
      <td style="font-weight:600;color:var(--green)">${pesos(cobrado)}</td>
      <td style="font-weight:700;color:var(--red)">${pesos(pendiente)}</td>
      <td>
        <div style="display:flex;align-items:center;gap:6px">
          <div style="width:60px;height:6px;background:var(--border);border-radius:3px;overflow:hidden">
            <div style="width:${pctCob.toFixed(0)}%;height:100%;background:${pctCob>=100?'var(--green)':pctCob>50?'var(--accent)':'var(--amber)'}"></div>
          </div>
          <span style="font-size:10px;color:var(--ink3)">${pctCob.toFixed(0)}%</span>
        </div>
      </td>
    </tr>`;
  }).filter(Boolean).join('');

  const body = document.getElementById('popup-porcobrar-body');
  if(!rows) {
    body.innerHTML = '<div class="empty"><i class="fa fa-check-circle" style="color:var(--green)"></i><p style="color:var(--green);font-weight:600">¬°Todo cobrado! No hay saldos pendientes.</p></div>';
  } else {
    body.innerHTML = `
      <div style="padding:16px 0 0">
        <table style="width:100%;border-collapse:collapse">
          <thead><tr style="background:var(--surface2)">
            <th style="padding:8px 14px;font-size:10px;font-weight:700;text-transform:uppercase;color:var(--ink3);text-align:left;border-bottom:1px solid var(--border)">N¬∞ Ppto.</th>
            <th style="padding:8px 14px;font-size:10px;font-weight:700;text-transform:uppercase;color:var(--ink3);text-align:left;border-bottom:1px solid var(--border)">Cliente</th>
            <th style="padding:8px 14px;font-size:10px;font-weight:700;text-transform:uppercase;color:var(--ink3);text-align:left;border-bottom:1px solid var(--border)">Total</th>
            <th style="padding:8px 14px;font-size:10px;font-weight:700;text-transform:uppercase;color:var(--ink3);text-align:left;border-bottom:1px solid var(--border)">Cobrado</th>
            <th style="padding:8px 14px;font-size:10px;font-weight:700;text-transform:uppercase;color:var(--ink3);text-align:left;border-bottom:1px solid var(--border)">Pendiente</th>
            <th style="padding:8px 14px;font-size:10px;font-weight:700;text-transform:uppercase;color:var(--ink3);text-align:left;border-bottom:1px solid var(--border)">Avance</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <div style="padding:14px 14px 0;display:flex;justify-content:flex-end;border-top:2px solid var(--ink);margin-top:8px">
          <div style="font-size:15px;font-weight:800;color:var(--red)">Total pendiente: ${pesos(totalPend)}</div>
        </div>
      </div>`;
  }
  abrir('m-porcobrar');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH ‚Äî Login / Registro / Sesi√≥n
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function switchAuthTab(tab) {
  document.getElementById('auth-login').style.display   = tab==='login'    ? 'block' : 'none';
  document.getElementById('auth-registro').style.display= tab==='registro' ? 'block' : 'none';
  document.getElementById('tab-login').classList.toggle('active',    tab==='login');
  document.getElementById('tab-registro').classList.toggle('active', tab==='registro');
}

function authMsg(elId, msg, tipo) {
  const el = document.getElementById(elId);
  el.textContent = msg;
  el.className = 'auth-msg ' + tipo;
  el.style.display = 'block';
}

function doLogin() {
  const email = (document.getElementById('au-email').value||'').trim().toLowerCase();
  const pass  = (document.getElementById('au-pass').value||'');
  if(!email || !pass){ authMsg('auth-login-msg','Complet√° email y contrase√±a.','err'); return; }
  const usr = DB.usuarios.find(u => u.email.toLowerCase()===email && u.passHash===btoa(pass));
  if(!usr){ authMsg('auth-login-msg','Email o contrase√±a incorrectos.','err'); return; }
  if(usr.status==='pendiente'){ authMsg('auth-login-msg','Tu cuenta est√° pendiente de aprobaci√≥n por el administrador.','err'); return; }
  if(usr.status==='inactivo'){ authMsg('auth-login-msg','Tu cuenta est√° desactivada. Contact√° al administrador.','err'); return; }
  loginExitoso(usr);
}

function loginExitoso(usr) {
  CURRENT_USER = usr;
  sessionStorage.setItem(AUTH_KEY, JSON.stringify({id:usr.id}));
  // Ocultar auth
  document.getElementById('auth-screen').classList.add('hidden');
  // Actualizar sidebar con datos del usuario
  const ini = usr.nombre.split(' ').map(p=>p[0]).join('').slice(0,2).toUpperCase();
  const colores = ['#2952d9','#1a7a4a','#6d3cbf','#0e7490','#b55800'];
  const col = colores[usr.nombre.charCodeAt(0) % colores.length];
  document.getElementById('sb-avatar').textContent = ini;
  document.getElementById('sb-avatar').style.background = col;
  document.getElementById('sb-uname').textContent = usr.nombre;
  document.getElementById('sb-urole').textContent = usr.rol==='admin' ? 'Administrador' : 'Usuario';
  // Mostrar m√≥dulos permitidos
  aplicarPermisosNav(usr);
  // Ir al primer m√≥dulo permitido
  const primer = usr.modulos.find(m=>m!=='usuarios') || 'dashboard';
  go(primer);
}

function doRegistro() {
  const nom   = (document.getElementById('au-rnom').value||'').trim();
  const email = (document.getElementById('au-remail').value||'').trim().toLowerCase();
  const pass  = (document.getElementById('au-rpass').value||'');
  const pass2 = (document.getElementById('au-rpass2').value||'');
  if(!nom||!email||!pass){ authMsg('auth-reg-msg','Complet√° todos los campos.','err'); return; }
  if(pass.length<6){ authMsg('auth-reg-msg','La contrase√±a debe tener al menos 6 caracteres.','err'); return; }
  if(pass!==pass2){ authMsg('auth-reg-msg','Las contrase√±as no coinciden.','err'); return; }
  if(DB.usuarios.find(u=>u.email.toLowerCase()===email)){ authMsg('auth-reg-msg','Ese email ya est√° registrado.','err'); return; }
  const nuevoUsr = {
    id: nid(), nombre: nom, email, passHash: btoa(pass),
    status: 'pendiente', rol: 'usuario', nota: '',
    modulos: ['dashboard'], // solo dashboard por defecto
    creadoEn: hoy()
  };
  DB.usuarios.push(nuevoUsr);
  guardar();
  authMsg('auth-reg-msg','‚úÖ Solicitud enviada. El administrador debe aprobar tu cuenta.','ok');
  setTimeout(()=>switchAuthTab('login'), 2500);
}

function doLogout() {
  if(!confirm('¬øCerrar sesi√≥n?')) return;
  CURRENT_USER = null;
  sessionStorage.removeItem(AUTH_KEY);
  document.getElementById('auth-screen').classList.remove('hidden');
  document.getElementById('au-email').value='';
  document.getElementById('au-pass').value='';
  document.getElementById('auth-login-msg').style.display='none';
}

function aplicarPermisosNav(usr) {
  const mods = usr.modulos || [];
  const isAdmin = usr.rol==='admin' || mods.includes('usuarios');
  // Mostrar/ocultar cada item del nav
  MODULOS_ALL.forEach(m=>{
    const el = document.getElementById('nav-'+m.id);
    if(el) el.style.display = mods.includes(m.id) ? '' : 'none';
  });
  // Secci√≥n admin solo para admin
  const secAdmin = document.getElementById('sb-sec-admin');
  const navUsr   = document.getElementById('nav-usuarios');
  const navAdm   = document.getElementById('nav-administracion');
  const navFin   = document.getElementById('nav-financiero');
  const showAdmin = isAdmin || mods.includes('administracion') || mods.includes('financiero');
  if(secAdmin) secAdmin.style.display = showAdmin ? '' : 'none';
  if(navUsr)   navUsr.style.display   = isAdmin ? '' : 'none';
  if(navAdm)   navAdm.style.display   = (isAdmin||mods.includes('administracion')) ? '' : 'none';
  if(navFin)   navFin.style.display   = (isAdmin||mods.includes('financiero'))     ? '' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  M√ìDULO USUARIOS (solo Admin)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function usuarios() {
  titulo('Gesti√≥n de usuarios');
  if(!CURRENT_USER || !CURRENT_USER.modulos.includes('usuarios')){
    c('<div class="empty"><i class="fa fa-lock"></i><p>Acceso denegado.</p></div>'); return;
  }
  const pendientes = DB.usuarios.filter(u=>u.status==='pendiente');
  const activos    = DB.usuarios.filter(u=>u.status==='activo');
  const inactivos  = DB.usuarios.filter(u=>u.status==='inactivo');

  c(`
    ${pendientes.length ? `
    <div style="background:var(--amber-lt);border:1px solid var(--amber);border-radius:var(--r-lg);padding:14px 18px;margin-bottom:18px">
      <div style="font-size:12px;font-weight:700;color:var(--amber);margin-bottom:10px">
        <i class="fa fa-clock"></i> ${pendientes.length} usuario(s) esperando aprobaci√≥n
      </div>
      ${pendientes.map(u=>usrCard(u)).join('')}
    </div>` : ''}

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ink2)">
        Usuarios activos (${activos.length})
      </div>
    </div>
    ${activos.map(u=>usrCard(u)).join('')}

    ${inactivos.length ? `
    <div style="margin-top:20px">
      <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ink3);margin-bottom:10px">
        Inactivos (${inactivos.length})
      </div>
      ${inactivos.map(u=>usrCard(u)).join('')}
    </div>` : ''}
  `);
}

function usrCard(u) {
  const ini = u.nombre.split(' ').map(p=>p[0]).join('').slice(0,2).toUpperCase();
  const colores = ['#2952d9','#1a7a4a','#6d3cbf','#0e7490','#b55800'];
  const col = colores[u.nombre.charCodeAt(0) % colores.length];
  const statusBadge = {activo:'b-green',pendiente:'b-amber',inactivo:'b-red'}[u.status]||'b-gray';
  const modsBadges = (u.modulos||[]).filter(m=>m!=='usuarios')
    .map(m=>{ const mod=MODULOS_ALL.find(x=>x.id===m); return mod?`<span class="badge b-blue" style="font-size:9px">${mod.label}</span>`:''; }).join(' ');
  return `<div class="usr-card">
    <div class="usr-avatar" style="background:${col}">${ini}</div>
    <div class="usr-info">
      <div class="usr-name">${u.nombre} ${u.id===CURRENT_USER?.id?'<span style="font-size:10px;color:var(--ink3)">(vos)</span>':''}</div>
      <div class="usr-meta">${u.email} ¬∑ <span class="badge ${statusBadge}" style="font-size:9px">${u.status}</span></div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px">${modsBadges}</div>
      ${u.nota?`<div style="font-size:11px;color:var(--ink3);margin-top:4px;font-style:italic">${u.nota}</div>`:''}
    </div>
    <button class="btn btn-secondary btn-sm" onclick="editarUsuario('${u.id}')"><i class="fa fa-edit"></i> Editar</button>
  </div>`;
}

function editarUsuario(id) {
  editUsrId = id;
  const u = DB.usuarios.find(x=>x.id===id); if(!u) return;
  const ini = u.nombre.split(' ').map(p=>p[0]).join('').slice(0,2).toUpperCase();
  const colores = ['#2952d9','#1a7a4a','#6d3cbf','#0e7490','#b55800'];
  const col = colores[u.nombre.charCodeAt(0) % colores.length];
  document.getElementById('m-usr-title').textContent = 'Editar: ' + u.nombre;
  document.getElementById('m-usr-avatar').textContent = ini;
  document.getElementById('m-usr-avatar').style.background = col;
  document.getElementById('m-usr-name').textContent  = u.nombre;
  document.getElementById('m-usr-email').textContent = u.email;
  document.getElementById('m-usr-status').value = u.status;
  document.getElementById('m-usr-nota').value   = u.nota||'';

  // Render m√≥dulos toggleables
  const grid = document.getElementById('m-usr-modulos');
  const usrMods = u.modulos||[];
  grid.innerHTML = MODULOS_ALL.map(m=>`
    <div class="mod-toggle ${usrMods.includes(m.id)?'on':'off'}" id="tog-${m.id}"
      onclick="toggleModulo('${m.id}')">
      <i class="fa ${m.icon}" style="display:block;margin-bottom:4px;font-size:14px"></i>
      ${m.label}
    </div>`).join('');

  // Bot√≥n admin (m√≥dulo usuarios)
  const isAdmin = usrMods.includes('usuarios');
  grid.innerHTML += `<div class="mod-toggle ${isAdmin?'on':'off'}" id="tog-usuarios"
    onclick="toggleModulo('usuarios')">
    <i class="fa fa-users-cog" style="display:block;margin-bottom:4px;font-size:14px"></i>Admin
  </div>`;

  abrir('m-usuario');
}

function toggleModulo(modId) {
  const el = document.getElementById('tog-'+modId);
  if(!el) return;
  el.classList.toggle('on');
  el.classList.toggle('off');
}

function guardarUsuario() {
  const u = DB.usuarios.find(x=>x.id===editUsrId); if(!u) return;
  u.status = document.getElementById('m-usr-status').value;
  u.nota   = document.getElementById('m-usr-nota').value.trim();
  // Recoger m√≥dulos seleccionados
  const todosLosIds = [...MODULOS_ALL.map(m=>m.id), 'usuarios'];
  u.modulos = todosLosIds.filter(id=>{
    const el=document.getElementById('tog-'+id);
    return el && el.classList.contains('on');
  });
  // dashboard siempre incluido si est√° activo
  if(u.status==='activo' && !u.modulos.includes('dashboard')) u.modulos.unshift('dashboard');
  guardar();
  cerrar('m-usuario');
  go('usuarios');
}

function eliminarUsuario() {
  if(editUsrId===CURRENT_USER?.id){ alert('No pod√©s eliminar tu propia cuenta.'); return; }
  if(!confirm('¬øEliminar este usuario permanentemente?')) return;
  DB.usuarios = DB.usuarios.filter(x=>x.id!==editUsrId);
  guardar(); cerrar('m-usuario'); go('usuarios');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  M√ìDULO ADMINISTRACI√ìN ‚Äî Gastos & RRHH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let editGastoId = null, editChequeId = null;
let movImportados = [];

const CAT_ICONS = {
  salario:'üë§',alquiler:'üè¢',servicios:'‚ö°',telefonia:'üì±',materiales:'üì¶',
  proveedor:'üöö',impuestos:'üèõÔ∏è',bancario:'üè¶',marketing:'üì£',otros:'üìå'
};
const CAT_COLORS = {
  salario:'var(--accent)',alquiler:'var(--teal)',servicios:'var(--amber)',
  telefonia:'var(--purple)',materiales:'var(--green)',proveedor:'var(--ink2)',
  impuestos:'var(--red)',bancario:'var(--ink3)',marketing:'var(--green)',otros:'var(--ink4)'
};

function administracion() {
  titulo('Gastos & RRHH');
  actions(`
    <button class="btn btn-secondary" onclick="abrirCheque(null)"><i class="fa fa-money-check"></i> Cheque</button>
    <button class="btn btn-primary" onclick="abrirGasto(null)"><i class="fa fa-plus"></i> Nuevo Gasto</button>
  `);

  const gastos = DB.gastos || [];
  const cheques = DB.cheques || [];
  const totalGastosMes = gastos.filter(g=>{
    const d=new Date(g.fecha); const now=new Date();
    return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();
  }).reduce((s,g)=>s+(parseFloat(g.monto)||0),0);

  const totalFijos = gastos.filter(g=>g.tipo==='fijo').reduce((s,g)=>s+(parseFloat(g.monto)||0),0);
  const chqPend = cheques.filter(c=>c.status==='pendiente'&&c.tipo==='emitido').reduce((s,c)=>s+(parseFloat(c.monto)||0),0);

  // Agrupar por categor√≠a
  const porCat = {};
  gastos.forEach(g=>{ porCat[g.cat]=(porCat[g.cat]||0)+(parseFloat(g.monto)||0); });
  const topCats = Object.entries(porCat).sort((a,b)=>b[1]-a[1]).slice(0,5);

  c(`
  <div class="stats-row">
    <div class="stat-card"><div class="stat-icon" style="background:var(--red-lt);color:var(--red)"><i class="fa fa-receipt"></i></div>
      <div class="stat-label">Gastos este mes</div><div class="stat-value" style="font-size:17px;color:var(--red)">${pesos(totalGastosMes)}</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--amber-lt);color:var(--amber)"><i class="fa fa-sync"></i></div>
      <div class="stat-label">Gastos fijos mensuales</div><div class="stat-value" style="font-size:17px;color:var(--amber)">${pesos(totalFijos)}</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--purple-lt);color:var(--purple)"><i class="fa fa-money-check"></i></div>
      <div class="stat-label">Cheques pendientes</div><div class="stat-value" style="font-size:17px;color:var(--purple)">${pesos(chqPend)}</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--teal-lt);color:var(--teal)"><i class="fa fa-list"></i></div>
      <div class="stat-label">Total registros</div><div class="stat-value">${gastos.length}</div></div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px">
    <!-- Top categor√≠as -->
    <div class="cont-card">
      <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ink2);margin-bottom:12px">Top categor√≠as</div>
      ${topCats.length ? topCats.map(([cat,tot])=>{
        const maxV = topCats[0][1];
        const pct = Math.round((tot/maxV)*100);
        return `<div style="margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px">
            <span>${CAT_ICONS[cat]||'üìå'} ${cat}</span><span style="font-weight:700">${pesos(tot)}</span>
          </div>
          <div style="height:6px;background:var(--border);border-radius:3px">
            <div style="width:${pct}%;height:100%;background:${CAT_COLORS[cat]||'var(--accent)'};border-radius:3px"></div>
          </div>
        </div>`;}).join('') : '<div style="color:var(--ink4);font-size:12px">Sin datos a√∫n</div>'}
    </div>

    <!-- Cheques -->
    <div class="cont-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ink2)">Cheques</div>
        <button class="btn btn-secondary btn-sm" onclick="abrirCheque(null)"><i class="fa fa-plus"></i></button>
      </div>
      ${cheques.length ? cheques.slice(0,6).map(c=>{
        const statusColor={pendiente:'var(--amber)',cobrado:'var(--green)',rechazado:'var(--red)',vencido:'var(--red)'};
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="abrirCheque('${c.id}')">
          <div>
            <div style="font-size:12px;font-weight:600">${c.ben||'‚Äî'} <span style="color:var(--ink3);font-weight:400">#${c.num||'‚Äî'}</span></div>
            <div style="font-size:10px;color:var(--ink3)">${c.tipo==='emitido'?'üì§ Emitido':'üì• Recibido'} ¬∑ Vence: ${c.fvence||'‚Äî'}</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:13px;font-weight:700;color:${c.tipo==='emitido'?'var(--red)':'var(--green)'}">${pesos(c.monto)}</div>
            <div style="font-size:10px;color:${statusColor[c.status]||'var(--ink3)'}">‚óè ${c.status}</div>
          </div>
        </div>`;}).join('') : '<div style="color:var(--ink4);font-size:12px">Sin cheques registrados</div>'}
    </div>
  </div>

  <!-- Listado gastos -->
  <div class="tbl-wrap">
    <div style="padding:12px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
      <div style="font-size:12px;font-weight:700">Todos los gastos</div>
      <div style="display:flex;gap:8px">
        <select onchange="filtrarGastos(this.value)" style="font-size:12px;padding:5px 8px;border:1px solid var(--border);border-radius:var(--r)">
          <option value="">Todas las categor√≠as</option>
          ${Object.keys(CAT_ICONS).map(k=>`<option value="${k}">${CAT_ICONS[k]} ${k}</option>`).join('')}
        </select>
      </div>
    </div>
    <table id="gastos-table"><thead><tr>
      <th>Fecha</th><th>Concepto</th><th>Categor√≠a</th><th>Tipo</th><th>Medio</th><th>Monto</th><th></th>
    </tr></thead><tbody id="gastos-tbody">
    ${renderGastosRows(gastos)}
    </tbody></table>
  </div>`);
}

function renderGastosRows(gastos) {
  if(!gastos.length) return '<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--ink4)">Sin gastos registrados. Agreg√° el primero.</td></tr>';
  return [...gastos].reverse().map(g=>`<tr onclick="abrirGasto('${g.id}')">
    <td style="font-size:11px;color:var(--ink3)">${g.fecha||'‚Äî'}</td>
    <td style="font-weight:600">${g.concepto}</td>
    <td><span class="gasto-tag" style="background:${CAT_COLORS[g.cat]||'var(--ink4)'}22;color:${CAT_COLORS[g.cat]||'var(--ink3)'}">${CAT_ICONS[g.cat]||'üìå'} ${g.cat}</span></td>
    <td><span class="badge ${g.tipo==='fijo'?'b-blue':'b-gray'}">${g.tipo}</span></td>
    <td style="font-size:11px;color:var(--ink3)">${g.medio||'‚Äî'}</td>
    <td style="font-weight:700;color:var(--red)">${pesos(g.monto)}</td>
    <td><button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();abrirGasto('${g.id}')"><i class="fa fa-edit"></i></button></td>
  </tr>`).join('');
}

function filtrarGastos(cat) {
  const gastos = cat ? DB.gastos.filter(g=>g.cat===cat) : DB.gastos;
  document.getElementById('gastos-tbody').innerHTML = renderGastosRows(gastos);
}

function abrirGasto(id) {
  editGastoId = id;
  const g = id ? DB.gastos.find(x=>x.id===id) : null;
  document.getElementById('m-gasto-title').textContent = g ? 'Editar gasto' : 'Nuevo gasto';
  document.getElementById('g-concepto').value = g?.concepto||'';
  document.getElementById('g-cat').value      = g?.cat||'salario';
  document.getElementById('g-tipo').value     = g?.tipo||'fijo';
  document.getElementById('g-monto').value    = g?.monto||'';
  document.getElementById('g-fecha').value    = g?.fecha||fiDate();
  document.getElementById('g-resp').value     = g?.resp||'';
  document.getElementById('g-medio').value    = g?.medio||'transferencia';
  document.getElementById('g-notas').value    = g?.notas||'';
  document.getElementById('g-delete-btn').style.display = g ? 'inline-flex' : 'none';
  abrir('m-gasto');
}

function guardarGasto() {
  const concepto = v('g-concepto');
  if(!concepto){ alert('El concepto es obligatorio'); return; }
  const data = {
    concepto, cat:document.getElementById('g-cat').value,
    tipo:document.getElementById('g-tipo').value,
    monto:parseFloat(v('g-monto'))||0, fecha:v('g-fecha'),
    resp:v('g-resp'), medio:document.getElementById('g-medio').value,
    notas:v('g-notas'), creadoEn:ahora()
  };
  if(editGastoId) {
    const i = DB.gastos.findIndex(x=>x.id===editGastoId);
    if(i>=0) DB.gastos[i]={...DB.gastos[i],...data};
  } else {
    DB.gastos.push({...data, id:nid()});
  }
  guardar(); cerrar('m-gasto'); go(modulo);
}

function eliminarGasto() {
  if(!confirm('¬øEliminar este gasto?')) return;
  DB.gastos = DB.gastos.filter(x=>x.id!==editGastoId);
  guardar(); cerrar('m-gasto'); go(modulo);
}

function abrirCheque(id) {
  editChequeId = id;
  const c = id ? DB.cheques.find(x=>x.id===id) : null;
  document.getElementById('m-chq-title').textContent = c ? 'Editar cheque' : 'Registrar cheque';
  document.getElementById('chq-num').value      = c?.num||'';
  document.getElementById('chq-tipo').value     = c?.tipo||'emitido';
  document.getElementById('chq-ben').value      = c?.ben||'';
  document.getElementById('chq-monto').value    = c?.monto||'';
  document.getElementById('chq-femision').value = c?.femision||fiDate();
  document.getElementById('chq-fvence').value   = c?.fvence||'';
  document.getElementById('chq-status').value   = c?.status||'pendiente';
  document.getElementById('chq-notas').value    = c?.notas||'';
  document.getElementById('chq-delete-btn').style.display = c ? 'inline-flex' : 'none';
  abrir('m-cheque');
}

function guardarCheque() {
  const data = {
    num:v('chq-num'), tipo:document.getElementById('chq-tipo').value,
    ben:v('chq-ben'), monto:parseFloat(v('chq-monto'))||0,
    femision:v('chq-femision'), fvence:v('chq-fvence'),
    status:document.getElementById('chq-status').value,
    notas:v('chq-notas'), creadoEn:ahora()
  };
  if(editChequeId){
    const i=DB.cheques.findIndex(x=>x.id===editChequeId);
    if(i>=0) DB.cheques[i]={...DB.cheques[i],...data};
  } else {
    DB.cheques.push({...data,id:nid()});
  }
  guardar(); cerrar('m-cheque'); go(modulo);
}

function eliminarCheque() {
  if(!confirm('¬øEliminar este cheque?')) return;
  DB.cheques = DB.cheques.filter(x=>x.id!==editChequeId);
  guardar(); cerrar('m-cheque'); go(modulo);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMPORTADOR EXTRACTO BANCO MACRO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function parsearExtracto() {
  const texto = document.getElementById('imp-texto').value;
  if(!texto.trim()){ alert('Peg√° el texto del extracto primero'); return; }

  const lineas = texto.split('\n');
  movImportados = [];

  // Convertir n√∫mero formato AR "1.234.567,89" o "-1.234.567,89" a float
  const toNum = s => {
    if(!s) return 0;
    const clean = s.trim().replace(/\./g,'').replace(',','.');
    return parseFloat(clean) || 0;
  };

  // El extracto Macro tiene columnas fijas:
  // FECHA  DESCRIPCION  REFERENCIA  DEBITOS  CREDITOS  SALDO
  // El truco: DEBITOS y CREDITOS son mutuamente excluyentes en cada l√≠nea.
  // El SALDO siempre es el √öLTIMO n√∫mero (puede ser negativo con "-").
  // Si hay 3 n√∫meros: REF MONTO SALDO ‚Üí monto es deb o cred seg√∫n keywords
  // Si hay 2 n√∫meros sin ref: MONTO SALDO
  // Si hay 1 n√∫mero: solo saldo (l√≠nea de referencia) ‚Üí ignorar

  // Keywords que identifican D√âBITO (egreso)
  const RE_DEB = /(N\/D\s|DB\s|DB\s+TARJETA|DEBITO FISCAL|CHEQUE CANJE|PAGO DE CHEQUE|COMISION|INTER\.ADEL|CARGO SEGURO|N\/D DBCR|DGR SELLOS|REC DE IIBB|MANTENIMIENTO|N\/D COMPENSACION|FISCAL IVA)/i;
  // Keywords que identifican CR√âDITO (ingreso)  
  const RE_CRED = /(^N\/C\s|TRANSF BALANZ|CCERR|N\/C COMPENSACION)/i;
  // L√≠neas a ignorar completamente
  const RE_SKIP = /^(FECHA|SALDO|TOTAL|DETALLE|TIPO CUENTA|CAJA DE|CUENTA CO|CLAVE|TASA|D\. 409|IIBB JUJUY|ESTIMADO|LE HABILIT|Los dep|El present|Usted puede|Banco Macro|-\s*-\s*-)/i;

  lineas.forEach(rawLinea => {
    const linea = rawLinea.trim();
    if(!linea || RE_SKIP.test(linea)) return;

    // Debe comenzar con fecha DD/MM/YY o DD/MM/YYYY
    const fechaMatch = linea.match(/^(\d{2}\/\d{2}\/\d{2,4})\s+(.*)/);
    if(!fechaMatch) return;

    const fechaRaw = fechaMatch[1]; // "04/08/25"
    const resto    = fechaMatch[2];

    // Extraer TODOS los tokens num√©ricos del resto
    // Un token num√©rico es: opcional "-", d√≠gitos con puntos de miles, coma decimal
    const tokensNum = [];
    const reNum = /(-?[\d]+(?:\.[\d]{3})*,[\d]{2})/g;
    let m;
    while((m = reNum.exec(resto)) !== null) tokensNum.push(m[1]);

    if(tokensNum.length === 0) return; // sin n√∫meros ‚Üí ignorar

    // El SALDO es siempre el √∫ltimo token ‚Üí descartarlo
    // Los tokens anteriores son REFERENCIA (si es solo d√≠gitos enteros) y MONTO
    const saldoToken  = tokensNum[tokensNum.length - 1];
    const montoTokens = tokensNum.slice(0, -1); // todo menos el saldo

    if(montoTokens.length === 0) return; // solo hab√≠a saldo ‚Üí ignorar

    // El monto real es el √öLTIMO de los montoTokens
    // (si hay referencia num√©rica antes, no importa)
    const montoToken = montoTokens[montoTokens.length - 1];
    const monto = Math.abs(toNum(montoToken));
    if(monto <= 0) return;

    // Determinar d√©bito o cr√©dito
    let tipo;
    if(RE_CRED.test(resto))       tipo = 'credito';
    else if(RE_DEB.test(resto))   tipo = 'debito';
    else {
      // Fallback: si el saldo aument√≥ respecto a lo anterior ‚Üí cr√©dito
      // Como no tenemos saldo previo f√°cilmente, usamos: TRANSF sin N/D = cr√©dito
      tipo = /TRANSF/.test(resto) ? 'credito' : 'debito';
    }

    // Limpiar descripci√≥n: sacar los n√∫meros y ref del texto
    let desc = resto
      .replace(reNum, '')                    // quitar n√∫meros con decimales
      .replace(/\b\d{4,}\b/g, '')           // quitar referencias num√©ricas largas
      .replace(/SUC\.:\s*\d+/g, '')         // quitar SUC.: XXX
      .replace(/\s{2,}/g, ' ')
      .trim();

    if(!desc) desc = 'Movimiento bancario';

    // Fecha: "04/08/25" ‚Üí "2025-08-04"
    const partesFecha = fechaRaw.split('/');
    const anio = partesFecha[2].length === 2 ? '20'+partesFecha[2] : partesFecha[2];
    const fechaISO = `${anio}-${partesFecha[1]}-${partesFecha[0]}`;

    movImportados.push({
      fecha:        fechaISO,
      fechaDisplay: fechaRaw,
      desc:         desc.slice(0,80),
      debito:       tipo==='debito' ? monto : 0,
      credito:      tipo==='credito' ? monto : 0,
      tipo,
      monto,
      cat:          autoCategoria(desc),
      cuenta:       document.getElementById('imp-cuenta').value,
      ref:          ''
    });
  });

  // Mostrar preview
  const preview = document.getElementById('imp-preview');
  const list = document.getElementById('imp-preview-list');
  const stats = document.getElementById('imp-preview-stats');
  const btn = document.getElementById('imp-confirmar-btn');

  if(!movImportados.length) {
    list.innerHTML = '<div style="padding:14px;color:var(--red);font-size:12px">No se detectaron movimientos. Verific√° el formato del texto.</div>';
    preview.style.display='block'; btn.style.display='none';
    return;
  }

  const totalDeb = movImportados.filter(m=>m.tipo==='debito').reduce((s,m)=>s+m.monto,0);
  const totalCred = movImportados.filter(m=>m.tipo==='credito').reduce((s,m)=>s+m.monto,0);

  list.innerHTML = movImportados.map(m=>`
    <div class="mov-row">
      <div class="mov-dot" style="background:${m.tipo==='credito'?'var(--green)':'var(--red)'}"></div>
      <div style="font-size:10px;color:var(--ink3);width:60px;flex-shrink:0">${m.fechaDisplay}</div>
      <div class="mov-desc">${m.desc}</div>
      <span class="badge b-gray" style="font-size:9px">${m.cat}</span>
      <div class="mov-monto" style="color:${m.tipo==='credito'?'var(--green)':'var(--red)'}">
        ${m.tipo==='credito'?'+':'-'}${pesos(m.monto)}
      </div>
    </div>`).join('');

  stats.innerHTML = `<strong>${movImportados.length} movimientos detectados</strong> ¬∑ 
    Ingresos: <span style="color:var(--green);font-weight:700">${pesos(totalCred)}</span> ¬∑ 
    Egresos: <span style="color:var(--red);font-weight:700">${pesos(totalDeb)}</span>`;

  preview.style.display='block';
  btn.style.display='inline-flex';
}

function autoCategoria(desc) {
  const d = desc.toUpperCase();
  if(/SUELDO|SALARIO|HABERES/.test(d)) return 'salario';
  if(/ALQUILER|ALQ /.test(d)) return 'alquiler';
  if(/LUZ|AGUA|GAS|EDEJU|AyE/.test(d)) return 'servicios';
  if(/TELEFON|CLARO|PERSONAL|MOVISTAR|TELECOM/.test(d)) return 'telefonia';
  if(/IMPUESTO|IIBB|SIRCREB|FISCAL IVA|SELLOS|DGR|AFIP|ARBA/.test(d)) return 'impuestos';
  if(/DBCR|MANTENIMIENTO|COMISION|CARGO SEGURO|INTER\.ADEL/.test(d)) return 'bancario';
  if(/CHEQUE|PAGO DE CHEQUE|CANJE/.test(d)) return 'otros';
  if(/TRANSF|N\/C|N\/D COMPENSACION/.test(d)) return 'otros';
  return 'otros';
}

function confirmarImportacion() {
  if(!movImportados.length) return;
  // Guardar snapshot ANTES de importar
  crearSnapshot('Antes de importar extracto bancario');
  const periodo = v('imp-periodo') || hoy();
  let importados = 0;
  movImportados.forEach(m=>{
    const existe = DB.movBancarios.find(x=>x.fecha===m.fecha&&x.desc===m.desc&&x.monto===m.monto);
    if(!existe){ DB.movBancarios.push({...m, id:nid(), periodo, importadoEn:ahora()}); importados++; }
  });
  guardar();
  cerrar('m-importar-banco');
  movImportados=[];
  alert(`‚úÖ ${importados} movimientos importados.\nSe guard√≥ un punto de restauraci√≥n autom√°tico.`);
  go('financiero');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SISTEMA DE SNAPSHOTS / RESTAURACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SNAP_KEY = 'forma_snapshots';
const MAX_SNAPS = 10;

function crearSnapshot(descripcion) {
  try {
    const snaps = JSON.parse(localStorage.getItem(SNAP_KEY) || '[]');
    snaps.unshift({
      id: nid(),
      descripcion,
      fecha: ahora(),
      data: JSON.stringify(DB)
    });
    // Mantener solo los √∫ltimos MAX_SNAPS
    if(snaps.length > MAX_SNAPS) snaps.splice(MAX_SNAPS);
    localStorage.setItem(SNAP_KEY, JSON.stringify(snaps));
  } catch(e) { console.error('Snapshot error:', e); }
}

function verSnapshots() {
  try {
    const snaps = JSON.parse(localStorage.getItem(SNAP_KEY) || '[]');
    const body = document.getElementById('snap-list');
    if(!snaps.length) {
      body.innerHTML = '<div class="empty"><i class="fa fa-history"></i><p>No hay puntos de restauraci√≥n guardados.</p></div>';
      abrir('m-snapshots');
      return;
    }
    body.innerHTML = snaps.map((s,i) => `
      <div style="display:flex;align-items:center;gap:14px;padding:12px 0;border-bottom:1px solid var(--border)">
        <div style="width:32px;height:32px;background:var(--accent-lt);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--accent);flex-shrink:0">${i+1}</div>
        <div style="flex:1">
          <div style="font-size:13px;font-weight:600">${s.descripcion}</div>
          <div style="font-size:11px;color:var(--ink3);margin-top:2px">${s.fecha}</div>
        </div>
        <button class="btn btn-danger btn-sm" onclick="restaurarSnapshot('${s.id}')">
          <i class="fa fa-undo"></i> Restaurar
        </button>
      </div>`).join('');
  } catch(e) {
    document.getElementById('snap-list').innerHTML = '<div style="color:var(--red);padding:14px">Error al leer snapshots.</div>';
  }
  abrir('m-snapshots');
}

function restaurarSnapshot(id) {
  if(!confirm('‚ö†Ô∏è ¬øRestaurar este punto?\n\nSe perder√°n todos los cambios realizados despu√©s de este punto.')) return;
  try {
    const snaps = JSON.parse(localStorage.getItem(SNAP_KEY) || '[]');
    const snap = snaps.find(s=>s.id===id);
    if(!snap) { alert('Snapshot no encontrado.'); return; }
    // Guardar snapshot del estado actual antes de restaurar
    crearSnapshot('Antes de restaurar (auto)');
    DB = JSON.parse(snap.data);
    guardar();
    cerrar('m-snapshots');
    alert('‚úÖ Datos restaurados correctamente.');
    go('financiero');
  } catch(e) { alert('Error al restaurar: '+e.message); }
}

function borrarTodosMovBancarios() {
  if(!confirm('¬øEliminar TODOS los movimientos bancarios importados?\n\nEsta acci√≥n se puede deshacer desde Restaurar.')) return;
  crearSnapshot('Antes de borrar movimientos bancarios');
  DB.movBancarios = [];
  guardar();
  go('financiero');
  alert('‚úÖ Movimientos eliminados. Snapshot guardado por si necesit√°s recuperarlos.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  M√ìDULO AN√ÅLISIS FINANCIERO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function financiero() {
  titulo('An√°lisis Financiero');
  actions(`
    <button class="btn btn-secondary" onclick="verSnapshots()"><i class="fa fa-history"></i> Restaurar</button>
    <button class="btn btn-primary" onclick="abrirImportarBanco()"><i class="fa fa-file-import"></i> Importar extracto Macro</button>
  `);

  const movs = DB.movBancarios || [];
  const gastos = DB.gastos || [];
  const cheques = DB.cheques || [];
  const cobros = DB.cobros || [];
  const pptoApr = DB.presupuestos.filter(p=>p.status==='aprobado');

  // Saldos consolidados
  const movCA = movs.filter(m=>m.cuenta==='caja-ahorro');
  const movCC = movs.filter(m=>m.cuenta==='cuenta-corriente');
  const calcSaldo = movList => movList.reduce((s,m)=>s+(m.tipo==='credito'?m.monto:-m.monto),0);
  const saldoCA = calcSaldo(movCA);
  const saldoCC = calcSaldo(movCC);
  const saldoTotal = saldoCA + saldoCC;

  // Ingresos vs Egresos por mes (√∫ltimos 6 meses desde movimientos)
  const meses = {};
  movs.forEach(m=>{
    const d=new Date(m.fecha); if(isNaN(d)) return;
    const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    if(!meses[key]) meses[key]={ing:0,egr:0,label:d.toLocaleDateString('es-AR',{month:'short',year:'2-digit'})};
    if(m.tipo==='credito') meses[key].ing+=m.monto;
    else meses[key].egr+=m.monto;
  });
  // Sumar gastos registrados manualmente por mes
  gastos.forEach(g=>{
    const d=new Date(g.fecha); if(isNaN(d)) return;
    const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    if(!meses[key]) meses[key]={ing:0,egr:0,label:d.toLocaleDateString('es-AR',{month:'short',year:'2-digit'})};
    meses[key].egr+=parseFloat(g.monto)||0;
  });
  // Sumar cobros FORMA como ingresos
  cobros.forEach(co=>{
    const d=new Date(co.fecha); if(isNaN(d)) return;
    const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    if(!meses[key]) meses[key]={ing:0,egr:0,label:d.toLocaleDateString('es-AR',{month:'short',year:'2-digit'})};
    meses[key].ing+=parseFloat(co.monto)||0;
  });

  const mesesArr = Object.entries(meses).sort((a,b)=>a[0].localeCompare(b[0])).slice(-6);
  const maxVal = Math.max(...mesesArr.flatMap(([,v])=>[v.ing,v.egr]),1);

  // Top 10 conceptos de gasto del banco
  const porConcepto = {};
  movs.filter(m=>m.tipo==='debito').forEach(m=>{
    const k = m.desc.slice(0,35);
    porConcepto[k]=(porConcepto[k]||0)+m.monto;
  });
  gastos.forEach(g=>{ porConcepto[g.concepto]=(porConcepto[g.concepto]||0)+(parseFloat(g.monto)||0); });
  const top10 = Object.entries(porConcepto).sort((a,b)=>b[1]-a[1]).slice(0,10);

  // Gastos bancarios autom√°ticos
  const KEYWORDS_BANCARIO = ['DBCR','MANTENIMIENTO','COMISION','CARGO SEGURO','INTER.ADEL','FISCAL IVA','DGR SELLOS','REC DE IIBB'];
  const gastosBancarios = movs.filter(m=>m.tipo==='debito'&&KEYWORDS_BANCARIO.some(k=>m.desc.toUpperCase().includes(k)));
  const totalBancario = gastosBancarios.reduce((s,m)=>s+m.monto,0);

  // Flujo de caja proyectado
  const chqPendEgr = cheques.filter(c=>c.status==='pendiente'&&c.tipo==='emitido').reduce((s,c)=>s+(parseFloat(c.monto)||0),0);
  const chqPendIng = cheques.filter(c=>c.status==='pendiente'&&c.tipo==='recibido').reduce((s,c)=>s+(parseFloat(c.monto)||0),0);
  const cobradoTotal = cobros.reduce((s,c)=>s+(parseFloat(c.monto)||0),0);
  const porCobrarFORMA = pptoApr.reduce((s,p)=>s+(p.totalFinal||0),0) - cobradoTotal;
  const proyeccion = saldoTotal - chqPendEgr + chqPendIng + porCobrarFORMA;
  const gastosFijosTotal = gastos.filter(g=>g.tipo==='fijo').reduce((s,g)=>s+(parseFloat(g.monto)||0),0);

  // Ingresos FORMA vs gastos totales
  const ingresosForma = cobros.reduce((s,c)=>s+(parseFloat(c.monto)||0),0);
  const egresosTotal = movs.filter(m=>m.tipo==='debito').reduce((s,m)=>s+m.monto,0)
    + gastos.reduce((s,g)=>s+(parseFloat(g.monto)||0),0);

  c(`
  <!-- Saldos bancarios -->
  <div style="background:var(--ink);border-radius:var(--r-lg);padding:20px 24px;margin-bottom:18px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px">
    <div>
      <div style="font-size:10px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1.5px;font-weight:700">Caja de Ahorro</div>
      <div style="font-size:22px;font-weight:800;color:${saldoCA>=0?'#4ade80':'#f87171'};margin-top:6px">${pesos(saldoCA)}</div>
      <div style="font-size:10px;color:rgba(255,255,255,.3);margin-top:3px">${movCA.length} movimientos importados</div>
    </div>
    <div style="border-left:1px solid rgba(255,255,255,.1);padding-left:20px">
      <div style="font-size:10px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1.5px;font-weight:700">Cuenta Corriente</div>
      <div style="font-size:22px;font-weight:800;color:${saldoCC>=0?'#4ade80':'#f87171'};margin-top:6px">${pesos(saldoCC)}</div>
      <div style="font-size:10px;color:rgba(255,255,255,.3);margin-top:3px">${movCC.length} movimientos importados</div>
    </div>
    <div style="border-left:1px solid rgba(255,255,255,.1);padding-left:20px">
      <div style="font-size:10px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1.5px;font-weight:700">Saldo consolidado</div>
      <div style="font-size:28px;font-weight:900;color:${saldoTotal>=0?'#4ade80':'#f87171'};margin-top:4px">${pesos(saldoTotal)}</div>
      <div style="font-size:10px;color:rgba(255,255,255,.3);margin-top:3px">Ambas cuentas</div>
    </div>
  </div>

  <!-- Gr√°fico Ingresos vs Egresos -->
  <div class="cont-card" style="margin-bottom:14px">
    <div style="font-size:13px;font-weight:700;margin-bottom:16px">üìä Ingresos vs Egresos por mes</div>
    ${mesesArr.length ? `
    <div style="display:flex;align-items:flex-end;gap:0;height:160px;padding:0 8px;border-bottom:2px solid var(--border);border-left:2px solid var(--border);position:relative">
      ${mesesArr.map(([key,val])=>{
        const hIng=Math.round((val.ing/maxVal)*140);
        const hEgr=Math.round((val.egr/maxVal)*140);
        return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:0 3px">
          <div style="display:flex;align-items:flex-end;gap:2px;height:140px">
            <div style="width:14px;height:${hIng}px;background:var(--green);border-radius:3px 3px 0 0" title="Ingreso: ${pesos(val.ing)}"></div>
            <div style="width:14px;height:${hEgr}px;background:var(--red);border-radius:3px 3px 0 0" title="Egreso: ${pesos(val.egr)}"></div>
          </div>
          <div style="font-size:9px;color:var(--ink3);text-align:center;margin-top:4px">${val.label}</div>
        </div>`;}).join('')}
    </div>
    <div style="display:flex;gap:16px;margin-top:10px">
      <div style="display:flex;align-items:center;gap:6px;font-size:11px"><div style="width:12px;height:12px;background:var(--green);border-radius:2px"></div>Ingresos</div>
      <div style="display:flex;align-items:center;gap:6px;font-size:11px"><div style="width:12px;height:12px;background:var(--red);border-radius:2px"></div>Egresos</div>
    </div>` : '<div class="empty"><i class="fa fa-chart-bar"></i><p>Import√° un extracto para ver el gr√°fico</p></div>'}
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">

    <!-- Flujo de caja proyectado -->
    <div class="cont-card">
      <div style="font-size:13px;font-weight:700;margin-bottom:14px">üîÆ Proyecci√≥n de flujo de caja</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;justify-content:space-between;font-size:12px;padding:7px 0;border-bottom:1px solid var(--border)">
          <span style="color:var(--ink3)">Saldo actual consolidado</span><span style="font-weight:700;color:${saldoTotal>=0?'var(--green)':'var(--red)'}">${pesos(saldoTotal)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:12px;padding:7px 0;border-bottom:1px solid var(--border)">
          <span style="color:var(--ink3)">‚àí Cheques emitidos pendientes</span><span style="font-weight:700;color:var(--red)">-${pesos(chqPendEgr)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:12px;padding:7px 0;border-bottom:1px solid var(--border)">
          <span style="color:var(--ink3)">+ Cheques recibidos pendientes</span><span style="font-weight:700;color:var(--green)">+${pesos(chqPendIng)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:12px;padding:7px 0;border-bottom:1px solid var(--border)">
          <span style="color:var(--ink3)">+ Por cobrar FORMA</span><span style="font-weight:700;color:var(--green)">+${pesos(porCobrarFORMA)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:12px;padding:7px 0;border-bottom:1px solid var(--border)">
          <span style="color:var(--ink3)">‚àí Gastos fijos mensuales</span><span style="font-weight:700;color:var(--red)">-${pesos(gastosFijosTotal)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:10px 0;background:${proyeccion>=0?'var(--green-lt)':'var(--red-lt)'};border-radius:var(--r);padding:10px 12px;margin-top:4px">
          <span style="font-weight:700;font-size:13px">Proyecci√≥n neta</span>
          <span style="font-weight:800;font-size:15px;color:${proyeccion>=0?'var(--green)':'var(--red)'}">${pesos(proyeccion)}</span>
        </div>
      </div>
    </div>

    <!-- FORMA vs Gastos -->
    <div class="cont-card">
      <div style="font-size:13px;font-weight:700;margin-bottom:14px">‚öñÔ∏è Ingresos FORMA vs Gastos totales</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <div>
          <div style="display:flex;justify-content:space-between;margin-bottom:4px">
            <span style="font-size:12px;color:var(--ink3)">Ingresos cobrados (FORMA)</span>
            <span style="font-size:13px;font-weight:700;color:var(--green)">${pesos(ingresosForma)}</span>
          </div>
          <div style="height:8px;background:var(--border);border-radius:4px">
            <div style="width:${Math.min(100,(ingresosForma/Math.max(egresosTotal,ingresosForma,1))*100).toFixed(0)}%;height:100%;background:var(--green);border-radius:4px"></div>
          </div>
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;margin-bottom:4px">
            <span style="font-size:12px;color:var(--ink3)">Egresos totales (banco + gastos)</span>
            <span style="font-size:13px;font-weight:700;color:var(--red)">${pesos(egresosTotal)}</span>
          </div>
          <div style="height:8px;background:var(--border);border-radius:4px">
            <div style="width:${Math.min(100,(egresosTotal/Math.max(egresosTotal,ingresosForma,1))*100).toFixed(0)}%;height:100%;background:var(--red);border-radius:4px"></div>
          </div>
        </div>
        <div style="margin-top:8px;padding:12px;background:${ingresosForma>=egresosTotal?'var(--green-lt)':'var(--red-lt)'};border-radius:var(--r)">
          <div style="font-size:10px;color:var(--ink3);text-transform:uppercase;letter-spacing:1px;font-weight:700">Resultado</div>
          <div style="font-size:18px;font-weight:800;color:${ingresosForma>=egresosTotal?'var(--green)':'var(--red)'}">
            ${ingresosForma>=egresosTotal?'‚úÖ Super√°vit':'‚ö†Ô∏è D√©ficit'}: ${pesos(Math.abs(ingresosForma-egresosTotal))}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">

    <!-- Top 10 conceptos -->
    <div class="cont-card">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px">üí∏ Top 10 conceptos de gasto</div>
      ${top10.length ? top10.map(([desc,tot],i)=>`
        <div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--border)">
          <div style="font-size:11px;font-weight:700;color:var(--ink4);width:18px;text-align:right">${i+1}</div>
          <div style="flex:1;font-size:12px;color:var(--ink2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${desc}">${desc}</div>
          <div style="font-size:12px;font-weight:700;color:var(--red);white-space:nowrap">${pesos(tot)}</div>
        </div>`).join('') : '<div style="color:var(--ink4);font-size:12px">Sin gastos registrados a√∫n.</div>'}
    </div>

    <!-- Gastos bancarios autom√°ticos -->
    <div class="cont-card">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px">üè¶ Gastos bancarios autom√°ticos</div>
      <div style="background:var(--red-lt);border-radius:var(--r);padding:10px 14px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:11px;color:var(--red);font-weight:700;text-transform:uppercase">Total cobrado por el banco</span>
        <span style="font-size:16px;font-weight:800;color:var(--red)">${pesos(totalBancario)}</span>
      </div>
      ${gastosBancarios.length ? gastosBancarios.slice(0,8).map(m=>`
        <div class="mov-row" style="padding:6px 0;border-bottom:1px solid var(--border)">
          <div style="font-size:10px;color:var(--ink3);width:55px;flex-shrink:0">${m.fechaDisplay||m.fecha}</div>
          <div class="mov-desc" style="font-size:11px">${m.desc.slice(0,40)}</div>
          <div style="font-size:12px;font-weight:700;color:var(--red);white-space:nowrap">${pesos(m.monto)}</div>
        </div>`).join('') : '<div style="color:var(--ink4);font-size:12px">Import√° un extracto para ver los gastos bancarios.</div>'}
    </div>
  </div>

  <!-- An√°lisis por responsable + evoluci√≥n mensual gastos -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px">

    <!-- Por responsable -->
    <div class="cont-card">
      <div style="font-size:13px;font-weight:700;margin-bottom:14px">üë§ Gastos por responsable</div>
      ${(()=>{
        const porResp = {};
        gastos.forEach(g=>{ const r=g.resp||'Sin asignar'; porResp[r]=(porResp[r]||0)+(parseFloat(g.monto)||0); });
        const arr = Object.entries(porResp).sort((a,b)=>b[1]-a[1]);
        const maxV = arr[0]?.[1]||1;
        const RESP_COLORS = ['var(--accent)','var(--teal)','var(--green)','var(--purple)','var(--amber)'];
        return arr.length ? arr.map(([resp,tot],i)=>`
          <div style="margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px">
              <span style="font-weight:600">${resp}</span>
              <span style="font-weight:700;color:var(--red)">${pesos(tot)}</span>
            </div>
            <div style="height:6px;background:var(--border);border-radius:3px">
              <div style="width:${Math.round((tot/maxV)*100)}%;height:100%;background:${RESP_COLORS[i%5]};border-radius:3px"></div>
            </div>
          </div>`).join('') : '<div style="color:var(--ink4);font-size:12px">Sin datos</div>';
      })()}
    </div>

    <!-- Evoluci√≥n mensual de gastos -->
    <div class="cont-card">
      <div style="font-size:13px;font-weight:700;margin-bottom:14px">üìÖ Evoluci√≥n mensual de gastos</div>
      ${(()=>{
        const porMes = {};
        gastos.forEach(g=>{
          const d=new Date(g.fecha); if(isNaN(d)) return;
          const key=d.toLocaleDateString('es-AR',{month:'short',year:'2-digit'});
          porMes[key]=(porMes[key]||0)+(parseFloat(g.monto)||0);
        });
        const arr = Object.entries(porMes).slice(-8);
        const maxV = Math.max(...arr.map(([,v])=>v),1);
        return arr.length ? `
          <div style="display:flex;align-items:flex-end;gap:4px;height:100px;border-bottom:2px solid var(--border);border-left:2px solid var(--border);padding:0 4px">
            ${arr.map(([mes,tot])=>`
              <div style="flex:1;display:flex;flex-direction:column;align-items:center">
                <div style="width:100%;height:${Math.round((tot/maxV)*90)}px;background:var(--red);border-radius:3px 3px 0 0;min-height:3px" title="${pesos(tot)}"></div>
              </div>`).join('')}
          </div>
          <div style="display:flex;gap:4px;margin-top:6px">
            ${arr.map(([mes])=>`<div style="flex:1;font-size:8px;color:var(--ink3);text-align:center">${mes}</div>`).join('')}
          </div>
          <div style="margin-top:10px;text-align:center;font-size:11px;color:var(--ink3)">
            Total general: <strong style="color:var(--red)">${pesos(gastos.reduce((s,g)=>s+(parseFloat(g.monto)||0),0))}</strong>
          </div>` : '<div style="color:var(--ink4);font-size:12px">Sin datos</div>';
      })()}
    </div>
  </div>

  <!-- Tabla de √∫ltimos gastos -->
  <div class="tbl-wrap" style="margin-top:14px">
    <div style="padding:12px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
      <div style="font-size:12px;font-weight:700">√öltimos 20 gastos registrados</div>
      <button class="btn btn-secondary btn-sm" onclick="go('administracion')">Ver todos <i class="fa fa-arrow-right"></i></button>
    </div>
    <table><thead><tr><th>Fecha</th><th>Concepto</th><th>Categor√≠a</th><th>Responsable</th><th>Medio</th><th>Monto</th></tr></thead>
    <tbody>
      ${[...gastos].reverse().slice(0,20).map(g=>`
        <tr>
          <td style="font-size:11px;color:var(--ink3)">${g.fecha}</td>
          <td style="font-weight:600;font-size:12px">${g.concepto.slice(0,40)}</td>
          <td><span class="gasto-tag" style="background:${CAT_COLORS[g.cat]||'var(--ink4)'}22;color:${CAT_COLORS[g.cat]||'var(--ink3)'}">${CAT_ICONS[g.cat]||'üìå'} ${g.cat}</span></td>
          <td style="font-size:11px;color:var(--ink3)">${g.resp||'‚Äî'}</td>
          <td style="font-size:11px;color:var(--ink3)">${g.medio||'‚Äî'}</td>
          <td style="font-weight:700;color:var(--red)">${pesos(g.monto)}</td>
        </tr>`).join('')}
    </tbody></table>
  </div>
  `);
}

function abrirImportarBanco() {
  document.getElementById('imp-texto').value='';
  document.getElementById('imp-periodo').value='';
  document.getElementById('imp-preview').style.display='none';
  document.getElementById('imp-confirmar-btn').style.display='none';
  movImportados=[];
  abrir('m-importar-banco');
}

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
window.onload=function(){
  cargarDB();
  // Revisar sesi√≥n guardada
  try {
    const sess = JSON.parse(sessionStorage.getItem(AUTH_KEY));
    if(sess && sess.id) {
      const usr = DB.usuarios.find(u=>u.id===sess.id && u.status==='activo');
      if(usr){ loginExitoso(usr); return; }
    }
  } catch(e){}
  // Mostrar pantalla de login
  document.getElementById('auth-screen').classList.remove('hidden');
};
</script>

<!-- Modal editar usuario -->
<div class="overlay" id="m-usuario">
  <div class="modal" style="max-width:560px">
    <div class="modal-hd">
      <div class="modal-title" id="m-usr-title">Gestionar usuario</div>
      <div class="modal-close" onclick="cerrar('m-usuario')"><i class="fa fa-times"></i></div>
    </div>
    <div class="modal-bd">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px;padding:14px;background:var(--surface2);border-radius:var(--r)">
        <div id="m-usr-avatar" class="usr-avatar" style="background:var(--accent);width:44px;height:44px;font-size:16px">U</div>
        <div>
          <div id="m-usr-name" style="font-weight:700;font-size:14px"></div>
          <div id="m-usr-email" style="font-size:12px;color:var(--ink3)"></div>
        </div>
      </div>

      <div class="field" style="margin-bottom:16px">
        <label>Estado del usuario</label>
        <select id="m-usr-status">
          <option value="pendiente">‚è≥ Pendiente de aprobaci√≥n</option>
          <option value="activo">‚úÖ Activo</option>
          <option value="inactivo">üö´ Inactivo</option>
        </select>
      </div>

      <div class="sec-label">M√≥dulos habilitados</div>
      <div class="mod-grid" id="m-usr-modulos"></div>

      <div class="field" style="margin-top:16px">
        <label>Nota interna (opcional)</label>
        <input id="m-usr-nota" placeholder="Ej: Dise√±adora principal, solo ver dise√±o y gesti√≥n">
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-danger btn-sm" onclick="eliminarUsuario()"><i class="fa fa-trash"></i> Eliminar</button>
      <div style="display:flex;gap:10px">
        <button class="btn btn-secondary" onclick="cerrar('m-usuario')">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarUsuario()"><i class="fa fa-save"></i> Guardar</button>
      </div>
    </div>
  </div>
</div>


<!-- Modal Gasto -->
<div class="overlay" id="m-gasto">
  <div class="modal" style="max-width:520px">
    <div class="modal-hd"><div class="modal-title" id="m-gasto-title">Nuevo gasto</div>
      <div class="modal-close" onclick="cerrar('m-gasto')"><i class="fa fa-times"></i></div></div>
    <div class="modal-bd">
      <div class="fg">
        <div class="field fc"><label>Concepto *</label><input id="g-concepto" placeholder="Ej: Alquiler oficina, Sueldo Juan..."></div>
        <div class="field"><label>Categor√≠a</label>
          <select id="g-cat">
            <option value="salario">üë§ Salario / RRHH</option>
            <option value="alquiler">üè¢ Alquiler</option>
            <option value="servicios">‚ö° Servicios (luz, agua, gas)</option>
            <option value="telefonia">üì± Telefon√≠a / Internet</option>
            <option value="materiales">üì¶ Materiales / Insumos</option>
            <option value="proveedor">üöö Proveedor</option>
            <option value="impuestos">üèõÔ∏è Impuestos / Tasas</option>
            <option value="bancario">üè¶ Gastos bancarios</option>
            <option value="marketing">üì£ Marketing / Publicidad</option>
            <option value="otros">üìå Otros</option>
          </select></div>
        <div class="field"><label>Tipo</label>
          <select id="g-tipo">
            <option value="fijo">üîÅ Fijo mensual</option>
            <option value="variable">üìä Variable / Puntual</option>
          </select></div>
        <div class="field"><label>Monto ($) *</label><input type="number" id="g-monto" placeholder="0"></div>
        <div class="field"><label>Fecha</label><input type="date" id="g-fecha"></div>
        <div class="field"><label>Responsable / Proveedor</label><input id="g-resp" placeholder="Nombre"></div>
        <div class="field"><label>Medio de pago</label>
          <select id="g-medio">
            <option value="transferencia">üè¶ Transferencia</option>
            <option value="cheque">üìÑ Cheque</option>
            <option value="efectivo">üíµ Efectivo</option>
            <option value="debito-auto">üîÑ D√©bito autom√°tico</option>
            <option value="tarjeta">üí≥ Tarjeta</option>
          </select></div>
        <div class="field fc"><label>Notas</label><input id="g-notas" placeholder="Observaciones..."></div>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-danger btn-sm" id="g-delete-btn" style="display:none" onclick="eliminarGasto()"><i class="fa fa-trash"></i></button>
      <div style="display:flex;gap:10px">
        <button class="btn btn-secondary" onclick="cerrar('m-gasto')">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarGasto()"><i class="fa fa-save"></i> Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Cheque -->
<div class="overlay" id="m-cheque">
  <div class="modal" style="max-width:500px">
    <div class="modal-hd"><div class="modal-title" id="m-chq-title">Registrar cheque</div>
      <div class="modal-close" onclick="cerrar('m-cheque')"><i class="fa fa-times"></i></div></div>
    <div class="modal-bd">
      <div class="fg">
        <div class="field"><label>N¬∞ Cheque</label><input id="chq-num" placeholder="59721207"></div>
        <div class="field"><label>Tipo</label>
          <select id="chq-tipo"><option value="emitido">üì§ Emitido (pago)</option><option value="recibido">üì• Recibido (cobro)</option></select></div>
        <div class="field"><label>Beneficiario / Librador</label><input id="chq-ben" placeholder="Nombre"></div>
        <div class="field"><label>Monto ($)</label><input type="number" id="chq-monto" placeholder="0"></div>
        <div class="field"><label>Fecha emisi√≥n</label><input type="date" id="chq-femision"></div>
        <div class="field"><label>Fecha cobro / vencimiento</label><input type="date" id="chq-fvence"></div>
        <div class="field fc"><label>Estado</label>
          <select id="chq-status"><option value="pendiente">‚è≥ Pendiente</option><option value="cobrado">‚úÖ Cobrado / Pagado</option><option value="rechazado">‚ùå Rechazado</option><option value="vencido">‚ö†Ô∏è Vencido</option></select></div>
        <div class="field fc"><label>Notas</label><input id="chq-notas" placeholder="Concepto del cheque"></div>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-danger btn-sm" id="chq-delete-btn" style="display:none" onclick="eliminarCheque()"><i class="fa fa-trash"></i></button>
      <div style="display:flex;gap:10px">
        <button class="btn btn-secondary" onclick="cerrar('m-cheque')">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarCheque()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Importar Banco -->
<div class="overlay" id="m-importar-banco">
  <div class="modal modal-lg">
    <div class="modal-hd">
      <div><div class="modal-title">üì• Importar extracto Banco Macro</div>
        <div style="font-size:11px;color:var(--ink3);margin-top:2px">Peg√° el texto copiado del PDF ‚Äî se detectan los movimientos autom√°ticamente</div></div>
      <div class="modal-close" onclick="cerrar('m-importar-banco')"><i class="fa fa-times"></i></div>
    </div>
    <div class="modal-bd">
      <div class="field" style="margin-bottom:14px">
        <label>Cuenta</label>
        <select id="imp-cuenta">
          <option value="caja-ahorro">Caja de Ahorro en Pesos</option>
          <option value="cuenta-corriente">Cuenta Corriente en Pesos</option>
        </select>
      </div>
      <div class="field" style="margin-bottom:14px">
        <label>Per√≠odo</label>
        <input id="imp-periodo" placeholder="Ej: Agosto 2025" style="max-width:220px">
      </div>
      <div class="field" style="margin-bottom:14px">
        <label>Peg√° el texto del extracto aqu√≠ (copi√° desde el PDF)</label>
        <textarea id="imp-texto" rows="10" placeholder="04/08/25 SUPERMERCADOS COMODIN  439131  73.020,76    44.989,00&#10;05/08/25 N/C COMPENSACION ENTRE TUS CUENTAS  0    83.473,93  83.473,93&#10;..."></textarea>
      </div>
      <div id="imp-preview" style="display:none">
        <div class="sec-label">Vista previa ‚Äî movimientos detectados</div>
        <div id="imp-preview-list" style="max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--r)"></div>
        <div id="imp-preview-stats" style="margin-top:10px;font-size:12px;color:var(--ink2)"></div>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-secondary" onclick="parsearExtracto()"><i class="fa fa-search"></i> Detectar movimientos</button>
      <div style="display:flex;gap:10px">
        <button class="btn btn-secondary" onclick="cerrar('m-importar-banco')">Cancelar</button>
        <button class="btn btn-primary" id="imp-confirmar-btn" style="display:none" onclick="confirmarImportacion()"><i class="fa fa-download"></i> Importar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Snapshots -->
<div class="overlay" id="m-snapshots">
  <div class="modal" style="max-width:580px">
    <div class="modal-hd">
      <div>
        <div class="modal-title">üïê Puntos de restauraci√≥n</div>
        <div style="font-size:11px;color:var(--ink3);margin-top:2px">M√°ximo 10 puntos ‚Äî el m√°s reciente primero</div>
      </div>
      <div class="modal-close" onclick="cerrar('m-snapshots')"><i class="fa fa-times"></i></div>
    </div>
    <div class="modal-bd" id="snap-list"></div>
    <div class="modal-ft">
      <button class="btn btn-danger btn-sm" onclick="borrarTodosMovBancarios()"><i class="fa fa-trash"></i> Borrar movimientos bancarios</button>
      <button class="btn btn-secondary" onclick="cerrar('m-snapshots')">Cerrar</button>
    </div>
  </div>
</div>

<!-- Pop-up Por Cobrar -->
<div class="overlay" id="m-porcobrar">
  <div class="modal" style="max-width:620px">
    <div class="modal-hd">
      <div>
        <div class="modal-title">üí∞ Facturaci√≥n pendiente de cobro</div>
        <div style="font-size:11px;color:var(--ink3);margin-top:2px">Presupuestos aprobados con saldo pendiente</div>
      </div>
      <div class="modal-close" onclick="cerrar('m-porcobrar')"><i class="fa fa-times"></i></div>
    </div>
    <div class="modal-bd" id="popup-porcobrar-body"></div>
  </div>
</div>

</body>
</html>
